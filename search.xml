<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Android 仿微信朋友圈全文、收起功能</title>
      <link href="/expand-fold-text/"/>
      <url>/expand-fold-text/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>一般在社交APP中都有类似朋友圈的功能，其中发表的动态内容很长的时候不可能让它全部显示。这里就需要做一个仿微信朋友圈全文、收起功能来解决该问题。在网上看到一个例子–&gt; <a href="http://blog.csdn.net/e042kuuw/article/details/55107537" target="_blank" rel="noopener">http://blog.csdn.net/e042kuuw/article/details/55107537</a> ，写的很不错，但是有个bug，他这个Demo只有在条目固定的时候才正常，当增加、删除条目的时候会出现全文、收起显示混乱的问题。原因是他使用了固定的position作为key来保存当前显示的状态。这篇文章在他的基础上进行优化。</p><h2 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h2><p><img src="1.jpg" alt></p><h2 id="具体代码"><a href="#具体代码" class="headerlink" title="具体代码"></a>具体代码</h2><p>（详细解释在代码注释中都有，这里就省略了）</p><p><strong>MainActivity.java：</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> RecyclerView mRecyclerView<span class="token punctuation">;</span>    List<span class="token operator">&lt;</span>ExpandFoldTextBean<span class="token operator">></span> mList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">initData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ExpandFoldTextAdapter adapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExpandFoldTextAdapter</span><span class="token punctuation">(</span>mList<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mRecyclerView <span class="token operator">=</span> <span class="token punctuation">(</span>RecyclerView<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>recyclerview<span class="token punctuation">)</span><span class="token punctuation">;</span>        mRecyclerView<span class="token punctuation">.</span><span class="token function">setLayoutManager</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LinearLayoutManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> LinearLayoutManager<span class="token punctuation">.</span>VERTICAL<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mRecyclerView<span class="token punctuation">.</span><span class="token function">setAdapter</span><span class="token punctuation">(</span>adapter<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 初始化数据     */</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        String longContent <span class="token operator">=</span> <span class="token string">"-->游泳、快走、慢跑、骑自行车，及一切有氧运动都能锻炼心脏。有氧运动好处多：能锻炼心肺、增强循环系统功能、燃烧脂肪、加大肺活量、降低血压，甚至能预防糖尿病，减少心脏病的发生。美国运动医学院建议，想知道有氧运动强度是否合适，可在运动后测试心率，以达到最高心率的60%—90%为宜。如果想通过有氧运动来减肥，可以选择低度到中度的运动强度，同时延长运动时间，这种方法消耗的热量更多。运动频率每周3—5次，每次20—60分钟。想要锻炼肌肉，可以练举重、做体操以及其他重复伸、屈肌肉的运动。肌肉锻炼可以燃烧热量、增强骨密度、减少受伤，尤其是关节受伤的几率，还能预防骨质疏松。 在做举重运动前，先测一下，如果连续举8次你最多能举多重的东西，就从这个重量开始练习。当你可以连续12次举起这个重量时，试试增加5%的重量。注意每次练习时，要连续举8—12次，这样可以达到肌肉最大耐力的70%—80%，锻炼效果较好。每周2—3次，但要避免连续两天锻炼同一组肌肉群， 以便让肌肉有充分的恢复时间。"</span><span class="token punctuation">;</span>        String shortContent <span class="token operator">=</span> <span class="token string">"-->健身是一种体育项目，如各种徒手健美操、韵律操、形体操以及各种自抗力动作。"</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            ExpandFoldTextBean bean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExpandFoldTextBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                bean<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>i <span class="token operator">+</span> shortContent<span class="token punctuation">)</span><span class="token punctuation">;</span>                bean<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                bean<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>i <span class="token operator">+</span> longContent<span class="token punctuation">)</span><span class="token punctuation">;</span>                bean<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            mList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>ExpandFoldTextAdapter.java：</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * Author     wildma * DATE       2017/8/3 * Des          ${展开折叠文本适配器} */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExpandFoldTextAdapter</span> <span class="token keyword">extends</span> <span class="token class-name">RecyclerView<span class="token punctuation">.</span>Adapter</span><span class="token operator">&lt;</span>ExpandFoldTextAdapter<span class="token punctuation">.</span>MyViewHolder<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Activity mContent<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_LINE_COUNT <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//最大显示行数</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> STATE_UNKNOW <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//未知状态</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> STATE_NOT_OVERFLOW <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//文本行数小于最大可显示行数</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> STATE_COLLAPSED <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//折叠状态</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> STATE_EXPANDED <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//展开状态</span>    <span class="token comment" spellcheck="true">/**     * 注意：保存文本状态集合的key一定要是唯一的，如果用position。     * 如果使用position作为key，则删除、增加条目的时候会出现显示错乱     */</span>    <span class="token keyword">private</span> SparseArray<span class="token operator">&lt;</span>Integer<span class="token operator">></span> mTextStateList<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//保存文本状态集合</span>    List<span class="token operator">&lt;</span>ExpandFoldTextBean<span class="token operator">></span> mList<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">ExpandFoldTextAdapter</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>ExpandFoldTextBean<span class="token operator">></span> list<span class="token punctuation">,</span> Activity context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        mContent <span class="token operator">=</span> context<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>mList <span class="token operator">=</span> list<span class="token punctuation">;</span>        mTextStateList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SparseArray</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> MyViewHolder <span class="token function">onCreateViewHolder</span><span class="token punctuation">(</span>ViewGroup parent<span class="token punctuation">,</span> <span class="token keyword">int</span> viewType<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyViewHolder</span><span class="token punctuation">(</span>mContent<span class="token punctuation">.</span><span class="token function">getLayoutInflater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>item_expand_fold_text<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onBindViewHolder</span><span class="token punctuation">(</span><span class="token keyword">final</span> MyViewHolder holder<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> position<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> state <span class="token operator">=</span> mTextStateList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STATE_UNKNOW<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//第一次初始化，未知状态</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> STATE_UNKNOW<span class="token punctuation">)</span> <span class="token punctuation">{</span>            holder<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">getViewTreeObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addOnPreDrawListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ViewTreeObserver<span class="token punctuation">.</span>OnPreDrawListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token annotation punctuation">@Override</span>                <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onPreDraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">//这个回掉会调用多次，获取完行数后记得注销监听</span>                    holder<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">getViewTreeObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeOnPreDrawListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">//holder.content.getViewTreeObserver().addOnPreDrawListener(null);</span>                    <span class="token comment" spellcheck="true">//如果内容显示的行数大于最大显示行数</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>holder<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">getLineCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> MAX_LINE_COUNT<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        holder<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">setMaxLines</span><span class="token punctuation">(</span>MAX_LINE_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//设置最大显示行数</span>                        holder<span class="token punctuation">.</span>expandOrFold<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>VISIBLE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//显示“全文”</span>                        holder<span class="token punctuation">.</span>expandOrFold<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"全文"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        mTextStateList<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>mList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STATE_COLLAPSED<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//保存状态</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                        holder<span class="token punctuation">.</span>expandOrFold<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>GONE<span class="token punctuation">)</span><span class="token punctuation">;</span>                        mTextStateList<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>mList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STATE_NOT_OVERFLOW<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            holder<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">setMaxLines</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//设置文本的最大行数，为整数的最大数值</span>            holder<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>mList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//如果之前已经初始化过了，则使用保存的状态。</span>            <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">case</span> STATE_NOT_OVERFLOW<span class="token operator">:</span>                    holder<span class="token punctuation">.</span>expandOrFold<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>GONE<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token keyword">case</span> STATE_COLLAPSED<span class="token operator">:</span>                    holder<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">setMaxLines</span><span class="token punctuation">(</span>MAX_LINE_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>                    holder<span class="token punctuation">.</span>expandOrFold<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>VISIBLE<span class="token punctuation">)</span><span class="token punctuation">;</span>                    holder<span class="token punctuation">.</span>expandOrFold<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"全文"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token keyword">case</span> STATE_EXPANDED<span class="token operator">:</span>                    holder<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">setMaxLines</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>                    holder<span class="token punctuation">.</span>expandOrFold<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>VISIBLE<span class="token punctuation">)</span><span class="token punctuation">;</span>                    holder<span class="token punctuation">.</span>expandOrFold<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"收起"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            holder<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>mList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//全文和收起的点击事件</span>        holder<span class="token punctuation">.</span>expandOrFold<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View v<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">int</span> state <span class="token operator">=</span> mTextStateList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STATE_UNKNOW<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> STATE_COLLAPSED<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    holder<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">setMaxLines</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>                    holder<span class="token punctuation">.</span>expandOrFold<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"收起"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    mTextStateList<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>mList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STATE_EXPANDED<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> STATE_EXPANDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    holder<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">setMaxLines</span><span class="token punctuation">(</span>MAX_LINE_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>                    holder<span class="token punctuation">.</span>expandOrFold<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"全文"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    mTextStateList<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>mList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STATE_COLLAPSED<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//删除点击事件</span>        holder<span class="token punctuation">.</span>delete<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View view<span class="token punctuation">)</span> <span class="token punctuation">{</span>                mList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">notifyDataSetChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getItemCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> mList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyViewHolder</span> <span class="token keyword">extends</span> <span class="token class-name">RecyclerView<span class="token punctuation">.</span>ViewHolder</span> <span class="token punctuation">{</span>        <span class="token keyword">public</span> TextView nickname<span class="token punctuation">;</span>        <span class="token keyword">public</span> TextView content<span class="token punctuation">;</span>        <span class="token keyword">public</span> TextView delete<span class="token punctuation">;</span>        <span class="token keyword">public</span> TextView expandOrFold<span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token function">MyViewHolder</span><span class="token punctuation">(</span>View itemView<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">super</span><span class="token punctuation">(</span>itemView<span class="token punctuation">)</span><span class="token punctuation">;</span>            nickname <span class="token operator">=</span> <span class="token punctuation">(</span>TextView<span class="token punctuation">)</span> itemView<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>tv_nickname<span class="token punctuation">)</span><span class="token punctuation">;</span>            content <span class="token operator">=</span> <span class="token punctuation">(</span>TextView<span class="token punctuation">)</span> itemView<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>tv_content<span class="token punctuation">)</span><span class="token punctuation">;</span>            delete <span class="token operator">=</span> <span class="token punctuation">(</span>TextView<span class="token punctuation">)</span> itemView<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>tv_delete<span class="token punctuation">)</span><span class="token punctuation">;</span>            expandOrFold <span class="token operator">=</span> <span class="token punctuation">(</span>TextView<span class="token punctuation">)</span> itemView<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>tv_expand_or_fold<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>ExpandFoldTextBean.java：</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExpandFoldTextBean</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String content<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//内容</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//该条数据的id</span>    <span class="token keyword">public</span> String <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> content<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setContent</span><span class="token punctuation">(</span>String content<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>content <span class="token operator">=</span> content<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>activity_main.xml：</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token operator">?</span><span class="token operator">></span><span class="token operator">&lt;</span>RelativeLayout    android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/activity_main"</span>    xmlns<span class="token operator">:</span>android<span class="token operator">=</span><span class="token string">"http://schemas.android.com/apk/res/android"</span>    android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"match_parent"</span>    android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"match_parent"</span>    android<span class="token operator">:</span>paddingBottom<span class="token operator">=</span><span class="token string">"@dimen/activity_vertical_margin"</span>    android<span class="token operator">:</span>paddingLeft<span class="token operator">=</span><span class="token string">"@dimen/activity_horizontal_margin"</span>    android<span class="token operator">:</span>paddingRight<span class="token operator">=</span><span class="token string">"@dimen/activity_horizontal_margin"</span>    android<span class="token operator">:</span>paddingTop<span class="token operator">=</span><span class="token string">"@dimen/activity_vertical_margin"</span><span class="token operator">></span>    <span class="token operator">&lt;</span>android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>v7<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>RecyclerView        android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/recyclerview"</span>        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"match_parent"</span>        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"match_parent"</span><span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>android<span class="token punctuation">.</span>support<span class="token punctuation">.</span>v7<span class="token punctuation">.</span>widget<span class="token punctuation">.</span>RecyclerView<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>RelativeLayout<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>item_expand_fold_text.xml：</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token operator">?</span><span class="token operator">></span><span class="token operator">&lt;</span>LinearLayout xmlns<span class="token operator">:</span>android<span class="token operator">=</span><span class="token string">"http://schemas.android.com/apk/res/android"</span>              android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"match_parent"</span>              android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"wrap_content"</span>              android<span class="token operator">:</span>orientation<span class="token operator">=</span><span class="token string">"vertical"</span>              android<span class="token operator">:</span>paddingBottom<span class="token operator">=</span><span class="token string">"@dimen/activity_vertical_margin"</span>              android<span class="token operator">:</span>paddingLeft<span class="token operator">=</span><span class="token string">"@dimen/activity_horizontal_margin"</span>              android<span class="token operator">:</span>paddingRight<span class="token operator">=</span><span class="token string">"@dimen/activity_horizontal_margin"</span>              android<span class="token operator">:</span>paddingTop<span class="token operator">=</span><span class="token string">"@dimen/activity_vertical_margin"</span><span class="token operator">></span>    <span class="token operator">&lt;</span>LinearLayout        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"match_parent"</span>        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"wrap_content"</span>        android<span class="token operator">:</span>layout_gravity<span class="token operator">=</span><span class="token string">"center_vertical"</span>        android<span class="token operator">:</span>orientation<span class="token operator">=</span><span class="token string">"horizontal"</span><span class="token operator">></span>        <span class="token operator">&lt;</span>ImageView            android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"40dp"</span>            android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"40dp"</span>            android<span class="token operator">:</span>layout_marginRight<span class="token operator">=</span><span class="token string">"16dp"</span>            android<span class="token operator">:</span>gravity<span class="token operator">=</span><span class="token string">"center"</span>            android<span class="token operator">:</span>scaleType<span class="token operator">=</span><span class="token string">"centerCrop"</span>            android<span class="token operator">:</span>src<span class="token operator">=</span><span class="token string">"@mipmap/ic_launcher"</span><span class="token operator">/</span><span class="token operator">></span>        <span class="token operator">&lt;</span>RelativeLayout            android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"match_parent"</span>            android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"wrap_content"</span><span class="token operator">></span>            <span class="token operator">&lt;</span>TextView                android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/tv_nickname"</span>                android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"wrap_content"</span>                android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"wrap_content"</span>                android<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string">"wildma"</span>                android<span class="token operator">:</span>textColor<span class="token operator">=</span><span class="token string">"@android:color/black"</span>                android<span class="token operator">:</span>textSize<span class="token operator">=</span><span class="token string">"14sp"</span><span class="token operator">/</span><span class="token operator">></span>            <span class="token operator">&lt;</span>TextView                android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/tv_delete"</span>                android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"wrap_content"</span>                android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"wrap_content"</span>                android<span class="token operator">:</span>layout_alignParentRight<span class="token operator">=</span><span class="token string">"true"</span>                android<span class="token operator">:</span>layout_marginLeft<span class="token operator">=</span><span class="token string">"12dp"</span>                android<span class="token operator">:</span>paddingLeft<span class="token operator">=</span><span class="token string">"5dp"</span>                android<span class="token operator">:</span>paddingRight<span class="token operator">=</span><span class="token string">"5dp"</span>                android<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string">"删除"</span>                android<span class="token operator">:</span>textColor<span class="token operator">=</span><span class="token string">"@android:color/holo_red_dark"</span>                android<span class="token operator">:</span>textSize<span class="token operator">=</span><span class="token string">"14sp"</span><span class="token operator">/</span><span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>RelativeLayout<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>LinearLayout<span class="token operator">></span>    <span class="token operator">&lt;</span>LinearLayout        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"match_parent"</span>        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"wrap_content"</span>        android<span class="token operator">:</span>layout_marginLeft<span class="token operator">=</span><span class="token string">"56dp"</span>        android<span class="token operator">:</span>orientation<span class="token operator">=</span><span class="token string">"vertical"</span>        android<span class="token operator">:</span>paddingBottom<span class="token operator">=</span><span class="token string">"8dp"</span><span class="token operator">></span>        <span class="token operator">&lt;</span>TextView            android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/tv_content"</span>            android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"wrap_content"</span>            android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"wrap_content"</span>            android<span class="token operator">:</span>layout_marginBottom<span class="token operator">=</span><span class="token string">"8dp"</span>            android<span class="token operator">:</span>alpha<span class="token operator">=</span><span class="token string">"0.85"</span>            android<span class="token operator">:</span>ellipsize<span class="token operator">=</span><span class="token string">"end"</span>            android<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string">"内容"</span>            android<span class="token operator">:</span>textColor<span class="token operator">=</span><span class="token string">"@android:color/black"</span>            android<span class="token operator">:</span>textSize<span class="token operator">=</span><span class="token string">"14sp"</span><span class="token operator">/</span><span class="token operator">></span>        <span class="token operator">&lt;</span>TextView            android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/tv_expand_or_fold"</span>            android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"wrap_content"</span>            android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"wrap_content"</span>            android<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string">"全文"</span>            android<span class="token operator">:</span>textColor<span class="token operator">=</span><span class="token string">"@color/colorPrimaryDark"</span>            android<span class="token operator">:</span>textSize<span class="token operator">=</span><span class="token string">"14sp"</span><span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>LinearLayout<span class="token operator">></span>    <span class="token operator">&lt;</span>View        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"match_parent"</span>        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"0.5dp"</span>        android<span class="token operator">:</span>background<span class="token operator">=</span><span class="token string">"@android:color/black"</span><span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>LinearLayout<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>源码地址：<a href="https://github.com/wildma/WildmaExpandFoldText" target="_blank" rel="noopener">https://github.com/wildma/WildmaExpandFoldText</a><br>参考：<a href="http://blog.csdn.net/e042kuuw/article/details/55107537" target="_blank" rel="noopener">http://blog.csdn.net/e042kuuw/article/details/55107537</a></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 折叠文本 </tag>
            
            <tag> 全文、收起功能 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android 利用 Glide 获取图片真正的宽高</title>
      <link href="/glide-get-image-height/"/>
      <url>/glide-get-image-height/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>有时候需要获取网络图片的宽高来设置图片显示的大小，很多人会直接利用Glide的加载监听去拿图片的宽高，但是这样拿到的不是图片真正的宽高，而是图片显示在ImageView后的宽高。如下：</p><pre class="line-numbers language-java"><code class="language-java">        <span class="token comment" spellcheck="true">//获取图片显示在ImageView后的宽高</span>        Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>imgUrl<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">asBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//强制Glide返回一个Bitmap对象</span>                <span class="token punctuation">.</span><span class="token function">listener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RequestListener</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Bitmap<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onException</span><span class="token punctuation">(</span>Exception e<span class="token punctuation">,</span> String model<span class="token punctuation">,</span> Target<span class="token operator">&lt;</span>Bitmap<span class="token operator">></span> target<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isFirstResource<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onException "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onResourceReady</span><span class="token punctuation">(</span>Bitmap bitmap<span class="token punctuation">,</span> String model<span class="token punctuation">,</span> Target<span class="token operator">&lt;</span>Bitmap<span class="token operator">></span> target<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isFromMemoryCache<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isFirstResource<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">int</span> width <span class="token operator">=</span> bitmap<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">int</span> height <span class="token operator">=</span> bitmap<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"width2 "</span> <span class="token operator">+</span> width<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//400px</span>                        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"height2 "</span> <span class="token operator">+</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//400px</span>                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>mIv_img<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>想要拿到图片真正的宽高，应该利用Glide的Target。如下：</p><pre class="line-numbers language-java"><code class="language-java">        <span class="token comment" spellcheck="true">//获取图片真正的宽高</span>        Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>imgUrl<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">asBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//强制Glide返回一个Bitmap对象</span>                <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleTarget</span><span class="token operator">&lt;</span>Bitmap<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResourceReady</span><span class="token punctuation">(</span>Bitmap bitmap<span class="token punctuation">,</span> GlideAnimation<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> Bitmap<span class="token operator">></span> glideAnimation<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">int</span> width <span class="token operator">=</span> bitmap<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">int</span> height <span class="token operator">=</span> bitmap<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"width "</span> <span class="token operator">+</span> width<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//200px</span>                        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"height "</span> <span class="token operator">+</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//200px</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><p>MainActivity.java</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> ImageView mIv_img<span class="token punctuation">;</span>    String imgUrl <span class="token operator">=</span> <span class="token string">"https://ss2.bdstatic.com/70cFvnSh_Q1YnxGkpoWK1HF6hhy/it/u=523024675,1399288021&amp;fm=117&amp;gp=0.jpg"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> String TAG <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>        mIv_img <span class="token operator">=</span> <span class="token punctuation">(</span>ImageView<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>iv_img<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//获取图片真正的宽高</span>        Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>imgUrl<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">asBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//强制Glide返回一个Bitmap对象</span>                <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleTarget</span><span class="token operator">&lt;</span>Bitmap<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResourceReady</span><span class="token punctuation">(</span>Bitmap bitmap<span class="token punctuation">,</span> GlideAnimation<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> Bitmap<span class="token operator">></span> glideAnimation<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">int</span> width <span class="token operator">=</span> bitmap<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">int</span> height <span class="token operator">=</span> bitmap<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"width "</span> <span class="token operator">+</span> width<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//200px</span>                        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"height "</span> <span class="token operator">+</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//200px</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//获取图片显示在ImageView后的宽高</span>        Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>imgUrl<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">asBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//强制Glide返回一个Bitmap对象</span>                <span class="token punctuation">.</span><span class="token function">listener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RequestListener</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Bitmap<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onException</span><span class="token punctuation">(</span>Exception e<span class="token punctuation">,</span> String model<span class="token punctuation">,</span> Target<span class="token operator">&lt;</span>Bitmap<span class="token operator">></span> target<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isFirstResource<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onException "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onResourceReady</span><span class="token punctuation">(</span>Bitmap bitmap<span class="token punctuation">,</span> String model<span class="token punctuation">,</span> Target<span class="token operator">&lt;</span>Bitmap<span class="token operator">></span> target<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isFromMemoryCache<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isFirstResource<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">int</span> width <span class="token operator">=</span> bitmap<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">int</span> height <span class="token operator">=</span> bitmap<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"width2 "</span> <span class="token operator">+</span> width<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//400px</span>                        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"height2 "</span> <span class="token operator">+</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//400px</span>                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>mIv_img<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>activity_main.xml</p><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token operator">?</span><span class="token operator">></span><span class="token operator">&lt;</span>RelativeLayout    android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/activity_main"</span>    xmlns<span class="token operator">:</span>android<span class="token operator">=</span><span class="token string">"http://schemas.android.com/apk/res/android"</span>    android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"match_parent"</span>    android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"match_parent"</span><span class="token operator">></span>    <span class="token operator">&lt;</span>ImageView        android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/iv_img"</span>        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"200dp"</span>        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"200dp"</span>        android<span class="token operator">:</span>layout_centerInParent<span class="token operator">=</span><span class="token string">"true"</span>        android<span class="token operator">:</span>scaleType<span class="token operator">=</span><span class="token string">"centerCrop"</span>        android<span class="token operator">:</span>src<span class="token operator">=</span><span class="token string">"@mipmap/ic_launcher"</span><span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>RelativeLayout<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
          <category> 问题记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Glide </tag>
            
            <tag> 图片高度 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android 使用友盟集成 QQ、微信、微博等第三方登录</title>
      <link href="/umeng-login/"/>
      <url>/umeng-login/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近项目需要加入第三方分享和登录功能，之前其他项目的第三方分享和登录一直都使用ShareSDK实现的。为了统一使用友盟的全家桶，所以三方分享和登录也就选择了友盟。这里记录一下完整的集成与使用流程。</p><h2 id="一、申请友盟Appkey"><a href="#一、申请友盟Appkey" class="headerlink" title="一、申请友盟Appkey"></a>一、申请友盟Appkey</h2><p>直接到<a href="http://www.umeng.com/" target="_blank" rel="noopener">友盟官网</a>申请即可。一般都不用自己去申请，跟项目经理要即可。<br>（我这里的Demo为了方便就直接用友盟Demo里面提供的Appkey，但是创建的项目包名也要和友盟一样。真实项目要自己另外申请）</p><h2 id="二、下载SDK"><a href="#二、下载SDK" class="headerlink" title="二、下载SDK"></a>二、下载SDK</h2><p>下载地址：<a href="http://dev.umeng.com/social/android/sdk-download" target="_blank" rel="noopener">http://dev.umeng.com/social/android/sdk-download</a></p><p>下载的时候根据自己需求进行选择，我这里选择选择的是精简版（包含常用的分享与登录功能），只测试微信，QQ，新浪微博。<br><img src="1.jpg" alt></p><p>下载后解压出来是这样的：<br><img src="2.jpg" alt></p><h2 id="三、准备资源"><a href="#三、准备资源" class="headerlink" title="三、准备资源"></a>三、准备资源</h2><p>使用友盟的集成工具快速集成友盟的分享SDK：双击 友盟集成工具.jar–&gt;选择使用的平台和IDE，如图：<br><img src="3.jpg" alt></p><p>点击OK键，会在当前目录生成名为umeng_integratetool_result的文件夹，如图：<br><img src="4.jpg" alt></p><h2 id="四、开始集成"><a href="#四、开始集成" class="headerlink" title="四、开始集成"></a>四、开始集成</h2><p>（1）将上面的文件夹依次粘贴到工程相应的文件夹即可，如图：<br><img src="5.jpg" alt></p><p>（2）将debug.keystore文件拷贝到项目的app目录下（对应app build中相应的位置），目的是为了使用友盟的签名，如图：<br><img src="6.jpg" alt></p><p>（3）添加回调Activity<br>微信回调：<br>其实在第一步拷贝的时候已经添加了。即在包名目录下创建wxapi文件夹，新建一个名为WXEntryActivity的activity继承WXCallbackActivity</p><p>QQ与新浪微博的回调：<br>QQ与新浪不需要添加Activity，但需要在使用QQ分享或者授权的Activity中添加如下代码：<br>（注意onActivityResult不可在fragment中实现，如果在fragment中调用登录或分享，需要在fragment依赖的Activity中实现）</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onActivityResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> Intent data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onActivityResult</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>        UMShareAPI<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onActivityResult</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（4）配置清单文件Android Manifest<br>添加权限：</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.ACCESS_NETWORK_STATE"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.ACCESS_WIFI_STATE"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.READ_PHONE_STATE"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.WRITE_EXTERNAL_STORAGE"</span><span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.READ_EXTERNAL_STORAGE"</span><span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.INTERNET"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.ACCESS_FINE_LOCATION"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.ACCESS_COARSE_LOCATION"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.ACCESS_LOCATION_EXTRA_COMMANDS"</span> <span class="token operator">/</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>添加sdk中需要的Activity：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>微信<span class="token operator">--</span><span class="token operator">></span>        <span class="token operator">&lt;</span>activity            android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">".wxapi.WXEntryActivity"</span>            android<span class="token operator">:</span>configChanges<span class="token operator">=</span><span class="token string">"keyboardHidden|orientation|screenSize"</span>            android<span class="token operator">:</span>exported<span class="token operator">=</span><span class="token string">"true"</span>            android<span class="token operator">:</span>screenOrientation<span class="token operator">=</span><span class="token string">"portrait"</span>            android<span class="token operator">:</span>theme<span class="token operator">=</span><span class="token string">"@android:style/Theme.Translucent.NoTitleBar"</span><span class="token operator">/</span><span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>新浪微博<span class="token operator">--</span><span class="token operator">></span>        <span class="token operator">&lt;</span>activity            android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">".WBShareActivity"</span>            android<span class="token operator">:</span>configChanges<span class="token operator">=</span><span class="token string">"keyboardHidden|orientation"</span>            android<span class="token operator">:</span>screenOrientation<span class="token operator">=</span><span class="token string">"portrait"</span><span class="token operator">></span>            <span class="token operator">&lt;</span>intent<span class="token operator">-</span>filter<span class="token operator">></span>                <span class="token operator">&lt;</span>action android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"com.sina.weibo.sdk.action.ACTION_SDK_REQ_ACTIVITY"</span><span class="token operator">/</span><span class="token operator">></span>                <span class="token operator">&lt;</span>category android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.category.DEFAULT"</span><span class="token operator">/</span><span class="token operator">></span>            <span class="token operator">&lt;</span><span class="token operator">/</span>intent<span class="token operator">-</span>filter<span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>activity<span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>qq精简版<span class="token operator">--</span><span class="token operator">></span>        <span class="token operator">&lt;</span>activity            android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"com.umeng.qq.tencent.AuthActivity"</span>            android<span class="token operator">:</span>launchMode<span class="token operator">=</span><span class="token string">"singleTask"</span>            android<span class="token operator">:</span>noHistory<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">></span>            <span class="token operator">&lt;</span>intent<span class="token operator">-</span>filter<span class="token operator">></span>                <span class="token operator">&lt;</span>action android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.action.VIEW"</span><span class="token operator">/</span><span class="token operator">></span>                <span class="token operator">&lt;</span>category android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.category.DEFAULT"</span><span class="token operator">/</span><span class="token operator">></span>                <span class="token operator">&lt;</span>category android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.category.BROWSABLE"</span><span class="token operator">/</span><span class="token operator">></span>                <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>这里的scheme是qq分享要用的，<span class="token number">100424468</span>为自己申请的appid，真实项目中需要替换<span class="token operator">--</span><span class="token operator">></span>                <span class="token operator">&lt;</span>data android<span class="token operator">:</span>scheme<span class="token operator">=</span><span class="token string">"tencent100424468"</span><span class="token operator">/</span><span class="token operator">></span>            <span class="token operator">&lt;</span><span class="token operator">/</span>intent<span class="token operator">-</span>filter<span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>activity<span class="token operator">></span>        <span class="token operator">&lt;</span>activity            android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"com.umeng.qq.tencent.AssistActivity"</span>            android<span class="token operator">:</span>configChanges<span class="token operator">=</span><span class="token string">"orientation|keyboardHidden|screenSize"</span>            android<span class="token operator">:</span>screenOrientation<span class="token operator">=</span><span class="token string">"portrait"</span>            android<span class="token operator">:</span>theme<span class="token operator">=</span><span class="token string">"@android:style/Theme.Translucent.NoTitleBar"</span><span class="token operator">/</span><span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>分享编辑页<span class="token operator">--</span><span class="token operator">></span>        <span class="token operator">&lt;</span>activity            android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"com.umeng.socialize.editorpage.ShareActivity"</span>            android<span class="token operator">:</span>excludeFromRecents<span class="token operator">=</span><span class="token string">"true"</span>            android<span class="token operator">:</span>theme<span class="token operator">=</span><span class="token string">"@style/Theme.UMDefault"</span>            <span class="token operator">/</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>添加友盟appkey：</p><pre class="line-numbers language-java"><code class="language-java">        <span class="token operator">&lt;</span>meta<span class="token operator">-</span>data            android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"UMENG_APPKEY"</span>            android<span class="token operator">:</span>value<span class="token operator">=</span><span class="token string">"561cae6ae0f55abd990035bf"</span><span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>meta<span class="token operator">-</span>data<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>（5）配置三方appkey<br>新建MyApplication继承Application（注意：需要在清单文件中配置该MyApplication），在MyApplication文件中配置三方平台的appkey和初始化sdk。如下:</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyApplication</span> <span class="token keyword">extends</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        UMShareAPI<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//初始化sdk</span>        <span class="token comment" spellcheck="true">//开启debug模式，方便定位错误，具体错误检查方式可以查看http://dev.umeng.com/social/android/quick-integration的报错必看，正式发布，请关闭该模式</span>        Config<span class="token punctuation">.</span>DEBUG <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//各个平台的配置</span>    <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//微信</span>        PlatformConfig<span class="token punctuation">.</span><span class="token function">setWeixin</span><span class="token punctuation">(</span><span class="token string">"wxdc1e388c3822c80b"</span><span class="token punctuation">,</span> <span class="token string">"3baf1193c85774b3fd9d18447d76cab0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//新浪微博(第三个参数为回调地址)</span>        PlatformConfig<span class="token punctuation">.</span><span class="token function">setSinaWeibo</span><span class="token punctuation">(</span><span class="token string">"3921700954"</span><span class="token punctuation">,</span> <span class="token string">"04b48b094faeb16683c32669824ebdad"</span><span class="token punctuation">,</span><span class="token string">"http://sns.whalecloud.com/sina2/callback"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//QQ</span>        PlatformConfig<span class="token punctuation">.</span><span class="token function">setQQZone</span><span class="token punctuation">(</span><span class="token string">"100424468"</span><span class="token punctuation">,</span> <span class="token string">"c7394704798a158208a74ab60104f0ba"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（6）登录代码MainActivity.java：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String TAG <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">qqLogin</span><span class="token punctuation">(</span>View view<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">authorization</span><span class="token punctuation">(</span>SHARE_MEDIA<span class="token punctuation">.</span>QQ<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">weiXinLogin</span><span class="token punctuation">(</span>View view<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">authorization</span><span class="token punctuation">(</span>SHARE_MEDIA<span class="token punctuation">.</span>WEIXIN<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sinaLogin</span><span class="token punctuation">(</span>View view<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">authorization</span><span class="token punctuation">(</span>SHARE_MEDIA<span class="token punctuation">.</span>SINA<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//授权</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">authorization</span><span class="token punctuation">(</span>SHARE_MEDIA share_media<span class="token punctuation">)</span> <span class="token punctuation">{</span>        UMShareAPI<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPlatformInfo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> share_media<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UMAuthListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span>SHARE_MEDIA share_media<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onStart "</span> <span class="token operator">+</span> <span class="token string">"授权开始"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>SHARE_MEDIA share_media<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onComplete "</span> <span class="token operator">+</span> <span class="token string">"授权完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//sdk是6.4.4的,但是获取值的时候用的是6.2以前的(access_token)才能获取到值,未知原因</span>                String uid <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                String openid <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"openid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//微博没有</span>                String unionid <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"unionid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//微博没有</span>                String access_token <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"access_token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                String refresh_token <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"refresh_token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//微信,qq,微博都没有获取到</span>                String expires_in <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"expires_in"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                String name <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                String gender <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"gender"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                String iconurl <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"iconurl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"name="</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">",gender="</span> <span class="token operator">+</span> gender<span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//拿到信息去请求登录接口。。。</span>            <span class="token punctuation">}</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span>SHARE_MEDIA share_media<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> Throwable throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onError "</span> <span class="token operator">+</span> <span class="token string">"授权失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCancel</span><span class="token punctuation">(</span>SHARE_MEDIA share_media<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onCancel "</span> <span class="token operator">+</span> <span class="token string">"授权取消"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onActivityResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> Intent data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onActivityResult</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>        UMShareAPI<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onActivityResult</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>效果如下：<br><img src="7.jpg" alt></p><p>Demo下载地址：<a href="https://github.com/wildma/UMengThirdPartyShareLogin" target="_blank" rel="noopener">https://github.com/wildma/UMengThirdPartyShareLogin</a></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
          <category> 第三方集成 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 第三方登录 </tag>
            
            <tag> 友盟登录 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android 使用友盟集成 QQ、微信、微博等第三方分享</title>
      <link href="/umeng-share/"/>
      <url>/umeng-share/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近项目需要加入第三方分享和登录功能，之前其他项目的第三方分享和登录一直都使用ShareSDK实现的。为了统一使用友盟的全家桶，所以三方分享和登录也就选择了友盟。这里记录一下完整的集成与使用流程。</p><h2 id="一、申请友盟Appkey"><a href="#一、申请友盟Appkey" class="headerlink" title="一、申请友盟Appkey"></a>一、申请友盟Appkey</h2><p>直接到<a href="http://www.umeng.com/" target="_blank" rel="noopener">友盟官网</a>申请即可。一般都不用自己去申请，跟项目经理要即可。<br>（我这里的Demo为了方便就直接用友盟Demo里面提供的Appkey，但是创建的项目包名也要和友盟一样。真实项目要自己另外申请）</p><h2 id="二、下载SDK"><a href="#二、下载SDK" class="headerlink" title="二、下载SDK"></a>二、下载SDK</h2><p>下载地址：<a href="http://dev.umeng.com/social/android/sdk-download" target="_blank" rel="noopener">http://dev.umeng.com/social/android/sdk-download</a></p><p>下载的时候根据自己需求进行选择，我这里选择选择的是精简版（包含常用的分享与登录功能），只测试微信，QQ，新浪微博。<br><img src="1.jpg" alt></p><p>下载后解压出来是这样的：<br><img src="2.jpg" alt></p><h2 id="三、准备资源"><a href="#三、准备资源" class="headerlink" title="三、准备资源"></a>三、准备资源</h2><p>使用友盟的集成工具快速集成友盟的分享SDK：双击 友盟集成工具.jar–&gt;选择使用的平台和IDE，如图：<br><img src="3.jpg" alt></p><p>点击OK键，会在当前目录生成名为umeng_integratetool_result的文件夹，如图：<br><img src="4.jpg" alt></p><h2 id="四、开始集成"><a href="#四、开始集成" class="headerlink" title="四、开始集成"></a>四、开始集成</h2><p>（1）将上面的文件夹依次粘贴到工程相应的文件夹即可，如图：<br><img src="5.jpg" alt></p><p>（2）将debug.keystore文件拷贝到项目的app目录下（对应app build中相应的位置），目的是为了使用友盟的签名，如图：<br><img src="6.jpg" alt></p><p>（3）添加回调Activity<br>微信回调：<br>其实在第一步拷贝的时候已经添加了。即在包名目录下创建wxapi文件夹，新建一个名为WXEntryActivity的activity继承WXCallbackActivity</p><p>QQ与新浪微博的回调：<br>QQ与新浪不需要添加Activity，但需要在使用QQ分享或者授权的Activity中添加如下代码：<br>（注意onActivityResult不可在fragment中实现，如果在fragment中调用登录或分享，需要在fragment依赖的Activity中实现）</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onActivityResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> Intent data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onActivityResult</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>        UMShareAPI<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onActivityResult</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（4）配置清单文件Android Manifest<br>添加权限：</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.ACCESS_NETWORK_STATE"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.ACCESS_WIFI_STATE"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.READ_PHONE_STATE"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.WRITE_EXTERNAL_STORAGE"</span><span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.READ_EXTERNAL_STORAGE"</span><span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.INTERNET"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.ACCESS_FINE_LOCATION"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.ACCESS_COARSE_LOCATION"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.ACCESS_LOCATION_EXTRA_COMMANDS"</span> <span class="token operator">/</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>添加sdk中需要的Activity：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>微信<span class="token operator">--</span><span class="token operator">></span>        <span class="token operator">&lt;</span>activity            android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">".wxapi.WXEntryActivity"</span>            android<span class="token operator">:</span>configChanges<span class="token operator">=</span><span class="token string">"keyboardHidden|orientation|screenSize"</span>            android<span class="token operator">:</span>exported<span class="token operator">=</span><span class="token string">"true"</span>            android<span class="token operator">:</span>screenOrientation<span class="token operator">=</span><span class="token string">"portrait"</span>            android<span class="token operator">:</span>theme<span class="token operator">=</span><span class="token string">"@android:style/Theme.Translucent.NoTitleBar"</span><span class="token operator">/</span><span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>新浪微博<span class="token operator">--</span><span class="token operator">></span>        <span class="token operator">&lt;</span>activity            android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">".WBShareActivity"</span>            android<span class="token operator">:</span>configChanges<span class="token operator">=</span><span class="token string">"keyboardHidden|orientation"</span>            android<span class="token operator">:</span>screenOrientation<span class="token operator">=</span><span class="token string">"portrait"</span><span class="token operator">></span>            <span class="token operator">&lt;</span>intent<span class="token operator">-</span>filter<span class="token operator">></span>                <span class="token operator">&lt;</span>action android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"com.sina.weibo.sdk.action.ACTION_SDK_REQ_ACTIVITY"</span><span class="token operator">/</span><span class="token operator">></span>                <span class="token operator">&lt;</span>category android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.category.DEFAULT"</span><span class="token operator">/</span><span class="token operator">></span>            <span class="token operator">&lt;</span><span class="token operator">/</span>intent<span class="token operator">-</span>filter<span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>activity<span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>qq精简版<span class="token operator">--</span><span class="token operator">></span>        <span class="token operator">&lt;</span>activity            android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"com.umeng.qq.tencent.AuthActivity"</span>            android<span class="token operator">:</span>launchMode<span class="token operator">=</span><span class="token string">"singleTask"</span>            android<span class="token operator">:</span>noHistory<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">></span>            <span class="token operator">&lt;</span>intent<span class="token operator">-</span>filter<span class="token operator">></span>                <span class="token operator">&lt;</span>action android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.action.VIEW"</span><span class="token operator">/</span><span class="token operator">></span>                <span class="token operator">&lt;</span>category android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.category.DEFAULT"</span><span class="token operator">/</span><span class="token operator">></span>                <span class="token operator">&lt;</span>category android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.category.BROWSABLE"</span><span class="token operator">/</span><span class="token operator">></span>                <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>这里的scheme是qq分享要用的，<span class="token number">100424468</span>为自己申请的appid，真实项目中需要替换<span class="token operator">--</span><span class="token operator">></span>                <span class="token operator">&lt;</span>data android<span class="token operator">:</span>scheme<span class="token operator">=</span><span class="token string">"tencent100424468"</span><span class="token operator">/</span><span class="token operator">></span>            <span class="token operator">&lt;</span><span class="token operator">/</span>intent<span class="token operator">-</span>filter<span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>activity<span class="token operator">></span>        <span class="token operator">&lt;</span>activity            android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"com.umeng.qq.tencent.AssistActivity"</span>            android<span class="token operator">:</span>configChanges<span class="token operator">=</span><span class="token string">"orientation|keyboardHidden|screenSize"</span>            android<span class="token operator">:</span>screenOrientation<span class="token operator">=</span><span class="token string">"portrait"</span>            android<span class="token operator">:</span>theme<span class="token operator">=</span><span class="token string">"@android:style/Theme.Translucent.NoTitleBar"</span><span class="token operator">/</span><span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>分享编辑页<span class="token operator">--</span><span class="token operator">></span>        <span class="token operator">&lt;</span>activity            android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"com.umeng.socialize.editorpage.ShareActivity"</span>            android<span class="token operator">:</span>excludeFromRecents<span class="token operator">=</span><span class="token string">"true"</span>            android<span class="token operator">:</span>theme<span class="token operator">=</span><span class="token string">"@style/Theme.UMDefault"</span>            <span class="token operator">/</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>添加友盟appkey：</p><pre class="line-numbers language-java"><code class="language-java">        <span class="token operator">&lt;</span>meta<span class="token operator">-</span>data            android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"UMENG_APPKEY"</span>            android<span class="token operator">:</span>value<span class="token operator">=</span><span class="token string">"561cae6ae0f55abd990035bf"</span><span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">/</span>meta<span class="token operator">-</span>data<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>（5）配置三方appkey<br>新建MyApplication继承Application（注意：需要在清单文件中配置该MyApplication），在MyApplication文件中配置三方平台的appkey和初始化sdk。如下:</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyApplication</span> <span class="token keyword">extends</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        UMShareAPI<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//初始化sdk</span>        <span class="token comment" spellcheck="true">//开启debug模式，方便定位错误，具体错误检查方式可以查看http://dev.umeng.com/social/android/quick-integration的报错必看，正式发布，请关闭该模式</span>        Config<span class="token punctuation">.</span>DEBUG <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//各个平台的配置</span>    <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//微信</span>        PlatformConfig<span class="token punctuation">.</span><span class="token function">setWeixin</span><span class="token punctuation">(</span><span class="token string">"wxdc1e388c3822c80b"</span><span class="token punctuation">,</span> <span class="token string">"3baf1193c85774b3fd9d18447d76cab0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//新浪微博(第三个参数为回调地址)</span>        PlatformConfig<span class="token punctuation">.</span><span class="token function">setSinaWeibo</span><span class="token punctuation">(</span><span class="token string">"3921700954"</span><span class="token punctuation">,</span> <span class="token string">"04b48b094faeb16683c32669824ebdad"</span><span class="token punctuation">,</span><span class="token string">"http://sns.whalecloud.com/sina2/callback"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//QQ</span>        PlatformConfig<span class="token punctuation">.</span><span class="token function">setQQZone</span><span class="token punctuation">(</span><span class="token string">"100424468"</span><span class="token punctuation">,</span> <span class="token string">"c7394704798a158208a74ab60104f0ba"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（6）分享代码MainActivity.java：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String TAG <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">qq</span><span class="token punctuation">(</span>View view<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ShareUtils<span class="token punctuation">.</span><span class="token function">shareWeb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Defaultcontent<span class="token punctuation">.</span>url<span class="token punctuation">,</span> Defaultcontent<span class="token punctuation">.</span>title                <span class="token punctuation">,</span> Defaultcontent<span class="token punctuation">.</span>text<span class="token punctuation">,</span> Defaultcontent<span class="token punctuation">.</span>imageurl<span class="token punctuation">,</span> R<span class="token punctuation">.</span>mipmap<span class="token punctuation">.</span>icon_logo_share<span class="token punctuation">,</span> SHARE_MEDIA<span class="token punctuation">.</span>QQ        <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">weiXin</span><span class="token punctuation">(</span>View view<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ShareUtils<span class="token punctuation">.</span><span class="token function">shareWeb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Defaultcontent<span class="token punctuation">.</span>url<span class="token punctuation">,</span> Defaultcontent<span class="token punctuation">.</span>title                <span class="token punctuation">,</span> Defaultcontent<span class="token punctuation">.</span>text<span class="token punctuation">,</span> Defaultcontent<span class="token punctuation">.</span>imageurl<span class="token punctuation">,</span> R<span class="token punctuation">.</span>mipmap<span class="token punctuation">.</span>icon_logo_share<span class="token punctuation">,</span> SHARE_MEDIA<span class="token punctuation">.</span>WEIXIN        <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">weixinCircle</span><span class="token punctuation">(</span>View view<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ShareUtils<span class="token punctuation">.</span><span class="token function">shareWeb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Defaultcontent<span class="token punctuation">.</span>url<span class="token punctuation">,</span> Defaultcontent<span class="token punctuation">.</span>title                <span class="token punctuation">,</span> Defaultcontent<span class="token punctuation">.</span>text<span class="token punctuation">,</span> Defaultcontent<span class="token punctuation">.</span>imageurl<span class="token punctuation">,</span> R<span class="token punctuation">.</span>mipmap<span class="token punctuation">.</span>icon_logo_share<span class="token punctuation">,</span> SHARE_MEDIA<span class="token punctuation">.</span>WEIXIN_CIRCLE        <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sina</span><span class="token punctuation">(</span>View view<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ShareUtils<span class="token punctuation">.</span><span class="token function">shareWeb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Defaultcontent<span class="token punctuation">.</span>url<span class="token punctuation">,</span> Defaultcontent<span class="token punctuation">.</span>title                <span class="token punctuation">,</span> Defaultcontent<span class="token punctuation">.</span>text<span class="token punctuation">,</span> Defaultcontent<span class="token punctuation">.</span>imageurl<span class="token punctuation">,</span> R<span class="token punctuation">.</span>mipmap<span class="token punctuation">.</span>icon_logo_share<span class="token punctuation">,</span> SHARE_MEDIA<span class="token punctuation">.</span>SINA        <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Qzone</span><span class="token punctuation">(</span>View view<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ShareUtils<span class="token punctuation">.</span><span class="token function">shareWeb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Defaultcontent<span class="token punctuation">.</span>url<span class="token punctuation">,</span> Defaultcontent<span class="token punctuation">.</span>title                <span class="token punctuation">,</span> Defaultcontent<span class="token punctuation">.</span>text<span class="token punctuation">,</span> Defaultcontent<span class="token punctuation">.</span>imageurl<span class="token punctuation">,</span> R<span class="token punctuation">.</span>mipmap<span class="token punctuation">.</span>icon_logo_share<span class="token punctuation">,</span> SHARE_MEDIA<span class="token punctuation">.</span>QZONE        <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onActivityResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> resultCode<span class="token punctuation">,</span> Intent data<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onActivityResult</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>        UMShareAPI<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onActivityResult</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">,</span> resultCode<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（7）分享工具类ShareUtils.java：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShareUtils</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 分享链接     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">shareWeb</span><span class="token punctuation">(</span><span class="token keyword">final</span> Activity activity<span class="token punctuation">,</span> String WebUrl<span class="token punctuation">,</span> String title<span class="token punctuation">,</span> String description<span class="token punctuation">,</span> String imageUrl<span class="token punctuation">,</span> <span class="token keyword">int</span> imageID<span class="token punctuation">,</span> SHARE_MEDIA platform<span class="token punctuation">)</span> <span class="token punctuation">{</span>        UMWeb web <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UMWeb</span><span class="token punctuation">(</span>WebUrl<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//连接地址</span>        web<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//标题</span>        web<span class="token punctuation">.</span><span class="token function">setDescription</span><span class="token punctuation">(</span>description<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//描述</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>imageUrl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            web<span class="token punctuation">.</span><span class="token function">setThumb</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UMImage</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> imageID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//本地缩略图</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            web<span class="token punctuation">.</span><span class="token function">setThumb</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UMImage</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> imageUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//网络缩略图</span>        <span class="token punctuation">}</span>        <span class="token keyword">new</span> <span class="token class-name">ShareAction</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">setPlatform</span><span class="token punctuation">(</span>platform<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">withMedia</span><span class="token punctuation">(</span>web<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UMShareListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span>SHARE_MEDIA share_media<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token punctuation">}</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResult</span><span class="token punctuation">(</span><span class="token keyword">final</span> SHARE_MEDIA share_media<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        activity<span class="token punctuation">.</span><span class="token function">runOnUiThread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token annotation punctuation">@Override</span>                            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                <span class="token keyword">if</span> <span class="token punctuation">(</span>share_media<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"WEIXIN_FAVORITE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                    Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> share_media <span class="token operator">+</span> <span class="token string">" 收藏成功"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                                    Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> share_media <span class="token operator">+</span> <span class="token string">" 分享成功"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token punctuation">}</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token keyword">final</span> SHARE_MEDIA share_media<span class="token punctuation">,</span> <span class="token keyword">final</span> Throwable throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>throwable <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"throw"</span><span class="token punctuation">,</span> <span class="token string">"throw:"</span> <span class="token operator">+</span> throwable<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        activity<span class="token punctuation">.</span><span class="token function">runOnUiThread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token annotation punctuation">@Override</span>                            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> share_media <span class="token operator">+</span> <span class="token string">" 分享失败"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCancel</span><span class="token punctuation">(</span><span class="token keyword">final</span> SHARE_MEDIA share_media<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        activity<span class="token punctuation">.</span><span class="token function">runOnUiThread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token annotation punctuation">@Override</span>                            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> share_media <span class="token operator">+</span> <span class="token string">" 分享取消"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">share</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//新浪微博中图文+链接</span>        <span class="token comment" spellcheck="true">/*new ShareAction(activity)                .setPlatform(platform)                .withText(description + " " + WebUrl)                .withMedia(new UMImage(activity,imageID))                .share();*/</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>效果如下：<br><img src="7.jpg" alt></p><p>Demo下载地址：<a href="https://github.com/wildma/UMengThirdPartyShareLogin" target="_blank" rel="noopener">https://github.com/wildma/UMengThirdPartyShareLogin</a><br>如果对你有帮助，点个star就是对我最大的支持~</p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
          <category> 第三方集成 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 第三方分享 </tag>
            
            <tag> 友盟分享 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Scrollview 嵌套百度地图 MapView 导致滑动有黑边或者阴影问题</title>
      <link href="/scrollview-nest-baidu-map/"/>
      <url>/scrollview-nest-baidu-map/</url>
      
        <content type="html"><![CDATA[<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>项目中需求经常会出现Scrollview嵌套百度地图MapView，如下：<br>但是这样嵌套会出现Scrollview滑动的时候百度地图周边有黑边或者阴影</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token operator">&lt;</span>ScrollView        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"match_parent"</span>        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"match_parent"</span>        android<span class="token operator">:</span>scrollbars<span class="token operator">=</span><span class="token string">"none"</span><span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>其他组件<span class="token operator">--</span><span class="token operator">></span>                <span class="token operator">&lt;</span>com<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>mapapi<span class="token punctuation">.</span>map<span class="token punctuation">.</span>MapView                    android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/map_mapview"</span>                    android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"match_parent"</span>                    android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"@dimen/dimen_154dp"</span>                    android<span class="token operator">:</span>clickable<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>ScrollView<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>将MapView换成TextureMapView即可。如下：</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token operator">&lt;</span>ScrollView        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"match_parent"</span>        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"match_parent"</span>        android<span class="token operator">:</span>scrollbars<span class="token operator">=</span><span class="token string">"none"</span><span class="token operator">></span>        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>其他组件<span class="token operator">--</span><span class="token operator">></span>                <span class="token operator">&lt;</span>com<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>mapapi<span class="token punctuation">.</span>map<span class="token punctuation">.</span>TextureMapView                    android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/map_mapview"</span>                    android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"match_parent"</span>                    android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"@dimen/dimen_154dp"</span>                    android<span class="token operator">:</span>clickable<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>ScrollView<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>3.6.0版本之前由于使用系统GLSurfaceView导致由于系统问题出现的黑屏等，在新版地图SDK3.6.0中可使用TextureMapView作为地图视图控件，解决此类问题，但要求系统在4.0以上并且开启强制GPU渲染。</p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
          <category> 问题记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 百度地图 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>面试时最常问到的 Handler 消息机制源码详解</title>
      <link href="/handler/"/>
      <url>/handler/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>辞职后（非当前时间），最近又开始加入找工作的大队伍中。不得不说今年找工作确实比以前难了。从几个朋友说他们公司快倒闭的情况也验证了这一点。最近面了2家，竟然都问到了Handler消息机制，虽然以前看过源码，但是很久没看，也忘得差不多了，总体的虽然都讲的出，但是却没有彻底征服面试官，所以自己干脆再总结一遍写篇博客记录下来好了。</p><h2 id="一、正确阅读源码的姿势"><a href="#一、正确阅读源码的姿势" class="headerlink" title="一、正确阅读源码的姿势"></a>一、正确阅读源码的姿势</h2><p>有些人阅读源码是力求每行代码都要读懂，我个人感觉这个方法是错误的。正确的方法是应该按平时你使用某个框架或者某个系统源码的执行流程，抓重点去看。例如看Handler源码，应该按照创建Handler-发送消息-处理消息的执行流程去看。并且要看最新版本的源码。例如Android2.3与Android7.0的Handler源码相差还是很大的，Android2.3中Handler的构造方法是没有进行封装的，Android7.0则进行了封装。Android2.3中Handler回收消息的时候消息池大小判断不严谨，但是高版本的就改过来了。</p><h2 id="二、Handler的用法"><a href="#二、Handler的用法" class="headerlink" title="二、Handler的用法"></a>二、Handler的用法</h2><p>Handler最常用的用法，即子线程完成耗时任务然后通知主线程更新UI，步骤为：创建Handler-发送消息-处理消息。如下：</p><pre class="line-numbers language-java"><code class="language-java">        <span class="token comment" spellcheck="true">//2，发送消息（子线程）</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                Message message <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                message<span class="token punctuation">.</span>what <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                message<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> <span class="token number">666</span><span class="token punctuation">;</span>                mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> TAG <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//1，创建Handler（主线程）</span>        <span class="token keyword">final</span> Handler mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//3,处理消息</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what <span class="token operator">==</span> TAG<span class="token punctuation">)</span><span class="token punctuation">{</span>                    tvText<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>arg1<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="三、开始阅读源码"><a href="#三、开始阅读源码" class="headerlink" title="三、开始阅读源码"></a>三、开始阅读源码</h2><p>现在我们就根据上面Handler使用的执行流程去解析源码。</p><h3 id="3-1-创建Handler—-Handler-handler-new-Handler"><a href="#3-1-创建Handler—-Handler-handler-new-Handler" class="headerlink" title="3.1 创建Handler—-Handler handler = new Handler();"></a>3.1 创建Handler—-Handler handler = new Handler();</h3><p>有人问：为什么要在主线程中创建Handler，而不在子线程中创建呢？<br>因为如果你在子线程创建Handler（如下），程序则会崩溃，并且会报错误：Can’t create handler inside thread that has not called Looper.prepare() ，翻译为：不能在没有调用Looper.prepare() 的线程中创建Handler。</p><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                Handler handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>那如果在子线程中先调用一下Looper.prepare()呢，如下：</p><pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                Looper<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                Handler handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>果然程序就能正常运行了。玄机就藏在源码当中！</p><p>首先我们点击我们创建的Handler进去源码是这样的：<br>【Handler.java】</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>然后再跟到这个构造方法里，发现是走了有参构造<br>【Handler.java】</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">Handler</span><span class="token punctuation">(</span>Callback callback<span class="token punctuation">,</span> <span class="token keyword">boolean</span> async<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>FIND_POTENTIAL_LEAKS<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">final</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span><span class="token operator">></span> klass <span class="token operator">=</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>klass<span class="token punctuation">.</span><span class="token function">isAnonymousClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> klass<span class="token punctuation">.</span><span class="token function">isMemberClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> klass<span class="token punctuation">.</span><span class="token function">isLocalClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                    <span class="token punctuation">(</span>klass<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> Modifier<span class="token punctuation">.</span>STATIC<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"The following Handler class should be static or leaks might occur: "</span> <span class="token operator">+</span>                    klass<span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        mLooper <span class="token operator">=</span> Looper<span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mLooper <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>                <span class="token string">"Can't create handler inside thread that has not called Looper.prepare()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        mQueue <span class="token operator">=</span> mLooper<span class="token punctuation">.</span>mQueue<span class="token punctuation">;</span>        mCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>        mAsynchronous <span class="token operator">=</span> async<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，在第13行抛出的异常错误刚好就是我们刚刚上面报的错误！报错的原因是mLooper对象为空了，而mLooper对象则是在第10行代码中获取的，接下来我们点进去看看myLooper()这个方法，如下：<br>【Looper.java】</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> Looper <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> sThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>可以看到，mLooper对象是通过sThreadLocal的get()方法获取的。由此可以联想到应该是有sThreadLocal.set()方法设置了mLooper对象。在当前类中查找，果然找到了。如下：<br>【Looper.java】</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> quitAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>sThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Only one Looper may be created per thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        sThreadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Looper</span><span class="token punctuation">(</span>quitAllowed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>果然，在第5行sThreadLocal.set()方法正是在Looper.prepare()方法里面。这段代码比较简单：首先判断sThreadLocal中有没有Looper对象，有就抛出异常，没有则new一个新的Looper进去。这样就得出结论：之前为什么会报如上错误了（不能在没有调用Looper.prepare() 的线程中创建Handler）。</p><p>但是但是！为什么在主线程中创建Handler之前就不用调用Looper.prepare() 呢？？<br>查找资料发现，Android程序的入口中，系统就默认帮我们调用了Looper.prepare()方法。<br>Android程序的入口在ActivityThread中的main()方法，ActivityThread这个类在Android studio中是看不到的，只能利用工具source insight来看。代码如下：<br>【ActivityThread.java】</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    SamplingProfilerIntegration<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    CloseGuard<span class="token punctuation">.</span><span class="token function">setEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Environment<span class="token punctuation">.</span><span class="token function">initForCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    EventLogger<span class="token punctuation">.</span><span class="token function">setReporter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EventLoggingReporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Process<span class="token punctuation">.</span><span class="token function">setArgV0</span><span class="token punctuation">(</span><span class="token string">"&lt;pre-initialized>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Looper<span class="token punctuation">.</span><span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ActivityThread thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    thread<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>sMainThreadHandler <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        sMainThreadHandler <span class="token operator">=</span> thread<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    AsyncTask<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Looper<span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMessageLogging</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LogPrinter</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span> <span class="token string">"ActivityThread"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    Looper<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Main thread loop unexpectedly exited"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，在第7行调用了Looper.prepareMainLooper()方法，跟进去，prepareMainLooper()方法中又调用了prepare()方法<br>【ActivityThread.java】  </p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setMainLooper</span><span class="token punctuation">(</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Process<span class="token punctuation">.</span><span class="token function">supportsProcesses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mQueue<span class="token punctuation">.</span>mQuitAllowed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样就说明了在主线程中创建Handler同样需要调用Looper.prepare()方法，只是这个方法系统已经帮我们调用了。</p><p>接下来Handler的有参构造就只剩下面三行了。</p><pre class="line-numbers language-java"><code class="language-java">        mQueue <span class="token operator">=</span> mLooper<span class="token punctuation">.</span>mQueue<span class="token punctuation">;</span>        mCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>        mAsynchronous <span class="token operator">=</span> async<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>可以看到，一开始我们用的是无参构造，即传入了一个null的Callback，async的值也是false，所以这里就不考虑这2行，mQueue = mLooper.mQueue;则是获取一个消息队列MessageQueue。用于将所有收到的消息以队列的形式进行排列，并提供入队和出队的方法。MessageQueue这个类是在Looper的构造函数中创建的，因此一个Looper也就对应了一个MessageQueue。</p><p><strong>小总结：主线程中可以直接创建Handler，在子线程中需要先调用Looper.prepare()才能创建Handler。Handler的构造方法中主要是获取轮询器（即Looper对象）和消息队列（即MessageQueue对象）。</strong></p><h3 id="3-2-发送消息—-mHandler-sendMessage-message"><a href="#3-2-发送消息—-mHandler-sendMessage-message" class="headerlink" title="3.2 发送消息—-mHandler.sendMessage(message);"></a>3.2 发送消息—-mHandler.sendMessage(message);</h3><p>点击sendMessage()方法进去，如下：<br>【Handler.java】</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，调用了sendMessageDelayed()方法，点进去，如下：<br>【Handler.java】</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">,</span> <span class="token keyword">long</span> delayMillis<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>delayMillis <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            delayMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> delayMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，delayMillis &lt; 0判断是为了防止用户传入的延迟参数为负数。之后又调用了sendMessageAtTime()方法，点进去，如下：<br>【Handler.java】</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">,</span> <span class="token keyword">long</span> uptimeMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>        MessageQueue queue <span class="token operator">=</span> mQueue<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>queue <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            RuntimeException e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>                    <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">" sendMessageAtTime() called with no mQueue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token string">"Looper"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> uptimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，我们代码中调用sendMessage()方法，最终就是走的sendMessageAtTime()方法。<br>而且其他发送消息的方法除了sendMessageAtFrontOfQueue(),例如sendMessageDelayed()，sendEmptyMessageDelayed()最终都会走sendMessageAtTime()方法。</p><p>sendMessageAtTime()方法接收两个参数，其中msg参数就是我们发送的Message对象，而uptimeMillis参数则表示发送消息的时间，它的值等于自系统开机到当前时间的毫秒数再加上延迟时间，如果你调用的不是sendMessageDelayed()方法，延迟时间就为0。第二行中的mQueue则是我们在创建Handler的时候获取的消息队列，然后将这三个参数都传递到enqueueMessage()方法中。<br>【Handler.java】</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span>MessageQueue queue<span class="token punctuation">,</span> Message msg<span class="token punctuation">,</span> <span class="token keyword">long</span> uptimeMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>        msg<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mAsynchronous<span class="token punctuation">)</span> <span class="token punctuation">{</span>            msg<span class="token punctuation">.</span><span class="token function">setAsynchronous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> queue<span class="token punctuation">.</span><span class="token function">enqueueMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> uptimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，enqueueMessage()方法中，首先将当前的Handler绑定给msg.target，接着调用MessageQueue的enqueueMessage()方法</p><p>MessageQueue的enqueueMessage()方法则是消息入队的方法，点击进去，如下：<br>【MessageQueue.java】</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">boolean</span> <span class="token function">enqueueMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">,</span> <span class="token keyword">long</span> when<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>target <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Message must have a target."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">isInUse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>msg <span class="token operator">+</span> <span class="token string">" This message is already in use."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mQuitting<span class="token punctuation">)</span> <span class="token punctuation">{</span>                IllegalStateException e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>                        msg<span class="token punctuation">.</span>target <span class="token operator">+</span> <span class="token string">" sending message to a Handler on a dead thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Log<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>                msg<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            msg<span class="token punctuation">.</span><span class="token function">markInUse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            msg<span class="token punctuation">.</span>when <span class="token operator">=</span> when<span class="token punctuation">;</span>            Message p <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>            <span class="token keyword">boolean</span> needWake<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> null <span class="token operator">||</span> when <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> when <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// New head, wake up the event queue if blocked.</span>                msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>                mMessages <span class="token operator">=</span> msg<span class="token punctuation">;</span>                needWake <span class="token operator">=</span> mBlocked<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// Inserted within the middle of the queue.  Usually we don't have to wake</span>                <span class="token comment" spellcheck="true">// up the event queue unless there is a barrier at the head of the queue</span>                <span class="token comment" spellcheck="true">// and the message is the earliest asynchronous message in the queue.</span>                needWake <span class="token operator">=</span> mBlocked <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>target <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span><span class="token function">isAsynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Message prev<span class="token punctuation">;</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    prev <span class="token operator">=</span> p<span class="token punctuation">;</span>                    p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> null <span class="token operator">||</span> when <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>needWake <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span><span class="token function">isAsynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        needWake <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                msg<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// invariant: p == prev.next</span>                prev<span class="token punctuation">.</span>next <span class="token operator">=</span> msg<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// We can assume mPtr != 0 because mQuitting is false.</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>needWake<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">nativeWake</span><span class="token punctuation">(</span>mPtr<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，代码的第2行，当msg.target为null时是直接抛异常的。代码的第22-45行，首先判断如果当前的消息队列为空，或者新添加的消息的执行时间when是0，或者新添加的消息的执行时间比消息队列头的消息的执行时间还早，就把消息添加到消息队列头（消息队列按时间排序），否则就要找到合适的位置将当前消息添加到消息队列。</p><p><strong>小总结：发送消息的方法除了sendMessageAtFrontOfQueue(),例如sendMessage()，sendMessageDelayed()最终都会走sendMessageAtTime()方法。在sendMessageAtTime()方法中又调用MessageQueue的enqueueMessage()方法将所有的消息按时间来进行排序放在消息队列中。</strong></p><h3 id="3-3-处理消息—-Looper-loop"><a href="#3-3-处理消息—-Looper-loop" class="headerlink" title="3.3 处理消息—-Looper.loop()"></a>3.3 处理消息—-Looper.loop()</h3><p>消息发送完成并且也已经入队列了，接下来我们就是处理消息队列中的消息了。首先要从队列中取出消息，取消息主要靠轮询器，看Looper.loop()方法<br>【Looper.java】</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> Looper me <span class="token operator">=</span> <span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>me <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"No Looper; Looper.prepare() wasn't called on this thread."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">final</span> MessageQueue queue <span class="token operator">=</span> me<span class="token punctuation">.</span>mQueue<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// Make sure the identity of this thread is that of the local process,</span>        <span class="token comment" spellcheck="true">// and keep track of what that identity token actually is.</span>        Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">final</span> <span class="token keyword">long</span> ident <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            Message msg <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// might block</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// No message indicates that the message queue is quitting.</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// This must be in a local variable, in case a UI event sets the logger</span>            <span class="token keyword">final</span> Printer logging <span class="token operator">=</span> me<span class="token punctuation">.</span>mLogging<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>logging <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                logging<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">">>>>> Dispatching to "</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span>target <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span>                        msg<span class="token punctuation">.</span>callback <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">final</span> <span class="token keyword">long</span> traceTag <span class="token operator">=</span> me<span class="token punctuation">.</span>mTraceTag<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>traceTag <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> Trace<span class="token punctuation">.</span><span class="token function">isTagEnabled</span><span class="token punctuation">(</span>traceTag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                Trace<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span>traceTag<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">getTraceName</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                msg<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">dispatchMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>traceTag <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    Trace<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span>traceTag<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>logging <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                logging<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span>target <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// Make sure that during the course of dispatching the</span>            <span class="token comment" spellcheck="true">// identity of the thread wasn't corrupted.</span>            <span class="token keyword">final</span> <span class="token keyword">long</span> newIdent <span class="token operator">=</span> Binder<span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ident <span class="token operator">!=</span> newIdent<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Log<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Thread identity changed from 0x"</span>                        <span class="token operator">+</span> Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>ident<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" to 0x"</span>                        <span class="token operator">+</span> Long<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>newIdent<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" while dispatching to "</span>                        <span class="token operator">+</span> msg<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span>                        <span class="token operator">+</span> msg<span class="token punctuation">.</span>callback <span class="token operator">+</span> <span class="token string">" what="</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            msg<span class="token punctuation">.</span><span class="token function">recycleUnchecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，代码第6行，从轮询器中获取消息队列。接着通过一个死循环来把消息队列中的消息逐个取出来。代码第14行，通过MessageQueue的next()方法取出消息，当queue.next返回null时会退出消息循环。有消息则调用msg.target.dispatchMessage(msg)，target就是发送message时跟message关联的handler，Message被处理后会被调用recycleUnchecked()进行回收。</p><p>接下来看看MessageQueue的next()方法<br>【MessageQueue.java】</p><pre class="line-numbers language-java"><code class="language-java">    Message <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Return here if the message loop has already quit and been disposed.</span>        <span class="token comment" spellcheck="true">// This can happen if the application tries to restart a looper after quit</span>        <span class="token comment" spellcheck="true">// which is not supported.</span>        <span class="token keyword">final</span> <span class="token keyword">long</span> ptr <span class="token operator">=</span> mPtr<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> pendingIdleHandlerCount <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// -1 only during first iteration</span>        <span class="token keyword">int</span> nextPollTimeoutMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextPollTimeoutMillis <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                Binder<span class="token punctuation">.</span><span class="token function">flushPendingCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">nativePollOnce</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> nextPollTimeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// Try to retrieve the next message.  Return if found.</span>                <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Message prevMsg <span class="token operator">=</span> null<span class="token punctuation">;</span>                Message msg <span class="token operator">=</span> mMessages<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span>target <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span>                    <span class="token keyword">do</span> <span class="token punctuation">{</span>                        prevMsg <span class="token operator">=</span> msg<span class="token punctuation">;</span>                        msg <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>msg<span class="token punctuation">.</span><span class="token function">isAsynchronous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&lt;</span> msg<span class="token punctuation">.</span>when<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// Next message is not ready.  Set a timeout to wake up when it is ready.</span>                        nextPollTimeoutMillis <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>when <span class="token operator">-</span> now<span class="token punctuation">,</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// Got a message.</span>                        mBlocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevMsg <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            prevMsg<span class="token punctuation">.</span>next <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                            mMessages <span class="token operator">=</span> msg<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        msg<span class="token punctuation">.</span>next <span class="token operator">=</span> null<span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> Log<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Returning message: "</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>                        msg<span class="token punctuation">.</span><span class="token function">markInUse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">return</span> msg<span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// No more messages.</span>                    nextPollTimeoutMillis <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// Process the quit message now that all pending messages have been handled.</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>mQuitting<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// If first time idle, then get the number of idlers to run.</span>                <span class="token comment" spellcheck="true">// Idle handles only run if the queue is empty or if the first message</span>                <span class="token comment" spellcheck="true">// in the queue (possibly a barrier) is due to be handled in the future.</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingIdleHandlerCount <span class="token operator">&lt;</span> <span class="token number">0</span>                        <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mMessages <span class="token operator">==</span> null <span class="token operator">||</span> now <span class="token operator">&lt;</span> mMessages<span class="token punctuation">.</span>when<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    pendingIdleHandlerCount <span class="token operator">=</span> mIdleHandlers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingIdleHandlerCount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// No idle handlers to run.  Loop and wait some more.</span>                    mBlocked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    <span class="token keyword">continue</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>mPendingIdleHandlers <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    mPendingIdleHandlers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IdleHandler</span><span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>pendingIdleHandlerCount<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                mPendingIdleHandlers <span class="token operator">=</span> mIdleHandlers<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>mPendingIdleHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// Run the idle handlers.</span>            <span class="token comment" spellcheck="true">// We only ever reach this code block during the first iteration.</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pendingIdleHandlerCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">final</span> IdleHandler idler <span class="token operator">=</span> mPendingIdleHandlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>                mPendingIdleHandlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// release the reference to the handler</span>                <span class="token keyword">boolean</span> keep <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token keyword">try</span> <span class="token punctuation">{</span>                    keep <span class="token operator">=</span> idler<span class="token punctuation">.</span><span class="token function">queueIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    Log<span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"IdleHandler threw exception"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keep<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        mIdleHandlers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>idler<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// Reset the idle handler count to 0 so we do not run them again.</span>            pendingIdleHandlerCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// While calling an idle handler, a new message could have been delivered</span>            <span class="token comment" spellcheck="true">// so go back and look again for a pending message without waiting.</span>            nextPollTimeoutMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>大概意思是如果当前MessageQueue中存在mMessages就将这个消息取出来，标记为已用并从消息队列中移除该消息，然后让下一条消息成为mMessages，否则就进入一个阻塞状态，一直等到有新的消息入队。</p><p>接下来看看Handler的dispatchMessage()方法<br>【Handler.java】</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dispatchMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>callback <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">handleCallback</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>mCallback <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>mCallback<span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，第2行进行判断，如果msg.callback不为空，则调用handleCallback(msg);方法，否则直接调用Handler的handleMessage()方法。这里的handleMessage()方法是不是很熟悉？没错！就是我们在主线程中处理消息的handleMessage()方法。</p><p>接下来看看Handler的handleCallback()方法<br>【Handler.java】</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">handleCallback</span><span class="token punctuation">(</span>Message message<span class="token punctuation">)</span> <span class="token punctuation">{</span>            message<span class="token punctuation">.</span>callback<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>可以看到，处理消息是在run方法中，即Runnable对象的run方法，也就是我们不用最常用的方法使用handle，而是以callback的方式使用。如下：</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token comment" spellcheck="true">//1，创建Handler（主线程）</span>    Handler mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//3,处理消息</span>                mMessage <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------------callback的形式处理消息--------------"</span> <span class="token operator">+</span> mMessage<span class="token punctuation">.</span>arg1<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                mMessage<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> <span class="token number">666</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//2,发送消息</span>                mHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>mMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其实Handler的post()方法源码也是走了handleCallback()方法。自己点击post()方法进去看看就知道了。</p><p><strong>小总结：通过轮询器的Looper.loop()方法中执行一个死循环把消息队列中的消息逐个取出来。死循环中主要通过MessageQueue的next()方法取出消息，取出消息后通过调用Handler的dispatchMessage()方法最终在handleCallback(msg)或者handleMessage(msg)方法处理消息。</strong></p><p><strong>好了，Handler消息机制源码终于分析完了。希望这篇文章可以在面试当中帮到你们。</strong></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
          <category> 面试 </category>
          
          <category> 源码解析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Handler </tag>
            
            <tag> 面试 </tag>
            
            <tag> 源码解析 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>最全加快 Android Studio 的编译速度</title>
      <link href="/promote-android-studio-compile-speed/"/>
      <url>/promote-android-studio-compile-speed/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>一开始公司的电脑运行Android Studio的项目那叫一个慢呀! 每次都要2-5分钟。但是电脑的内存又是8G，CPU是I7的，按道理不应该这么慢呀。后来我实在不能忍受了， 经过一番折腾，终于将运行速度提升到10-30秒以内。下面总结下几种方法。</p><h2 id="一、加大分配的内存"><a href="#一、加大分配的内存" class="headerlink" title="一、加大分配的内存"></a>一、加大分配的内存</h2><p>打开Android Studio的安装目录，找到下面的文件进行修改，如图：<br>bin\studio64.exe.vmoptions<br><img src="1.jpg" alt></p><h2 id="二、Android-Studio设置自动编译工程"><a href="#二、Android-Studio设置自动编译工程" class="headerlink" title="二、Android Studio设置自动编译工程"></a>二、Android Studio设置自动编译工程</h2><p>打开Android Studio的设置，找到如图所示，打上勾即可。如图：<br><img src="2.jpg" alt></p><h2 id="三、打开Android-Studio的-instant-run-功能，如图："><a href="#三、打开Android-Studio的-instant-run-功能，如图：" class="headerlink" title="三、打开Android Studio的 instant run 功能，如图："></a>三、打开Android Studio的 instant run 功能，如图：</h2><p><img src="3.jpg" alt></p><h2 id="四、打开dex增量编译"><a href="#四、打开dex增量编译" class="headerlink" title="四、打开dex增量编译"></a>四、打开dex增量编译</h2><p>在Module的build.gradle中添加如下代码</p><pre><code>dexOptions {        incremental true}</code></pre><h2 id="五、修改gradle设置"><a href="#五、修改gradle设置" class="headerlink" title="五、修改gradle设置"></a>五、修改gradle设置</h2><p>在Project的gradle.properties中添加：</p><pre><code>org.gradle.daemon=trueorg.gradle.parallel=trueorg.gradle.configureondemand=trueorg.gradle.jvmargs=-Xmx2048m -XX:MaxPermSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8</code></pre><h2 id="六、使用本地gradle"><a href="#六、使用本地gradle" class="headerlink" title="六、使用本地gradle"></a>六、使用本地gradle</h2><p>在Android studio–&gt;Settings–&gt;Gradle 将offline work勾选上，如图：<br><img src="4.jpg" alt></p>]]></content>
      
      
      <categories>
          
          <category> 工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android Studio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android Butterknife 8.5.1 最新使用详解</title>
      <link href="/butterknife/"/>
      <url>/butterknife/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>以前我们会在代码中写很多findViewById以及setOnClickListener等代码，不仅写起来麻烦，看起来也不整洁。现在我们用View注入框架ButterKnife就能解决这些问题。</p><p>ButterKnife的github地址：<a href="https://github.com/JakeWharton/butterknife" target="_blank" rel="noopener">https://github.com/JakeWharton/butterknife</a></p><h2 id="一、添加依赖"><a href="#一、添加依赖" class="headerlink" title="一、添加依赖"></a>一、添加依赖</h2><p>（1）在项目的的build.gredle 文件中的dependencies标签内添加如下：</p><pre class="line-numbers language-java"><code class="language-java">classpath <span class="token string">'com.jakewharton:butterknife-gradle-plugin:8.5.1'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如图所示：<br><img src="1.jpg" alt></p><p>（2）在Module的的build.gredle 文件中的最上面添加如下：</p><pre class="line-numbers language-java"><code class="language-java">apply plugin<span class="token operator">:</span> <span class="token string">'com.jakewharton.butterknife'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>（3）在Module的的build.gredle 文件中的dependencies标签内添加如下：</p><pre class="line-numbers language-java"><code class="language-java">compile <span class="token string">'com.jakewharton:butterknife:8.5.1'</span>annotationProcessor <span class="token string">'com.jakewharton:butterknife-compiler:8.5.1'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>如图所示：<br><img src="2.jpg" alt></p><h2 id="二、使用"><a href="#二、使用" class="headerlink" title="二、使用"></a>二、使用</h2><p>例如在布局文件中我们有个控件tv_text需要绑定</p><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span>TextView        android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/tv_text"</span>        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"wrap_content"</span>        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"wrap_content"</span>        android<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string">"Hello World!"</span><span class="token operator">/</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>则我们需要在代码中添加如下代码<br>（1）绑定activity</p><pre class="line-numbers language-java"><code class="language-java">ButterKnife<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>（2）绑定控件id</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@BindView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>tv_text<span class="token punctuation">)</span>    TextView mTvText<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>（3）使用该控件，如下图所示<br><img src="3.jpg" alt></p><p><strong>如果是绑定fragment，则添加如下代码</strong></p><pre class="line-numbers language-java"><code class="language-java">ButterKnife<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> view<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>如果是绑定RecyclerView的item，则在ViewHolder中添加如下代码</strong></p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ViewHolder</span> <span class="token keyword">extends</span> <span class="token class-name">RecyclerView<span class="token punctuation">.</span>ViewHolder</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@BindView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>tv_day<span class="token punctuation">)</span>        TextView     mTvDay<span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token function">ViewHolder</span><span class="token punctuation">(</span>View itemView<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">super</span><span class="token punctuation">(</span>itemView<span class="token punctuation">)</span><span class="token punctuation">;</span>            ButterKnife<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> itemView<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="三、配合Butterknife插件使用更简单"><a href="#三、配合Butterknife插件使用更简单" class="headerlink" title="三、配合Butterknife插件使用更简单"></a>三、配合Butterknife插件使用更简单</h2><p>让我们写上面的代码还是比较麻烦的，高手都是用插件的。使用步骤如下：<br><strong>插件的安装：</strong></p><p>（1）在settings中搜索插件Zelezny<br><img src="4.jpg" alt></p><p>（2）点击安装，安装后需要重启android studio<br><img src="5.jpg" alt></p><p><strong>插件的使用：</strong></p><p>（1）选中布局文件，点击右键，选择Generate-&gt;Generate Butterknife Injections-&gt;Confirm，如图：<br><img src="6.jpg" alt></p><p><img src="7.jpg" alt></p><p><img src="8.jpg" alt></p><p>（2）点击Confirm后，会自动生成BindView等代码:<br><img src="9.jpg" alt></p><p>OK，Butterknife使用就到这里结束。</p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Butterknife </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android 使用 ShareSDK 集成 QQ、微信、微博等第三方登录</title>
      <link href="/sharesdk-login/"/>
      <url>/sharesdk-login/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>第三方登录几乎是每个APP的必须功能。有些人说看官方的文档实在让人眼花缭乱，以前自己第一次做这些功能的时候也会遇到很多坑。这里整理了一份比较详细的，主要给新手学习。有任何问题欢迎提出来！</p><h2 id="一、获取ShareSDK的AppKey"><a href="#一、获取ShareSDK的AppKey" class="headerlink" title="一、获取ShareSDK的AppKey"></a>一、获取ShareSDK的AppKey</h2><p>（照着流程来，很简单！）<br><a href="http://bbs.mob.com/forum.php?mod=viewthread&amp;tid=8212&amp;extra=page%3D1" target="_blank" rel="noopener">http://bbs.mob.com/forum.php?mod=viewthread&amp;tid=8212&amp;extra=page%3D1</a></p><h2 id="二、下载SDK"><a href="#二、下载SDK" class="headerlink" title="二、下载SDK"></a>二、下载SDK</h2><p>下载地址：<a href="http://www.mob.com/downloadDetail/ShareSDK/android" target="_blank" rel="noopener">http://www.mob.com/downloadDetail/ShareSDK/android</a><br>下载的时候一般用默认的就足够了<br><img src="1.jpg" alt></p><p>下载后解压出来是这样的<br><img src="2.jpg" alt></p><h2 id="三、准备资源"><a href="#三、准备资源" class="headerlink" title="三、准备资源"></a>三、准备资源</h2><p>点击第一个文件夹，进去如下，双击QuickIntegrater.jar<br><img src="3.jpg" alt></p><p>只需要填写项目名称和项目包名即可，其他默认。如图：<br><img src="4.jpg" alt></p><p>点击确认后会生成如下文件夹，如图：<br><img src="5.jpg" alt></p><p><img src="6.jpg" alt></p><h2 id="四、开始集成"><a href="#四、开始集成" class="headerlink" title="四、开始集成"></a>四、开始集成</h2><p>（1）将上面的文件夹依次粘贴到工程相应的文件夹即可，如图：<br><img src="7.jpg" alt></p><p>（2）在清单文件AndroidManifest.xml添加权限</p><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.GET_TASKS"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.INTERNET"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.ACCESS_WIFI_STATE"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.ACCESS_NETWORK_STATE"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.CHANGE_WIFI_STATE"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.WRITE_EXTERNAL_STORAGE"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.READ_PHONE_STATE"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.MANAGE_ACCOUNTS"</span><span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.GET_ACCOUNTS"</span><span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 蓝牙分享所需的权限 <span class="token operator">--</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.BLUETOOTH"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.BLUETOOTH_ADMIN"</span> <span class="token operator">/</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（3）在清单文件AndroidManifest.xml添加activity信息<br>（注意：tencent后面的appid要保持和您配置的QQ的appid一致）</p><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span>activity     android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"com.mob.tools.MobUIShell"</span>     android<span class="token operator">:</span>theme<span class="token operator">=</span><span class="token string">"@android:style/Theme.Translucent.NoTitleBar"</span>     android<span class="token operator">:</span>configChanges<span class="token operator">=</span><span class="token string">"keyboardHidden|orientation|screenSize"</span>     android<span class="token operator">:</span>screenOrientation<span class="token operator">=</span><span class="token string">"portrait"</span>     android<span class="token operator">:</span>windowSoftInputMode<span class="token operator">=</span><span class="token string">"stateHidden|adjustResize"</span> <span class="token operator">></span>     <span class="token operator">&lt;</span>intent<span class="token operator">-</span>filter<span class="token operator">></span>         <span class="token operator">&lt;</span>data android<span class="token operator">:</span>scheme<span class="token operator">=</span><span class="token string">"tencent100371282"</span> <span class="token operator">/</span><span class="token operator">></span>         <span class="token operator">&lt;</span>action android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.action.VIEW"</span> <span class="token operator">/</span><span class="token operator">></span>         <span class="token operator">&lt;</span>category android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.category.BROWSABLE"</span> <span class="token operator">/</span><span class="token operator">></span>         <span class="token operator">&lt;</span>category android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.category.DEFAULT"</span> <span class="token operator">/</span><span class="token operator">></span>     <span class="token operator">&lt;</span><span class="token operator">/</span>intent<span class="token operator">-</span>filter<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 调用新浪原生SDK，需要注册的回调activity <span class="token operator">--</span><span class="token operator">></span>    <span class="token operator">&lt;</span>intent<span class="token operator">-</span>filter<span class="token operator">></span>        <span class="token operator">&lt;</span>action android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"com.sina.weibo.sdk.action.ACTION_SDK_REQ_ACTIVITY"</span> <span class="token operator">/</span><span class="token operator">></span>        <span class="token operator">&lt;</span>category android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.category.DEFAULT"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>intent<span class="token operator">-</span>filter<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>集成line客户端登录授权，需要添如下格式的过滤器<span class="token operator">--</span><span class="token operator">></span>    <span class="token operator">&lt;</span>intent<span class="token operator">-</span>filter<span class="token operator">></span>        <span class="token operator">&lt;</span>data android<span class="token operator">:</span>scheme<span class="token operator">=</span><span class="token string">"line.1477692153"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>action android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.action.VIEW"</span><span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>category android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.category.BROWSABLE"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>category android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.category.DEFAULT"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>intent<span class="token operator">-</span>filter<span class="token operator">></span> <span class="token operator">&lt;</span><span class="token operator">/</span>activity<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果您集成了微信，还需要添加下面回调的activity处理；</p><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span>activity     android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">".wxapi.WXEntryActivity"</span>     android<span class="token operator">:</span>theme<span class="token operator">=</span><span class="token string">"@android:style/Theme.Translucent.NoTitleBar"</span>     android<span class="token operator">:</span>configChanges<span class="token operator">=</span><span class="token string">"keyboardHidden|orientation|screenSize"</span>     android<span class="token operator">:</span>exported<span class="token operator">=</span><span class="token string">"true"</span>     android<span class="token operator">:</span>screenOrientation<span class="token operator">=</span><span class="token string">"portrait"</span> <span class="token operator">/</span><span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（4）在刚刚拷贝进去的ShareSDK中替换mob后台申请的Appkey与各个平台申请的key<br>注意：<br>mob后台申请的Appkey：就是第一部中获取ShareSDK的AppKey<br>各个平台申请的key：需要到各个平台申请，例如需要微信分享，则需要到微信开放平台进行申请</p><p><img src="8.jpg" alt></p><p>（5）添加登录代码<br>在您程序启动的时候添加初始化代码（注：不要等调用ShareSDK功能之前才初始化）<br>即自己添加一个类继承Application，在onCreate方法添加下面的代码，如下：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyApplication</span> <span class="token keyword">extends</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//初始化ShareSDK</span>        ShareSDK<span class="token punctuation">.</span><span class="token function">initSDK</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意: 该类需要在清单文件中注册，如图：<br><img src="9.jpg" alt></p><p>登录activity代码：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token keyword">implements</span> <span class="token class-name">PlatformActionListener</span><span class="token punctuation">,</span> Handler<span class="token punctuation">.</span>Callback<span class="token punctuation">,</span> View<span class="token punctuation">.</span>OnClickListener <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MSG_ACTION_CCALLBACK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> ImageView ivWxLogin<span class="token punctuation">;</span>    <span class="token keyword">private</span> ImageView ivQqLogin<span class="token punctuation">;</span>    <span class="token keyword">private</span> ImageView ivBlog<span class="token punctuation">;</span>    <span class="token keyword">private</span> ProgressDialog progressDialog<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_login<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">initView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">initListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">initData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        ivWxLogin <span class="token operator">=</span> <span class="token punctuation">(</span>ImageView<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>iv_wx_login<span class="token punctuation">)</span><span class="token punctuation">;</span>        ivQqLogin <span class="token operator">=</span> <span class="token punctuation">(</span>ImageView<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>iv_qq_login<span class="token punctuation">)</span><span class="token punctuation">;</span>        ivBlog <span class="token operator">=</span> <span class="token punctuation">(</span>ImageView<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>iv_blog<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        ivWxLogin<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ivQqLogin<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ivBlog<span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span>View view<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>view<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">case</span> R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>iv_wx_login<span class="token operator">:</span>                Platform wechat <span class="token operator">=</span> ShareSDK<span class="token punctuation">.</span><span class="token function">getPlatform</span><span class="token punctuation">(</span>Wechat<span class="token punctuation">.</span>NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>                wechat<span class="token punctuation">.</span><span class="token function">setPlatformActionListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                wechat<span class="token punctuation">.</span><span class="token function">SSOSetting</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">authorize</span><span class="token punctuation">(</span>wechat<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>iv_qq_login<span class="token operator">:</span>                Platform qq <span class="token operator">=</span> ShareSDK<span class="token punctuation">.</span><span class="token function">getPlatform</span><span class="token punctuation">(</span>QQ<span class="token punctuation">.</span>NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>                qq<span class="token punctuation">.</span><span class="token function">setPlatformActionListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                qq<span class="token punctuation">.</span><span class="token function">SSOSetting</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">authorize</span><span class="token punctuation">(</span>qq<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>iv_blog<span class="token operator">:</span>                Platform sina <span class="token operator">=</span> ShareSDK<span class="token punctuation">.</span><span class="token function">getPlatform</span><span class="token punctuation">(</span>SinaWeibo<span class="token punctuation">.</span>NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>                sina<span class="token punctuation">.</span><span class="token function">setPlatformActionListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                sina<span class="token punctuation">.</span><span class="token function">SSOSetting</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">authorize</span><span class="token punctuation">(</span>sina<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">default</span><span class="token operator">:</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//授权</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">authorize</span><span class="token punctuation">(</span>Platform plat<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>                <span class="token function">showProgressDialog</span><span class="token punctuation">(</span><span class="token function">getString</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>opening_wechat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>                <span class="token function">showProgressDialog</span><span class="token punctuation">(</span><span class="token function">getString</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>opening_qq<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>                <span class="token function">showProgressDialog</span><span class="token punctuation">(</span><span class="token function">getString</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>string<span class="token punctuation">.</span>opening_blog<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>plat<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//如果授权就删除授权资料</span>            plat<span class="token punctuation">.</span><span class="token function">removeAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        plat<span class="token punctuation">.</span><span class="token function">showUser</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//授权并获取用户信息</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//登陆授权成功的回调</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>Platform platform<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> HashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Message msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        msg<span class="token punctuation">.</span>what <span class="token operator">=</span> MSG_ACTION_CCALLBACK<span class="token punctuation">;</span>        msg<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        msg<span class="token punctuation">.</span>arg2 <span class="token operator">=</span> action<span class="token punctuation">;</span>        msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> platform<span class="token punctuation">;</span>        UIHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//发送消息</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//登陆授权错误的回调</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span>Platform platform<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Message msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        msg<span class="token punctuation">.</span>what <span class="token operator">=</span> MSG_ACTION_CCALLBACK<span class="token punctuation">;</span>        msg<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>        msg<span class="token punctuation">.</span>arg2 <span class="token operator">=</span> action<span class="token punctuation">;</span>        msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> t<span class="token punctuation">;</span>        UIHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//登陆授权取消的回调</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCancel</span><span class="token punctuation">(</span>Platform platform<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Message msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        msg<span class="token punctuation">.</span>what <span class="token operator">=</span> MSG_ACTION_CCALLBACK<span class="token punctuation">;</span>        msg<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>        msg<span class="token punctuation">.</span>arg2 <span class="token operator">=</span> action<span class="token punctuation">;</span>        msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> platform<span class="token punctuation">;</span>        UIHandler<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//登陆发送的handle消息在这里处理</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message message<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">hideProgressDialog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>arg1<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 成功</span>                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>LoginActivity<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"授权登陆成功"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//获取用户资料</span>                Platform platform <span class="token operator">=</span> <span class="token punctuation">(</span>Platform<span class="token punctuation">)</span> message<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>                String userId <span class="token operator">=</span> platform<span class="token punctuation">.</span><span class="token function">getDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//获取用户账号</span>                String userName <span class="token operator">=</span> platform<span class="token punctuation">.</span><span class="token function">getDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//获取用户名字</span>                String userIcon <span class="token operator">=</span> platform<span class="token punctuation">.</span><span class="token function">getDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserIcon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//获取用户头像</span>                String userGender <span class="token operator">=</span> platform<span class="token punctuation">.</span><span class="token function">getDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserGender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//获取用户性别，m = 男, f = 女，如果微信没有设置性别,默认返回null</span>                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>LoginActivity<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"用户信息为--用户名："</span> <span class="token operator">+</span> userName <span class="token operator">+</span> <span class="token string">"  性别："</span> <span class="token operator">+</span> userGender<span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//下面就可以利用获取的用户信息登录自己的服务器或者做自己想做的事啦!</span>                <span class="token comment" spellcheck="true">//。。。</span>            <span class="token punctuation">}</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 失败</span>                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>LoginActivity<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"授权登陆失败"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 取消</span>                Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>LoginActivity<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"授权登陆取消"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//显示dialog</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">showProgressDialog</span><span class="token punctuation">(</span>String message<span class="token punctuation">)</span> <span class="token punctuation">{</span>        progressDialog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProgressDialog</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        progressDialog<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>        progressDialog<span class="token punctuation">.</span><span class="token function">setCancelable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        progressDialog<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//隐藏dialog</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hideProgressDialog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>progressDialog <span class="token operator">!=</span> null<span class="token punctuation">)</span>            progressDialog<span class="token punctuation">.</span><span class="token function">dismiss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>布局activity_login.xml：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token operator">?</span><span class="token operator">></span><span class="token operator">&lt;</span>LinearLayout xmlns<span class="token operator">:</span>android<span class="token operator">=</span><span class="token string">"http://schemas.android.com/apk/res/android"</span>              android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"match_parent"</span>              android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"match_parent"</span>              android<span class="token operator">:</span>gravity<span class="token operator">=</span><span class="token string">"center"</span>              android<span class="token operator">:</span>orientation<span class="token operator">=</span><span class="token string">"horizontal"</span>    <span class="token operator">></span>    <span class="token operator">&lt;</span>LinearLayout        android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"match_parent"</span>        android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"wrap_content"</span>        android<span class="token operator">:</span>gravity<span class="token operator">=</span><span class="token string">"center"</span><span class="token operator">></span>        <span class="token operator">&lt;</span>ImageView            android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/iv_wx_login"</span>            android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"wrap_content"</span>            android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"wrap_content"</span>            android<span class="token operator">:</span>layout_gravity<span class="token operator">=</span><span class="token string">"center_horizontal"</span>            android<span class="token operator">:</span>layout_marginTop<span class="token operator">=</span><span class="token string">"10dp"</span>            android<span class="token operator">:</span>clickable<span class="token operator">=</span><span class="token string">"true"</span>            android<span class="token operator">:</span>src<span class="token operator">=</span><span class="token string">"@mipmap/wechat_icon"</span>            <span class="token operator">/</span><span class="token operator">></span>        <span class="token operator">&lt;</span>ImageView            android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/iv_qq_login"</span>            android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"wrap_content"</span>            android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"wrap_content"</span>            android<span class="token operator">:</span>layout_gravity<span class="token operator">=</span><span class="token string">"center_horizontal"</span>            android<span class="token operator">:</span>layout_marginLeft<span class="token operator">=</span><span class="token string">"20dp"</span>            android<span class="token operator">:</span>layout_marginRight<span class="token operator">=</span><span class="token string">"20dp"</span>            android<span class="token operator">:</span>layout_marginTop<span class="token operator">=</span><span class="token string">"10dp"</span>            android<span class="token operator">:</span>clickable<span class="token operator">=</span><span class="token string">"true"</span>            android<span class="token operator">:</span>src<span class="token operator">=</span><span class="token string">"@mipmap/qq_icon"</span>            <span class="token operator">/</span><span class="token operator">></span>        <span class="token operator">&lt;</span>ImageView            android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/iv_blog"</span>            android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"wrap_content"</span>            android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"wrap_content"</span>            android<span class="token operator">:</span>layout_gravity<span class="token operator">=</span><span class="token string">"center_horizontal"</span>            android<span class="token operator">:</span>layout_marginTop<span class="token operator">=</span><span class="token string">"10dp"</span>            android<span class="token operator">:</span>clickable<span class="token operator">=</span><span class="token string">"true"</span>            android<span class="token operator">:</span>src<span class="token operator">=</span><span class="token string">"@mipmap/blog_icon"</span>            <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>LinearLayout<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>LinearLayout<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>效果如下：</p><p><img src="10.jpg" alt></p><p>Demo下载：<a href="https://github.com/wildma/ShareSDKThirdPartyShareLogin" target="_blank" rel="noopener">https://github.com/wildma/ShareSDKThirdPartyShareLogin</a> </p><p><strong>如果对你有帮助记得点赞，star支持下哈~</strong></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
          <category> 第三方集成 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ShareSDK </tag>
            
            <tag> 第三方登录 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android 使用 ShareSDK 集成 QQ、微信、微博等第三方分享</title>
      <link href="/sharesdk-share/"/>
      <url>/sharesdk-share/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>第三方分享几乎是每个APP的必须功能。有些人说看官方的文档实在让人眼花缭乱，以前自己第一次做这些功能的时候也会遇到很多坑。这里整理了一份比较详细的，主要给新手学习。有任何问题欢迎提出来！</p><h2 id="一、获取ShareSDK的AppKey"><a href="#一、获取ShareSDK的AppKey" class="headerlink" title="一、获取ShareSDK的AppKey"></a>一、获取ShareSDK的AppKey</h2><p>（照着流程来，很简单！）<br><a href="http://bbs.mob.com/forum.php?mod=viewthread&amp;tid=8212&amp;extra=page%3D1" target="_blank" rel="noopener">http://bbs.mob.com/forum.php?mod=viewthread&amp;tid=8212&amp;extra=page%3D1</a></p><h2 id="二、下载SDK"><a href="#二、下载SDK" class="headerlink" title="二、下载SDK"></a>二、下载SDK</h2><p>下载地址：<a href="http://www.mob.com/downloadDetail/ShareSDK/android" target="_blank" rel="noopener">http://www.mob.com/downloadDetail/ShareSDK/android</a><br>下载的时候一般用默认的就足够了<br><img src="1.jpg" alt></p><p>下载后解压出来是这样的<br><img src="2.jpg" alt></p><h2 id="三、准备资源"><a href="#三、准备资源" class="headerlink" title="三、准备资源"></a>三、准备资源</h2><p>点击第一个文件夹，进去如下，双击QuickIntegrater.jar<br><img src="3.jpg" alt></p><p>只需要填写项目名称和项目包名即可，其他默认。如图：<br><img src="4.jpg" alt></p><p>点击确认后会生成如下文件夹，如图：<br><img src="5.jpg" alt></p><p><img src="6.jpg" alt></p><h2 id="四、开始集成"><a href="#四、开始集成" class="headerlink" title="四、开始集成"></a>四、开始集成</h2><p>（1）将上面的文件夹依次粘贴到工程相应的文件夹即可，如图：<br><img src="7.jpg" alt></p><p>（2）在清单文件AndroidManifest.xml添加权限</p><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.GET_TASKS"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.INTERNET"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.ACCESS_WIFI_STATE"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.ACCESS_NETWORK_STATE"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.CHANGE_WIFI_STATE"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.WRITE_EXTERNAL_STORAGE"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.READ_PHONE_STATE"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.MANAGE_ACCOUNTS"</span><span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.GET_ACCOUNTS"</span><span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 蓝牙分享所需的权限 <span class="token operator">--</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.BLUETOOTH"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.BLUETOOTH_ADMIN"</span> <span class="token operator">/</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（3）在清单文件AndroidManifest.xml添加activity信息<br>（注意：tencent后面的appid要保持和您配置的QQ的appid一致）</p><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span>activity     android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"com.mob.tools.MobUIShell"</span>     android<span class="token operator">:</span>theme<span class="token operator">=</span><span class="token string">"@android:style/Theme.Translucent.NoTitleBar"</span>     android<span class="token operator">:</span>configChanges<span class="token operator">=</span><span class="token string">"keyboardHidden|orientation|screenSize"</span>     android<span class="token operator">:</span>screenOrientation<span class="token operator">=</span><span class="token string">"portrait"</span>     android<span class="token operator">:</span>windowSoftInputMode<span class="token operator">=</span><span class="token string">"stateHidden|adjustResize"</span> <span class="token operator">></span>     <span class="token operator">&lt;</span>intent<span class="token operator">-</span>filter<span class="token operator">></span>         <span class="token operator">&lt;</span>data android<span class="token operator">:</span>scheme<span class="token operator">=</span><span class="token string">"tencent100371282"</span> <span class="token operator">/</span><span class="token operator">></span>         <span class="token operator">&lt;</span>action android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.action.VIEW"</span> <span class="token operator">/</span><span class="token operator">></span>         <span class="token operator">&lt;</span>category android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.category.BROWSABLE"</span> <span class="token operator">/</span><span class="token operator">></span>         <span class="token operator">&lt;</span>category android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.category.DEFAULT"</span> <span class="token operator">/</span><span class="token operator">></span>     <span class="token operator">&lt;</span><span class="token operator">/</span>intent<span class="token operator">-</span>filter<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 调用新浪原生SDK，需要注册的回调activity <span class="token operator">--</span><span class="token operator">></span>    <span class="token operator">&lt;</span>intent<span class="token operator">-</span>filter<span class="token operator">></span>        <span class="token operator">&lt;</span>action android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"com.sina.weibo.sdk.action.ACTION_SDK_REQ_ACTIVITY"</span> <span class="token operator">/</span><span class="token operator">></span>        <span class="token operator">&lt;</span>category android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.category.DEFAULT"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>intent<span class="token operator">-</span>filter<span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>集成line客户端登录授权，需要添如下格式的过滤器<span class="token operator">--</span><span class="token operator">></span>    <span class="token operator">&lt;</span>intent<span class="token operator">-</span>filter<span class="token operator">></span>        <span class="token operator">&lt;</span>data android<span class="token operator">:</span>scheme<span class="token operator">=</span><span class="token string">"line.1477692153"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>action android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.action.VIEW"</span><span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>category android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.category.BROWSABLE"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>category android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.intent.category.DEFAULT"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span><span class="token operator">/</span>intent<span class="token operator">-</span>filter<span class="token operator">></span> <span class="token operator">&lt;</span><span class="token operator">/</span>activity<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果您集成了微信，还需要添加下面回调的activity处理；</p><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span>activity     android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">".wxapi.WXEntryActivity"</span>     android<span class="token operator">:</span>theme<span class="token operator">=</span><span class="token string">"@android:style/Theme.Translucent.NoTitleBar"</span>     android<span class="token operator">:</span>configChanges<span class="token operator">=</span><span class="token string">"keyboardHidden|orientation|screenSize"</span>     android<span class="token operator">:</span>exported<span class="token operator">=</span><span class="token string">"true"</span>     android<span class="token operator">:</span>screenOrientation<span class="token operator">=</span><span class="token string">"portrait"</span> <span class="token operator">/</span><span class="token operator">></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（4）在刚刚拷贝进去的ShareSDK中替换mob后台申请的Appkey与各个平台申请的key<br>注意：<br>mob后台申请的Appkey：就是第一部中获取ShareSDK的AppKey<br>各个平台申请的key：需要到各个平台申请，例如需要微信分享，则需要到微信开放平台进行申请</p><p><img src="8.jpg" alt></p><p>（5）添加分享代码<br>在您程序启动的时候添加初始化代码（注：不要等调用ShareSDK功能之前才初始化）<br>即自己添加一个类继承Application，在onCreate方法添加下面的代码，如下：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyApplication</span> <span class="token keyword">extends</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//初始化ShareSDK</span>        ShareSDK<span class="token punctuation">.</span><span class="token function">initSDK</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意: 该类需要在清单文件中注册，如图：<br><img src="9.jpg" alt></p><p>在您的代码中调用此方法，即可打开一键分享功能进行分享</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">showShare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> OnekeyShare oks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OnekeyShare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//关闭sso授权</span> oks<span class="token punctuation">.</span><span class="token function">disableSSOWhenAuthorize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// title标题，印象笔记、邮箱、信息、微信、人人网、QQ和QQ空间使用</span> oks<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">"标题"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// titleUrl是标题的网络链接，仅在Linked-in,QQ和QQ空间使用</span> oks<span class="token punctuation">.</span><span class="token function">setTitleUrl</span><span class="token punctuation">(</span><span class="token string">"http://sharesdk.cn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// text是分享文本，所有平台都需要这个字段</span> oks<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"我是分享文本"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//分享网络图片，新浪微博分享网络图片需要通过审核后申请高级写入接口，否则请注释掉测试新浪微博</span> oks<span class="token punctuation">.</span><span class="token function">setImageUrl</span><span class="token punctuation">(</span><span class="token string">"http://f1.sharesdk.cn/imgs/2014/02/26/owWpLZo_638x960.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// imagePath是图片的本地路径，Linked-In以外的平台都支持此参数</span> <span class="token comment" spellcheck="true">//oks.setImagePath("/sdcard/test.jpg");//确保SDcard下面存在此张图片</span> <span class="token comment" spellcheck="true">// url仅在微信（包括好友和朋友圈）中使用</span> oks<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">"http://sharesdk.cn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// comment是我对这条分享的评论，仅在人人网和QQ空间使用</span> oks<span class="token punctuation">.</span><span class="token function">setComment</span><span class="token punctuation">(</span><span class="token string">"我是测试评论文本"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// site是分享此内容的网站名称，仅在QQ空间使用</span> oks<span class="token punctuation">.</span><span class="token function">setSite</span><span class="token punctuation">(</span><span class="token string">"ShareSDK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// siteUrl是分享此内容的网站地址，仅在QQ空间使用</span> oks<span class="token punctuation">.</span><span class="token function">setSiteUrl</span><span class="token punctuation">(</span><span class="token string">"http://sharesdk.cn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 启动分享GUI</span> oks<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>效果如下：<br><img src="10.jpg" alt></p><p>Demo下载地址：<a href="https://github.com/wildma/ShareSDKThirdPartyShareLogin" target="_blank" rel="noopener">https://github.com/wildma/ShareSDKThirdPartyShareLogin</a></p><p><strong>如果对你有帮助记得点赞，star支持下哈~</strong></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
          <category> 第三方集成 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ShareSDK </tag>
            
            <tag> 第三方分享 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android 使用 OkHttp 请求自签名的 HTTPS 网站</title>
      <link href="/okhttp-self-signature-https/"/>
      <url>/okhttp-self-signature-https/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>很多公司考虑到安全问题，项目中都采用https加密协议进行数据传输。但是一些公司又不想花一笔钱去CA申请证书，所以就采用自签名的证书。</p><p>OkHttp默认是可以访问通过CA认证的HTTPS链接，例如百度首页也是https链接（<a href="https://www.baidu.com/）。" target="_blank" rel="noopener">https://www.baidu.com/）。</a> 但是如果是你们公司自签名(即自己用keytool生成的证书，而不是采用通过CA认证的证书)的服务器，OkHttp是无法访问的，例如访问12306网站（<a href="https://kyfw.12306.cn/otn/）" target="_blank" rel="noopener">https://kyfw.12306.cn/otn/）</a> ，会报如下错误：<br><img src="1.jpg" alt></p><h2 id="一、HTTPS的工作原理"><a href="#一、HTTPS的工作原理" class="headerlink" title="一、HTTPS的工作原理"></a>一、HTTPS的工作原理</h2><p>HTTPS在传输数据之前需要客户端（浏览器）与服务端（网站）之间进行一次握手，在握手过程中将确立双方加密传输数据的密码信息。握手过程的简单描述如下：</p><ol><li>浏览器将自己支持的一套加密算法、HASH算法发送给网站。</li><li>网站从中选出一组加密算法与HASH算法，并将自己的身份信息以证书的形式发回给浏览器。证书里面包含了网站地址，加密公钥，以及证书的颁发机构等信息。</li><li>浏览器获得网站证书之后，开始验证证书的合法性，如果证书信任，则生成一串随机数字作为通讯过程中对称加密的秘钥。然后取出证书中的公钥，将这串数字以及HASH的结果进行加密，然后发给网站。</li><li>网站接收浏览器发来的数据之后，通过私钥进行解密，然后HASH校验，如果一致，则使用浏览器发来的数字串使加密一段握手消息发给浏览器。</li><li>浏览器解密，并HASH校验，没有问题，则握手结束。接下来的传输过程将由之前浏览器生成的随机密码并利用对称加密算法进行加密。</li></ol><p>握手过程中如果有任何错误，都会使加密连接断开，从而阻止了隐私信息的传输。</p><h2 id="二、使用OKHTTP请求自签名的https服务器数据"><a href="#二、使用OKHTTP请求自签名的https服务器数据" class="headerlink" title="二、使用OKHTTP请求自签名的https服务器数据"></a>二、使用OKHTTP请求自签名的https服务器数据</h2><p><strong>以下我们使用12306网站为例</strong></p><p>（1） 首先去12306网站首页下载证书 <a href="http://www.12306.cn/" target="_blank" rel="noopener">http://www.12306.cn/</a><br><img src="2.jpg" alt></p><p>（2） 将下载的证书srca.cer放到工程的assets文件夹下。<br><img src="3.jpg" alt></p><p>（3） 添加HTTPS工具类</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Context<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>InputStream<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>GeneralSecurityException<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>KeyStore<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>cert<span class="token punctuation">.</span>Certificate<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>cert<span class="token punctuation">.</span>CertificateFactory<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Collection<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>KeyManagerFactory<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>SSLContext<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>SSLSocketFactory<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>TrustManager<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>TrustManagerFactory<span class="token punctuation">;</span><span class="token keyword">import</span> javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>X509TrustManager<span class="token punctuation">;</span><span class="token keyword">import</span> okhttp3<span class="token punctuation">.</span>OkHttpClient<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HTTPSUtils</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> OkHttpClient client<span class="token punctuation">;</span>    <span class="token keyword">public</span> Context mContext<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 获取OkHttpClient实例     * @return     */</span>    <span class="token keyword">public</span> OkHttpClient <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> client<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 初始化HTTPS,添加信任证书     * @param context     */</span>    <span class="token keyword">public</span> <span class="token function">HTTPSUtils</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>        X509TrustManager trustManager<span class="token punctuation">;</span>        SSLSocketFactory sslSocketFactory<span class="token punctuation">;</span>        <span class="token keyword">final</span> InputStream inputStream<span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            inputStream <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"srca.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 得到证书的输入流</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                trustManager <span class="token operator">=</span> <span class="token function">trustManagerForCertificates</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//以流的方式读入证书</span>                SSLContext sslContext <span class="token operator">=</span> SSLContext<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"TLS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                sslContext<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TrustManager</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>trustManager<span class="token punctuation">}</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>                sslSocketFactory <span class="token operator">=</span> sslContext<span class="token punctuation">.</span><span class="token function">getSocketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">GeneralSecurityException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OkHttpClient<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">sslSocketFactory</span><span class="token punctuation">(</span>sslSocketFactory<span class="token punctuation">,</span> trustManager<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 以流的方式添加信任证书     */</span>    <span class="token comment" spellcheck="true">/**     * Returns a trust manager that trusts {@code certificates} and none other. HTTPS services whose     * certificates have not been signed by these certificates will fail with a {@code     * SSLHandshakeException}.     * &lt;p>     * &lt;p>This can be used to replace the host platform's built-in trusted certificates with a custom     * set. This is useful in development where certificate authority-trusted certificates aren't     * available. Or in production, to avoid reliance on third-party certificate authorities.     * &lt;p>     * &lt;p>     * &lt;h3>Warning: Customizing Trusted Certificates is Dangerous!&lt;/h3>     * &lt;p>     * &lt;p>Relying on your own trusted certificates limits your server team's ability to update their     * TLS certificates. By installing a specific set of trusted certificates, you take on additional     * operational complexity and limit your ability to migrate between certificate authorities. Do     * not use custom trusted certificates in production without the blessing of your server's TLS     * administrator.     */</span>    <span class="token keyword">private</span> X509TrustManager <span class="token function">trustManagerForCertificates</span><span class="token punctuation">(</span>InputStream in<span class="token punctuation">)</span>            <span class="token keyword">throws</span> GeneralSecurityException <span class="token punctuation">{</span>        CertificateFactory certificateFactory <span class="token operator">=</span> CertificateFactory<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"X.509"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Collection<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Certificate</span><span class="token operator">></span> certificates <span class="token operator">=</span> certificateFactory<span class="token punctuation">.</span><span class="token function">generateCertificates</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>certificates<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"expected non-empty set of trusted certificates"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// Put the certificates a key store.</span>        <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> password <span class="token operator">=</span> <span class="token string">"password"</span><span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Any password will work.</span>        KeyStore keyStore <span class="token operator">=</span> <span class="token function">newEmptyKeyStore</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>Certificate certificate <span class="token operator">:</span> certificates<span class="token punctuation">)</span> <span class="token punctuation">{</span>            String certificateAlias <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>index<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            keyStore<span class="token punctuation">.</span><span class="token function">setCertificateEntry</span><span class="token punctuation">(</span>certificateAlias<span class="token punctuation">,</span> certificate<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// Use it to build an X509 trust manager.</span>        KeyManagerFactory keyManagerFactory <span class="token operator">=</span> KeyManagerFactory<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>                KeyManagerFactory<span class="token punctuation">.</span><span class="token function">getDefaultAlgorithm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        keyManagerFactory<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>keyStore<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>        TrustManagerFactory trustManagerFactory <span class="token operator">=</span> TrustManagerFactory<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>                TrustManagerFactory<span class="token punctuation">.</span><span class="token function">getDefaultAlgorithm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        trustManagerFactory<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>keyStore<span class="token punctuation">)</span><span class="token punctuation">;</span>        TrustManager<span class="token punctuation">[</span><span class="token punctuation">]</span> trustManagers <span class="token operator">=</span> trustManagerFactory<span class="token punctuation">.</span><span class="token function">getTrustManagers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>trustManagers<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>trustManagers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">X509TrustManager</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Unexpected default trust managers:"</span>                    <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>trustManagers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>X509TrustManager<span class="token punctuation">)</span> trustManagers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 添加password     * @param password     * @return     * @throws GeneralSecurityException     */</span>    <span class="token keyword">private</span> KeyStore <span class="token function">newEmptyKeyStore</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> password<span class="token punctuation">)</span> <span class="token keyword">throws</span> GeneralSecurityException <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            KeyStore keyStore <span class="token operator">=</span> KeyStore<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>KeyStore<span class="token punctuation">.</span><span class="token function">getDefaultType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 这里添加自定义的密码，默认</span>            InputStream in <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// By convention, 'null' creates an empty key store.</span>            keyStore<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> keyStore<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（4）  代码中请求</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getHttpsHtml</span><span class="token punctuation">(</span>View view<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Request request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">"https://kyfw.12306.cn/otn/"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        HTTPSUtils httpsUtils <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HTTPSUtils</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        httpsUtils<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailure</span><span class="token punctuation">(</span>Call call<span class="token punctuation">,</span> IOException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------------onFailure--------------"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResponse</span><span class="token punctuation">(</span>Call call<span class="token punctuation">,</span> Response response<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------------onResponse--------------"</span> <span class="token operator">+</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（5） 最后能打印出这些信息就说明请求成功啦！<br><img src="4.jpg" alt></p><p><strong>注意：别忘了加权限和依赖okhttp库</strong></p><p>Demo地址：<a href="https://github.com/wildma/okhttps" target="_blank" rel="noopener">https://github.com/wildma/okhttps</a><br>参考博客：<a href="http://blog.csdn.Net/lmj623565791/article/details/48129405" target="_blank" rel="noopener">http://blog.csdn.Net/lmj623565791/article/details/48129405</a></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
          <category> 网络编程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OkHttp </tag>
            
            <tag> 自签名 HTTPS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android 接入多盟广告 SDK--让你的 APP 通过广告平台赚钱</title>
      <link href="/domob-advertisement-sdk/"/>
      <url>/domob-advertisement-sdk/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>个人开发者可以通过在自己的APP里面嵌入广告,用户下载你的APP,点击了你APP里的广告，您就可以在多盟平台获得相应的收益。如果是公司,那就不是为了赚那么点钱了，主要是为了与用户有更多的互动,就想着在应用里面嵌入广告。我们公司的场景是这样的: 用户点击广告-我们给用户虚拟金币-用户获取虚拟金币又可以在我们的APP的商场里面买东西的时候来抵扣现金。<br>广告平台有很多，常见的有多盟，有米、点金、百度、谷歌的admob等等。自己选择，我们公司选择的是多盟平台,下面就说说怎么集成(主要讲的是其中一种广告-激励视频, 其他类似)。<br>（集成比较简单，按着Demo就能搞定了，这里主要讲的是应用场景）</p><p>广告效果如下，是一段小视频：<br><img src="1.jpg" alt><br><img src="2.jpg" alt></p><h2 id="集成"><a href="#集成" class="headerlink" title="集成"></a>集成</h2><p>注意：不想看代码直接下载我的Demo源码，直接运行即可. 如果想测试你自己申请的Publisher ID,换上你自己在多盟开放平台申请的Publisher ID即可运行起来。<br>源码地址：<a href="https://github.com/wildma/DomobVideoDemo" target="_blank" rel="noopener">https://github.com/wildma/DomobVideoDemo</a></p><p>（1）在多盟平台: <a href="http://www.domob.cn/" target="_blank" rel="noopener">http://www.domob.cn/</a> 注册账号–创建应用–获取Publisher ID<br>（2）下载SDK: <a href="http://www.domob.cn/developers/SDKdownload.htm" target="_blank" rel="noopener">http://www.domob.cn/developers/SDKdownload.htm</a><br>（3）AndroidStudio关联domob-video-sdk-1.0.8.jar<br>（4）在清单文件中注册以下信息</p><p>注册权限：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.INTERNET"</span><span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.WRITE_EXTERNAL_STORAGE"</span><span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.READ_EXTERNAL_STORAGE"</span><span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.ACCESS_NETWORK_STATE"</span><span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.ACCESS_WIFI_STATE"</span><span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.READ_PHONE_STATE"</span><span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.CHANGE_CONFIGURATION"</span><span class="token operator">/</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注册组件和Publisher ID：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span>activity android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"com.pad.android_independent_video_sdk.view.IndependentVideoActivity"</span>        android<span class="token operator">:</span>theme<span class="token operator">=</span><span class="token string">"@android:style/Theme.Black.NoTitleBar.Fullscreen"</span>        android<span class="token operator">:</span>configChanges<span class="token operator">=</span><span class="token string">"orientation|keyboard|screenSize|screenLayout"</span><span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>service android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"com.pad.android_independent_video_sdk.IndependentService"</span><span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>meta<span class="token operator">-</span>data android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"PUBLISH_ID"</span> android<span class="token operator">:</span>value<span class="token operator">=</span><span class="token string">"你申请的Publisher ID"</span><span class="token operator">/</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（5）api使用介绍<br>初始化：</p><pre class="line-numbers language-java"><code class="language-java">IndependentVideoManager<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//初始化</span>IndependentVideoManager<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">updateUserID</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span>userid<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//设置用户唯一标示，不是媒体id，是开发者用户体系中，用户的唯一标示，没有，则可以不设置。</span>IndependentVideoManager<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disableShowAlert</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//是否使用多盟提示框，提示完成任务，默认为true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>监听视频状态：</p><pre class="line-numbers language-java"><code class="language-java">IndependentVideoManager<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addIndependentVideoListener</span><span class="token punctuation">(</span>independentVideoListener<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//传入IndependentVideoListener的实例</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>IndependentVideoListener的回调方法如下：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">videoDidStartLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//视频开始加载</span><span class="token keyword">void</span> <span class="token function">videoDidFinishLoad</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//视频是否加载完成</span><span class="token keyword">void</span> <span class="token function">videoDidLoadError</span><span class="token punctuation">(</span>String var1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//视频加载失败</span><span class="token keyword">void</span> <span class="token function">videoDidClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//视频关闭</span><span class="token keyword">void</span> <span class="token function">videoCompletePlay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//视频播放完成</span><span class="token keyword">void</span> <span class="token function">videoPlayError</span><span class="token punctuation">(</span>String var1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//视频播放出错</span><span class="token keyword">void</span> <span class="token function">videoWillPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//视频开始播放</span><span class="token keyword">void</span> <span class="token function">videoVailable</span><span class="token punctuation">(</span>IndependentVideoAvailableState var1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//检查视频是否可用</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>IndependentVideoAvailableState有三个状态：</p><pre class="line-numbers language-java"><code class="language-java">VideoStateDownloading 视频正在下载中VideoStateFinishedCache 有可播视频缓存VideoStateNoExist 没有可播视频缓存<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>检查视频：<br>检查是否有可播视频缓存，IndependentVideoListener.videoVailable返回检查状态</p><pre class="line-numbers language-java"><code class="language-java"> IndependentVideoManager<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkVideoAvailable</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>播放视频：</p><pre class="line-numbers language-java"><code class="language-java">IndependentVideoManager<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">presentIndependentVideo</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>释放资源：<br>移除添加的监听，如在Activity的onDestroy生命周期方法中执行</p><pre class="line-numbers language-java"><code class="language-java">IndependentVideoManager<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeIndependentVideoListener</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>大功告成！Android 接入多盟广告就是这么简单！赶紧去赚钱吧！</p><p>注意：不想看代码直接下载我的Demo源码，直接运行即可. 如果想测试你自己申请的Publisher ID,换上你自己在多盟开放平台申请的Publisher ID即可运行起来。<br>源码地址：<a href="https://github.com/wildma/DomobVideoDemo" target="_blank" rel="noopener">https://github.com/wildma/DomobVideoDemo</a><br>如果对你有帮助记得点赞，star哈~</p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
          <category> 第三方集成 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 多盟 </tag>
            
            <tag> domob </tag>
            
            <tag> 接入广告SDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Glide 中 centerCrop() 与 transform() 共用问题(包括 4.0.0 以上解决方法)</title>
      <link href="/glide-centercrop-transform/"/>
      <url>/glide-centercrop-transform/</url>
      
        <content type="html"><![CDATA[<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>当我们在显示一张图片的时候，想让他等比例缩放到ImageView的大小，又想这张图片实现矩形圆角。</p><p>我们一开始会想到这么设置：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GlideRoundImage</span><span class="token punctuation">(</span><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">centerCrop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>But，这样设置后，图片只有centerCrop效果,却没有矩形圆角效果。如图：<br><img src="1.jpg" alt></p><p>但是这并不是我们想要的效果，然后会想着去掉centerCrop看看是怎样的：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GlideRoundImage</span><span class="token punctuation">(</span><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>结果却是这样的，没错！ 图片并没有按比例缩放.。如图：<br><img src="2.jpg" alt></p><h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>看centerCrop()方法的源码可知，也是需要调用transform()方法的。所以前后共用CenterCrop会覆盖掉GlideRoundImage的效果。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> BitmapRequestBuilder<span class="token operator">&lt;</span>ModelType<span class="token punctuation">,</span> TranscodeType<span class="token operator">></span> <span class="token function">centerCrop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">transform</span><span class="token punctuation">(</span>glide<span class="token punctuation">.</span><span class="token function">getBitmapCenterCrop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><pre class="line-numbers language-java"><code class="language-java"><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CenterCrop</span><span class="token punctuation">(</span><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">GlideRoundImage</span><span class="token punctuation">(</span><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>2个效果同时放在transform里面就可以解决问题了，效果图：<br><img src="3.jpg" alt></p><h2 id="Glide-4-0-0以上解决方法"><a href="#Glide-4-0-0以上解决方法" class="headerlink" title="Glide 4.0.0以上解决方法"></a>Glide 4.0.0以上解决方法</h2><p>将圆角矩形GlideRoundImage中的transform方法改成如下即可，意思就是先将bitmap转换成带centerCrop属性的bitmap，然后再转换成圆角。如下：</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> Bitmap <span class="token function">transform</span><span class="token punctuation">(</span>BitmapPool pool<span class="token punctuation">,</span> Bitmap toTransform<span class="token punctuation">,</span> <span class="token keyword">int</span> outWidth<span class="token punctuation">,</span> <span class="token keyword">int</span> outHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Bitmap bitmap <span class="token operator">=</span> TransformationUtils<span class="token punctuation">.</span><span class="token function">centerCrop</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span> toTransform<span class="token punctuation">,</span> outWidth<span class="token punctuation">,</span> outHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">roundCrop</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span> bitmap<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码中使用：</p><pre class="line-numbers language-java"><code class="language-java">        RequestOptions myOptions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GlideRoundImage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>imgUrl<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>myOptions<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>mIv_img<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>附上矩形圆角的代码: <a href="https://github.com/wildma/GlideRoundImage" target="_blank" rel="noopener">https://github.com/wildma/GlideRoundImage</a></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
          <category> 问题记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Glide </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dagger2 使用——结合 MVP 模式讲解</title>
      <link href="/dagger2/"/>
      <url>/dagger2/</url>
      
        <content type="html"><![CDATA[<blockquote><p>更新：根据Dagger2官方最新配置，现在配置已经不需要添加android-apt插件了，所以配置更简单了。即在下文中说的Dagger2配置的第一步与第二步都可以省略了，第三步直接改成以下即可）。</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/*dagger2的配置*/</span>    annotationProcessor <span class="token string">'com.google.dagger:dagger-compiler:2.4'</span>    compile <span class="token string">'com.google.dagger:dagger:2.4'</span>    compile <span class="token string">'org.glassfish:javax.annotation:10.0-b28'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>相信大部分人在使用mvp模式的时候都会同时用到Dagger2框架，因为Dagger2能非常完美的解决mvp模式中存在的V层与P层之间的耦合。所以下面介绍Dagger2的使用也会结合我上一篇文章中的mvp模式来讲解，还没看上一篇文章的可以先去看看—— <a href="https://wildma.github.io/mvc-mvp/">带你通俗易懂的理解——Android中的MVC与MVP</a>。</p><h2 id="一、Dagger2是什么？"><a href="#一、Dagger2是什么？" class="headerlink" title="一、Dagger2是什么？"></a>一、Dagger2是什么？</h2><p>Dagger2是一个在Android 和 Java中使用的依赖注入框架，现在由Google维护，是基于Dagger的基础上开发的，Dagger是由square开发的。Dagger2最大的作用就是解耦，例如ClassA中需要用到ClassB中的某个方法，但是又不想在ClassA中通过new的方式实例化ClassB，这时候Dagger2就很好的解决了这个问题，Dagger2可以在ClassA中通过依赖注入的方式实例化ClassB，从而达到ClassA与ClassB的解耦。</p><h2 id="二、Dagger2配置"><a href="#二、Dagger2配置" class="headerlink" title="二、Dagger2配置"></a>二、Dagger2配置</h2><p>（1）在项目的build.gradle中添加android-apt插件</p><pre class="line-numbers language-java"><code class="language-java">buildscript <span class="token punctuation">{</span>    repositories <span class="token punctuation">{</span>        <span class="token function">jcenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    dependencies <span class="token punctuation">{</span>        classpath <span class="token string">'com.android.tools.build:gradle:2.2.3'</span>        <span class="token comment" spellcheck="true">//android-apt 插件</span>        classpath <span class="token string">'com.neenbedankt.gradle.plugins:android-apt:1.8'</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（2）在app的build.gradle中添加apt插件的使用</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//apt插件的使用</span>apply plugin<span class="token operator">:</span> <span class="token string">'com.neenbedankt.android-apt'</span>android <span class="token punctuation">{</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>dependencies <span class="token punctuation">{</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（3）在app的build.gradle中添加Dagger2的依赖</p><pre class="line-numbers language-java"><code class="language-java"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>android <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>dependencies <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//dagger2的配置</span>    compile <span class="token string">'com.google.dagger:dagger:2.4'</span>    apt <span class="token string">'com.google.dagger:dagger-compiler:2.4'</span>    compile <span class="token string">'org.glassfish:javax.annotation:10.0-b28'</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="三、Dagger2使用"><a href="#三、Dagger2使用" class="headerlink" title="三、Dagger2使用"></a>三、Dagger2使用</h2><p>经过上面的配置就可以在项目中使用Dagger2了，这里举的例子是基于我上篇mvp文章的基础上的，还没看上一篇文章的可以先去看看—— <a href="https://wildma.github.io/mvc-mvp/">带你通俗易懂的理解——Android中的MVC与MVP</a>。该Demo中V层中的Activity如下：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfoActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token keyword">implements</span> <span class="token class-name">UserInfoView</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> TextView    mTvName<span class="token punctuation">;</span>    <span class="token keyword">private</span> ProgressBar mPbLoading<span class="token punctuation">;</span>    UserInfoPresenter mUserInfoPresenter<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//find view</span>        mTvName <span class="token operator">=</span> <span class="token punctuation">(</span>TextView<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>tv_name<span class="token punctuation">)</span><span class="token punctuation">;</span>        mPbLoading <span class="token operator">=</span> <span class="token punctuation">(</span>ProgressBar<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>pb_loading<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//init</span>        mUserInfoPresenter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserInfoPresenter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也就是Activity中使用new的方式实例化Presenter，这样就导致V层与P层耦合了，所以下面我就使用Dagger2将它们解耦。</p><p>先看看几个注解的概念：</p><ul><li><p>Module：在这里实例化目标类（例子中就是UserInfoActivity类）需要依赖的对象。</p></li><li><p>Provides：标注一个方法，该方法是用来提供实例化对象给目标类的。</p></li><li><p>Inject：标注实例化对象</p></li><li><p>Component：作为Module与目标类之间的桥梁。</p></li></ul><p>使用步骤：<br>（1）创建带有@Module注解的类，并利用@Provides标注一个方法用来提供实例化对象给目标类。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Module</span> <span class="token comment" spellcheck="true">//实例化目标类需要依赖的对象</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfoActivityModule</span> <span class="token punctuation">{</span>    UserInfoActivity mActivity<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">UserInfoActivityModule</span><span class="token punctuation">(</span>UserInfoActivity activity<span class="token punctuation">)</span> <span class="token punctuation">{</span>        mActivity <span class="token operator">=</span> activity<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Provides</span> <span class="token comment" spellcheck="true">//该方法是用来提供实例化对象给目标类的</span>    UserInfoPresenter <span class="token function">provideUserInfoPresenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserInfoPresenter</span><span class="token punctuation">(</span>mActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（2）创建带有@Component的接口，将它作为Module与目标类之间的桥梁。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span>modules <span class="token operator">=</span> UserInfoActivityModule<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//作为Module与目标类之间的桥梁</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserInfoActivityComponent</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 定义注入的方法     * @param activity     */</span>    <span class="token keyword">void</span> <span class="token function">inject</span><span class="token punctuation">(</span>UserInfoActivity activity<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（3）标注实例化对象，并将Module与目标类联系起来。<br>注意：DaggerUserInfoActivityComponent是Rebuild项目后根据定义的Component的类名自动生成的，所以这里先要Rebuild一下项目再使用。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfoActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token keyword">implements</span> <span class="token class-name">UserInfoView</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Inject</span> <span class="token comment" spellcheck="true">//标注实例化对象</span>    UserInfoPresenter mUserInfoPresenter<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token comment" spellcheck="true">//将Module与目标类联系起来</span>        DaggerUserInfoActivityComponent                <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">userInfoActivityModule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserInfoActivityModule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">inject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过上面的三步其实就只实现了UserInfoActivityModule = new UserInfoActivityModule(this)，看起来是复杂了许多，但是它非常完美的解决了mvp模式中存在的V层与P层之间的耦合。就好比使用mvp比使用mvc多了很多代码，但大家还是会使用mvp模式一样的道理。</p><p>Demo地址：<a href="https://github.com/wildma/MVP-Pattern" target="_blank" rel="noopener">MVP-Pattern</a></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Dagger2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>带你通俗易懂的理解——Android 中的 MVC 与 MVP</title>
      <link href="/mvc-mvp/"/>
      <url>/mvc-mvp/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>首先介绍一下所谓的MVP，美国职业篮球联赛最有价值球员奖（National Basketball Association Most Valuable Player Award ，简称MVP）是一个自1955-1956赛季以来每年对美国职业篮球联赛（NBA）常规赛中全场表现最佳的球员所颁发的一个奖项。<br><img src="1.jpg" alt></p><p>哎呀！不好意思，讲错了！<br>言归正传，作为一个Android攻城狮（虽然也是一位篮球爱好者），这里要介绍的MVP当然是一种软件设计模式啦！下面进入正题！</p><h2 id="一、MVC"><a href="#一、MVC" class="headerlink" title="一、MVC"></a>一、MVC</h2><ul><li><p><strong>概念</strong>：MVC全称为Model-View-Controller，也就是 模型-视图-控制器。是最常见的一种软件设计模式。<br>Model：对应Android中的数据实体模型、数据访问接口、数据库操作等，用于存取数据和处理业务逻辑。<br>View：对应Android中的布局文件，用来展示UI。<br>Controller：对应Android中的Activity、Fragment等，用于更新UI界面与数据。</p></li><li><p><strong>它们之间的关系图如下</strong>：<br><img src="2.jpg" alt></p></li></ul><p>MVC的工作原理是用户在View层触发事件，Controller层接收到View层的事件后就会更新Model层数据，Model层数据改变后就通知Controller层更新UI。（View层也可以直接更新Model层的数据）</p><p>从MVC的关系图与工作原理可知，View层一般只能显示静态的布局，例如想动态的去隐藏或者显示某个UI都要Activity去操作，而Activity是属于Controller层的，这样就造成了Activity既像View又像Controller，而且View层和Model层是相互耦合的。所以我们在使用MVC写比较复杂的界面的时候，Activity中上千行代码是常有的事。随之带来的就是测试与维护的困难。当你入职新公司接手一个这样的MVC项目就能体会到这种痛苦了。所以也就有了之后的MVP、MVVM。</p><h2 id="二、MVP"><a href="#二、MVP" class="headerlink" title="二、MVP"></a>二、MVP</h2><ul><li><p><strong>概念</strong>：MVP全称为Model-View-Presenter，也就是 模型-视图-表示器。是MVC模式的演化版。<br>Model：与MVC一样，对应Android中的数据实体模型、数据访问接口、数据库操作等，用于存取数据和处理业务逻辑。<br>View：对应Android中的Activity、Fragment等，用来展示UI、与用户进行交互。<br>Presenter：充当Model和View之间的桥梁，负责它们之间的交互。</p></li><li><p><strong>它们之间的关系图如下</strong>：<br><img src="3.jpg" alt></p></li></ul><p>由上图可以明显的看到Model与View之间的交互由Presenter完成，即View与Model是完全解耦的。而View与Presenter的交互也不是直接交互的，而是通过接口来完成。随之带来的好处：</p><ul><li>解耦了Model与View，简化了Activity中的代码，方便维护。</li><li>将复杂的逻辑代码提取到了Presenter中，方便单元测试。</li></ul><h2 id="三、实践出真理"><a href="#三、实践出真理" class="headerlink" title="三、实践出真理"></a>三、实践出真理</h2><p>好了，说了这么多，相信大部分人还是一脸懵逼！那就让我来举个例子吧！保证能让你通俗易懂的理解MVC与MVP。<br><img src="4.jpg" alt></p><p>举得例子非常简单，主要为了让大家更容易理解。<br>点击按钮，发起网络请求获取用户信息，然后直接显示在界面。效果图如下：<br><img src="5.gif" alt></p><h3 id="3-1-MVC-代码实现"><a href="#3-1-MVC-代码实现" class="headerlink" title="3.1 MVC 代码实现"></a>3.1 MVC 代码实现</h3><p>工程结构图如下：<br><img src="6.png" alt></p><h4 id="3-1-1-Model层"><a href="#3-1-1-Model层" class="headerlink" title="3.1.1 Model层"></a>3.1.1 Model层</h4><ul><li><p><strong>UserInfobean：</strong> 数据实体模型，也就是网络请求回来的数据存储到这里。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfobean</span> <span class="token punctuation">{</span>  <span class="token keyword">private</span> String name<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//用户昵称</span>  <span class="token keyword">public</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> name<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>RequestBiz：</strong> 请求业务接口，里面只有一个请求数据的方法。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RequestBiz</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">/**   * 请求数据   *   * @param listener 成功或失败的回调接口   */</span>  <span class="token keyword">void</span> <span class="token function">requestData</span><span class="token punctuation">(</span>OnRequestListener listener<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>RequestBizIml：</strong> 请求业务接口的实现类，里面业务主要是开启子线程休眠2秒来模拟网络请求，请求成功后填充数据到UserInfobean，并通过接口将成功或失败回调出去。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RequestBizIml</span> <span class="token keyword">implements</span> <span class="token class-name">RequestBiz</span> <span class="token punctuation">{</span>  <span class="token annotation punctuation">@Override</span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">requestData</span><span class="token punctuation">(</span><span class="token keyword">final</span> OnRequestListener listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment" spellcheck="true">/**       * 开启子线程休眠2秒来模拟网络请求，请求成功后填充数据到UserInfobean，并通过接口将成功或失败回调出去       */</span>      <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token keyword">try</span> <span class="token punctuation">{</span>                  Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  UserInfobean userInfobean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserInfobean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  userInfobean<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"wildma"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token keyword">boolean</span> isRequestSuccess <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//模拟请求是否成功</span>                  <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>                      <span class="token keyword">if</span> <span class="token punctuation">(</span>isRequestSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>                          listener<span class="token punctuation">.</span><span class="token function">onSuccess</span><span class="token punctuation">(</span>userInfobean<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                          listener<span class="token punctuation">.</span><span class="token function">onFailed</span><span class="token punctuation">(</span><span class="token string">"服务器繁忙，请稍后再试！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token punctuation">}</span>                  <span class="token punctuation">}</span>              <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                  e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token punctuation">}</span>          <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>OnRequestListener：</strong> 请求成功或失败的回调接口。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OnRequestListener</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">/**   * 请求成功回调   *   * @param data 服务器返回的数据   */</span>  <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span>Object data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/**   * 请求失败回调   *   * @param failReason 失败原因   */</span>  <span class="token keyword">void</span> <span class="token function">onFailed</span><span class="token punctuation">(</span>String failReason<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="3-1-2-View层"><a href="#3-1-2-View层" class="headerlink" title="3.1.2 View层"></a>3.1.2 View层</h4><p>就是布局文件activity_main，很简单，一个Button用来获取网络数据，一个TextView用来显示数据，一个ProgressBar是加载等待圈。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token operator">?</span><span class="token operator">></span><span class="token operator">&lt;</span>RelativeLayout  android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/activity_main"</span>  xmlns<span class="token operator">:</span>android<span class="token operator">=</span><span class="token string">"http://schemas.android.com/apk/res/android"</span>  xmlns<span class="token operator">:</span>tools<span class="token operator">=</span><span class="token string">"http://schemas.android.com/tools"</span>  android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"match_parent"</span>  android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"match_parent"</span>  android<span class="token operator">:</span>paddingBottom<span class="token operator">=</span><span class="token string">"@dimen/activity_vertical_margin"</span>  android<span class="token operator">:</span>paddingLeft<span class="token operator">=</span><span class="token string">"@dimen/activity_horizontal_margin"</span>  android<span class="token operator">:</span>paddingRight<span class="token operator">=</span><span class="token string">"@dimen/activity_horizontal_margin"</span>  android<span class="token operator">:</span>paddingTop<span class="token operator">=</span><span class="token string">"@dimen/activity_vertical_margin"</span>  tools<span class="token operator">:</span>context<span class="token operator">=</span><span class="token string">"com.wildma.mvc.UserInfoActivity"</span><span class="token operator">></span>  <span class="token operator">&lt;</span>Button      android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/btn_get_data"</span>      android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"match_parent"</span>      android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"wrap_content"</span>      android<span class="token operator">:</span>layout_centerHorizontal<span class="token operator">=</span><span class="token string">"true"</span>      android<span class="token operator">:</span>onClick<span class="token operator">=</span><span class="token string">"getData"</span>      android<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string">"模拟网络请求数据"</span><span class="token operator">/</span><span class="token operator">></span>  <span class="token operator">&lt;</span>TextView      android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/tv_name"</span>      android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"wrap_content"</span>      android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"wrap_content"</span>      android<span class="token operator">:</span>layout_below<span class="token operator">=</span><span class="token string">"@id/btn_get_data"</span>      android<span class="token operator">:</span>layout_centerHorizontal<span class="token operator">=</span><span class="token string">"true"</span>      android<span class="token operator">:</span>layout_marginTop<span class="token operator">=</span><span class="token string">"12dp"</span>      android<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string">"我的昵称是："</span>      android<span class="token operator">:</span>textSize<span class="token operator">=</span><span class="token string">"25sp"</span><span class="token operator">/</span><span class="token operator">></span>  <span class="token operator">&lt;</span>ProgressBar      android<span class="token operator">:</span>id<span class="token operator">=</span><span class="token string">"@+id/pb_loading"</span>      android<span class="token operator">:</span>layout_width<span class="token operator">=</span><span class="token string">"60dp"</span>      android<span class="token operator">:</span>layout_height<span class="token operator">=</span><span class="token string">"60dp"</span>      android<span class="token operator">:</span>layout_centerInParent<span class="token operator">=</span><span class="token string">"true"</span>      android<span class="token operator">:</span>visibility<span class="token operator">=</span><span class="token string">"gone"</span><span class="token operator">/</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>RelativeLayout<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h4 id="3-1-3-Controller层"><a href="#3-1-3-Controller层" class="headerlink" title="3.1.3 Controller层"></a>3.1.3 Controller层</h4><p>Controller层对应UserInfoActivity，也是非常简单，主要是界面的初始化，点击按钮请求数据，请求到数据后更新界面。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfoActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> TextView      mTvName<span class="token punctuation">;</span>    <span class="token keyword">private</span> RequestBizIml mRequestBizIml<span class="token punctuation">;</span>    <span class="token keyword">private</span> ProgressBar   mPbLoading<span class="token punctuation">;</span>    <span class="token keyword">private</span> Handler       mHandler<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//find view</span>        mTvName <span class="token operator">=</span> <span class="token punctuation">(</span>TextView<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>tv_name<span class="token punctuation">)</span><span class="token punctuation">;</span>        mPbLoading <span class="token operator">=</span> <span class="token punctuation">(</span>ProgressBar<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>pb_loading<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//init</span>        mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        mRequestBizIml <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestBizIml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 获取数据按钮点击事件     *     * @param view     */</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getData</span><span class="token punctuation">(</span>View view<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">requestData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 请求数据     */</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">requestData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        mPbLoading<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>VISIBLE<span class="token punctuation">)</span><span class="token punctuation">;</span>        mRequestBizIml<span class="token punctuation">.</span><span class="token function">requestData</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OnRequestListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token keyword">final</span> Object data<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//因为请求开启了子线程，所以这里需要用UI线程去更新界面</span>                mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        mPbLoading<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>GONE<span class="token punctuation">)</span><span class="token punctuation">;</span>                        UserInfobean userInfobean <span class="token operator">=</span> <span class="token punctuation">(</span>UserInfobean<span class="token punctuation">)</span> data<span class="token punctuation">;</span>                        mTvName<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"我的昵称是："</span> <span class="token operator">+</span> userInfobean<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailed</span><span class="token punctuation">(</span><span class="token keyword">final</span> String failReason<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//因为请求开启了子线程，所以这里需要用UI线程去更新界面</span>                mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        mPbLoading<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>GONE<span class="token punctuation">)</span><span class="token punctuation">;</span>                        Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> failReason<span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>看完MVC的代码，相信你也发现了，ProgressBar的隐藏与显示，TextView显示用户的昵称这些逻辑其实都是属于View层的，但是都写在了Activity里面了，这就像我在前面说的Activity既像View又像Controller。复杂点的界面就造成Activity过于臃肿。</p><h3 id="3-2-MVP-代码实现"><a href="#3-2-MVP-代码实现" class="headerlink" title="3.2 MVP 代码实现"></a>3.2 MVP 代码实现</h3><p>工程结构图如下：<br><img src="7.png" alt></p><p>由结构图可知MVP就比MVC多了UserInfoPresenter与UserInfoView。</p><h4 id="3-2-1-Model层"><a href="#3-2-1-Model层" class="headerlink" title="3.2.1 Model层"></a>3.2.1 Model层</h4><p>前面说了，MVP中的Model层与MVC是一样的。所以代码也是一样的。这里就不列出来了，可以看上面的。</p><h4 id="3-2-2-View层"><a href="#3-2-2-View层" class="headerlink" title="3.2.2 View层"></a>3.2.2 View层</h4><p>MVP中的VIew层对应UserInfoActivity，但它不是直接与Presenter交互的，他们之间的交互是通过接口来实现的。所以这里需要先写一个接口，然后再让UserInfoActivity实现该接口。</p><ul><li><p><strong>UserInfoView：</strong> UserInfoActivity需要实现的接口，在这个接口我们就要定义UserInfoActivity需要实现的方法，分析UI图可知，我们这里需要如下几个方法：<br>showLoading：显示加载圈<br>hideLoading：隐藏加载圈<br>showName：显示昵称<br>showFailReason：显示失败原因<br>完整代码如下：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserInfoView</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">/**   * 显示加载圈   */</span>  <span class="token keyword">void</span> <span class="token function">showLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/**   * 隐藏加载圈   */</span>  <span class="token keyword">void</span> <span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/**   * 显示昵称   *   * @param name 昵称   */</span>  <span class="token keyword">void</span> <span class="token function">showName</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/**   * 显示失败原因   *   * @param failReason 失败原因   */</span>  <span class="token keyword">void</span> <span class="token function">showFailReason</span><span class="token punctuation">(</span>String failReason<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>UserInfoActivity：</strong> UserInfoView的实现类，主要就是实现UserInfoView的方法做出相应的UI变化。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfoActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token keyword">implements</span> <span class="token class-name">UserInfoView</span> <span class="token punctuation">{</span>  <span class="token keyword">private</span> TextView          mTvName<span class="token punctuation">;</span>  <span class="token keyword">private</span> ProgressBar       mPbLoading<span class="token punctuation">;</span>  <span class="token keyword">private</span> UserInfoPresenter mUserInfoPresenter<span class="token punctuation">;</span>  <span class="token annotation punctuation">@Override</span>  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//find view</span>      mTvName <span class="token operator">=</span> <span class="token punctuation">(</span>TextView<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>tv_name<span class="token punctuation">)</span><span class="token punctuation">;</span>      mPbLoading <span class="token operator">=</span> <span class="token punctuation">(</span>ProgressBar<span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>pb_loading<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//init</span>      mUserInfoPresenter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserInfoPresenter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * 获取数据按钮点击事件   *   * @param view   */</span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getData</span><span class="token punctuation">(</span>View view<span class="token punctuation">)</span> <span class="token punctuation">{</span>      mUserInfoPresenter<span class="token punctuation">.</span><span class="token function">requestData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token annotation punctuation">@Override</span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">showLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      mPbLoading<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>VISIBLE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token annotation punctuation">@Override</span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      mPbLoading<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span>View<span class="token punctuation">.</span>GONE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token annotation punctuation">@Override</span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">showName</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>      mTvName<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token annotation punctuation">@Override</span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">showFailReason</span><span class="token punctuation">(</span>String failReason<span class="token punctuation">)</span> <span class="token punctuation">{</span>      Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> failReason<span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，整个UserInfoActivity都没有涉及到Model层，而是通过UserInfoPresenter来间接交互。</p></li></ul><h4 id="3-2-3-Presenter层"><a href="#3-2-3-Presenter层" class="headerlink" title="3.2.3 Presenter层"></a>3.2.3 Presenter层</h4><ul><li><p><strong>UserInfoPresenter：</strong> UserInfoPresenter里的代码也就是MVC中Activity涉及到Model层相关的逻辑代码。因为Presenter充当Model和View之间的桥梁，所以需要在合适的时机调用UserInfoView接口对应的方法。又由于我们的Activity实现了这个接口，所以在UserInfoPresenter中调用UserInfoView中方法的同时，Activity中对应的方法也会执行。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfoPresenter</span> <span class="token punctuation">{</span>  <span class="token keyword">private</span> UserInfoView mUserInfoView<span class="token punctuation">;</span>  <span class="token keyword">private</span> RequestBiz   requestBiz<span class="token punctuation">;</span>  <span class="token keyword">private</span> Handler      mHandler<span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token function">UserInfoPresenter</span><span class="token punctuation">(</span>UserInfoView userInfoView<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>mUserInfoView <span class="token operator">=</span> userInfoView<span class="token punctuation">;</span>      requestBiz <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestBizIml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>Looper<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">/**   * 请求数据   */</span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">requestData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      mUserInfoView<span class="token punctuation">.</span><span class="token function">showLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      requestBiz<span class="token punctuation">.</span><span class="token function">requestData</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OnRequestListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token keyword">final</span> Object data<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token comment" spellcheck="true">//因为请求开启了子线程，所以这里需要用UI线程去更新界面</span>              mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                  <span class="token annotation punctuation">@Override</span>                  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                      mUserInfoView<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      UserInfobean userInfobean <span class="token operator">=</span> <span class="token punctuation">(</span>UserInfobean<span class="token punctuation">)</span> data<span class="token punctuation">;</span>                      mUserInfoView<span class="token punctuation">.</span><span class="token function">showName</span><span class="token punctuation">(</span><span class="token string">"我的昵称是："</span> <span class="token operator">+</span> userInfobean<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token punctuation">}</span>              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailed</span><span class="token punctuation">(</span><span class="token keyword">final</span> String failReason<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token comment" spellcheck="true">//因为请求开启了子线程，所以这里需要用UI线程去更新界面</span>              mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                  <span class="token annotation punctuation">@Override</span>                  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                      mUserInfoView<span class="token punctuation">.</span><span class="token function">hideLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                      mUserInfoView<span class="token punctuation">.</span><span class="token function">showFailReason</span><span class="token punctuation">(</span>failReason<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token punctuation">}</span>              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>看了MVP的代码，是不是觉得Activity特别简洁明了！整个Activity没有任何地方涉及到Model层相关的代码，这样就达到了Model与View层解耦的目的。而且将复杂的逻辑代码提取到了Presenter中，方便进行单元测试。</p><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>OK，MVC与MVP的讲解就到这里，看完上面的讲解能让你恍然大悟的请在文章下面点个赞，还是一脸懵逼的。。。不要来打我！再看多一遍呗~</p><p>Demo地址：<a href="https://github.com/wildma/MVP-Pattern" target="_blank" rel="noopener">MVP-Pattern</a></p><p>参考资料：<br><a href="http://konmik.com/post/introduction_to_model_view_presenter_on_android/" target="_blank" rel="noopener">http://konmik.com/post/introduction_to_model_view_presenter_on_android/</a><br><a href="http://blog.csdn.net/lmj623565791/article/details/46596109" target="_blank" rel="noopener">http://blog.csdn.net/lmj623565791/article/details/46596109</a><br><a href="http://www.jianshu.com/p/9a6845b26856" target="_blank" rel="noopener">http://www.jianshu.com/p/9a6845b26856</a></p>]]></content>
      
      
      <categories>
          
          <category> Android </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Android </tag>
            
            <tag> MVC </tag>
            
            <tag> MVP </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
