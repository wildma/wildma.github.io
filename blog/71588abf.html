<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 主流开源框架（六）Glide 的执行流程源码解析, Android 知识分享">
    <meta name="baidu-site-verification" content="FLsnLJ6eF1">
    <meta name="google-site-verification" content="16Gna8-Ho0L5gq5QusQ01kiKooeZUaUSmH--RyCrrro">
    <meta name="360-site-verification" content>
    <meta name="description" content="前言最近有个想法——就是把 Android 主流开源框架进行深入分析，然后写成一系列文章，包括该框架的详细使用与源码解析。目的是通过鉴赏大神的源码来了解框架底层的原理，也就是做到不仅要知其然，还要知其所以然。
这里我说下自己阅读源码的经验，">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 主流开源框架（六）Glide 的执行流程源码解析 | wildma的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?46e79e71af0709a5b9106bf20cecc493";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <span class="logo-span">wildma的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="https://wildma.github.io/blog/f1e2edad.html" class="waves-effect waves-light">
            
            <span>全部文章</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <div class="logo-name">wildma的博客</div>
        <div class="logo-desc">
            
            Android 知识分享
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="https://wildma.github.io/blog/f1e2edad.html" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                全部文章
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                友情链接
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                留言板
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/wildma" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/wildma" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/0.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 主流开源框架（六）Glide 的执行流程源码解析
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                        <a href="/tags/Glide/" target="_blank">
                            <span class="chip bg-color">Glide</span>
                        </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                        <a href="/categories/Android主流开源框架/" class="post-category" target="_blank">
                            Android主流开源框架
                        </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-05-10
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    wildma
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    11.4k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    54 分
                </div>
                
                

                
                <div id="busuanzi_container_page_pv" class="info-break-policy">
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>
                </div>
                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近有个想法——就是把 Android 主流开源框架进行深入分析，然后写成一系列文章，包括该框架的详细使用与源码解析。目的是通过鉴赏大神的源码来了解框架底层的原理，也就是做到不仅要知其然，还要知其所以然。</p>
<p>这里我说下自己阅读源码的经验，我一般都是按照平时使用某个框架或者某个系统源码的使用流程入手的，首先要知道怎么使用，然后再去深究每一步底层做了什么，用了哪些好的设计模式，为什么要这么设计。</p>
<p>系列文章：</p>
<ul>
<li><a href="https://wildma.github.io/blog/ec018646.html">Android 主流开源框架（一）OkHttp 铺垫-HttpClient 与 HttpURLConnection 使用详解</a></li>
<li><a href="https://wildma.github.io/blog/6d0008b.html">Android 主流开源框架（二）OkHttp 使用详解</a></li>
<li><a href="https://wildma.github.io/blog/d8540f1f.html">Android 主流开源框架（三）OkHttp 源码解析</a></li>
<li><a href="https://wildma.github.io/blog/df2af467.html">Android 主流开源框架（四）Retrofit 使用详解</a></li>
<li><a href="https://wildma.github.io/blog/a7a51ec3.html">Android 主流开源框架（五）Retrofit 源码解析</a></li>
<li><a href="https://wildma.github.io/blog/71588abf.html">Android 主流开源框架（六）Glide 的执行流程源码解析</a></li>
<li>更多框架持续更新中…</li>
</ul>
<p>更多干货请关注 <a href="https://github.com/wildma/AndroidNotes" target="_blank" rel="noopener">AndroidNotes</a></p>
<h2 id="一、Glide-的基本使用示例"><a href="#一、Glide-的基本使用示例" class="headerlink" title="一、Glide 的基本使用示例"></a>一、Glide 的基本使用示例</h2><p>Glide 是一个快速高效的 Android 图片加载库，也是 Google 官方推荐的图片加载库。多数情况下，使用 Glide 加载图片非常简单，一行代码就能解决。如下：</p>
<pre class="line-numbers language-java"><code class="language-java">Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这行代码用起来虽然简单，但是涉及到的三个方法 with()、load()、into() 的内部实现是比较复杂的，接下来我们就根据这三个方法进行源码阅读。这里没有单独用一篇文章来写 Glide 的使用，是因为官方文档已经非常详细了，看不懂<a href="https://bumptech.github.io/glide/" target="_blank" rel="noopener">英文</a>的可以直接看<a href="https://muyangmin.github.io/glide-docs-cn/" target="_blank" rel="noopener">中文</a>的。</p>
<h2 id="二、Glide-源码分析"><a href="#二、Glide-源码分析" class="headerlink" title="二、Glide 源码分析"></a>二、Glide 源码分析</h2><p>这篇文章主要分析 Glide 的执行流程，Glide 的缓存机制在下一篇文章中分析，这两篇都是使用最新的 4.11.0 版本来分析。</p>
<p>因为 Glide 默认是配置了内存与磁盘缓存的，所以这里我们先禁用内存和磁盘缓存。如下设置：</p>
<pre class="line-numbers language-java"><code class="language-java">Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">skipMemoryCache</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 禁用内存缓存</span>
        <span class="token punctuation">.</span><span class="token function">diskCacheStrategy</span><span class="token punctuation">(</span>DiskCacheStrategy<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 禁用磁盘缓存</span>
        <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>注意：后面的分析都是加了跳过缓存的，所以你在跟着本文分析的时候记得加上上面两句。</strong></p>
<h3 id="2-1-with"><a href="#2-1-with" class="headerlink" title="2.1 with()"></a>2.1 with()</h3><p>with() 的重载方法有 6 个：</p>
<ul>
<li>Glide#with(Context context)</li>
<li>Glide#with(Activity activity)</li>
<li>Glide#with(FragmentActivity activity)</li>
<li>Glide#with(Fragment fragment)</li>
<li>Glide#with(android.app.Fragment fragment)</li>
<li>Glide#with(View view)</li>
</ul>
<p>这些方法的参数可以分成两种情况，即 Application（Context）类型与非 Application（Activity、Fragment、View，这里的 View 获取的是它所属的 Activity 或 Fragment）类型，这些参数的作用是确定图片加载的生命周期。点击进去发现 6 个重载方法最终都会调用 getRetriever().get()，所以这里只拿 FragmentActivity 来演示：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*Glide*/</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> RequestManager <span class="token function">with</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> FragmentActivity activity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getRetriever</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="2-1-1-Glide-getRetriever"><a href="#2-1-1-Glide-getRetriever" class="headerlink" title="2.1.1 Glide#getRetriever()"></a>2.1.1 Glide#getRetriever()</h4><p>点击 getRetriever() 方法进去：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*Glide*/</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> RequestManagerRetriever <span class="token function">getRetriever</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> Glide<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequestManagerRetriever</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>继续看下 Glide#get(context)：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*Glide*/</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Glide <span class="token function">get</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>glide <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//（1）</span>
      GeneratedAppGlideModule annotationGeneratedModule <span class="token operator">=</span>
          <span class="token function">getAnnotationGeneratedGlideModules</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Glide<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>glide <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">//（2）</span>
          <span class="token function">checkAndInitializeGlide</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> annotationGeneratedModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> glide<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里使用了<a href="https://wildma.github.io/blog/364ea8cc.html#toc-heading-10">双重校验锁</a>的单例模式来获取 Glide 的实例，其中关注点（1）点击进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*Glide*/</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> GeneratedAppGlideModule <span class="token function">getAnnotationGeneratedGlideModules</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    GeneratedAppGlideModule result <span class="token operator">=</span> null<span class="token punctuation">;</span>
      Class<span class="token operator">&lt;</span>GeneratedAppGlideModule<span class="token operator">></span> clazz <span class="token operator">=</span>
          <span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>GeneratedAppGlideModule<span class="token operator">></span><span class="token punctuation">)</span>
              Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.bumptech.glide.GeneratedAppGlideModuleImpl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span>
 clazz<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该方法用来实例化我们用 @GlideModule 注解标识的自定义模块，这里提一下自定义模块的用法。</p>
<ul>
<li><p>Glide 3 用法<br>定义一个类实现 GlideModule，如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyGlideModule</span> <span class="token keyword">implements</span> <span class="token class-name">GlideModule</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">applyOptions</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> GlideBuilder builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerComponents</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Glide glide<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>其中 applyOptions() 与 registerComponents() 方法分别用来更改 Glide 的配置以及替换 Glide 组件。</p>
<p>然后在 AndroidManifest.xml 文件中加入如下配置：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token operator">&lt;</span>application<span class="token operator">></span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token operator">&lt;</span>meta<span class="token operator">-</span>data
            android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"com.wildma.myapplication.MyGlideModule"</span>
            android<span class="token operator">:</span>value<span class="token operator">=</span><span class="token string">"GlideModule"</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>application<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>Glide 4 用法<br>定义一个类实现 AppGlideModule，然后加上 @GlideModule 注解即可。如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@GlideModule</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">MyAppGlideModule</span> <span class="token keyword">extends</span> <span class="token class-name">AppGlideModule</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">applyOptions</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> GlideBuilder builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerComponents</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Glide glide<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Registry registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>关于 @GlideModule 的更详细使用可以查看 <a href="https://muyangmin.github.io/glide-docs-cn/doc/generatedapi.html" target="_blank" rel="noopener">Generated API</a>。</p>
<p>接下来继续查看关注点（2）：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*Glide*/</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">checkAndInitializeGlide</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> GeneratedAppGlideModule generatedAppGlideModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 不能重复初始化</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isInitializing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
          <span class="token string">"You cannot call Glide.get() in registerComponents(),"</span>
              <span class="token operator">+</span> <span class="token string">" use the provided Glide instance instead"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    isInitializing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">initializeGlide</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> generatedAppGlideModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    isInitializing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/*Glide*/</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initializeGlide</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> GeneratedAppGlideModule generatedAppGlideModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initializeGlide</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">GlideBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> generatedAppGlideModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/*Glide*/</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initializeGlide</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> GlideBuilder builder<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> GeneratedAppGlideModule annotationGeneratedModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Context applicationContext <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    List<span class="token operator">&lt;</span>com<span class="token punctuation">.</span>bumptech<span class="token punctuation">.</span>glide<span class="token punctuation">.</span>module<span class="token punctuation">.</span>GlideModule<span class="token operator">></span> manifestModules <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>annotationGeneratedModule <span class="token operator">==</span> null <span class="token operator">||</span> annotationGeneratedModule<span class="token punctuation">.</span><span class="token function">isManifestParsingEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//（1）</span>
      manifestModules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ManifestParser</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// 从注解生成的 GeneratedAppGlideModule 中获取 RequestManagerFactory</span>
    RequestManagerRetriever<span class="token punctuation">.</span>RequestManagerFactory factory <span class="token operator">=</span>
        annotationGeneratedModule <span class="token operator">!=</span> null
            <span class="token operator">?</span> annotationGeneratedModule<span class="token punctuation">.</span><span class="token function">getRequestManagerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">:</span> null<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 将 RequestManagerFactory 设置到 GlideBuilder</span>
    builder<span class="token punctuation">.</span><span class="token function">setRequestManagerFactory</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//（2）</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>bumptech<span class="token punctuation">.</span>glide<span class="token punctuation">.</span>module<span class="token punctuation">.</span>GlideModule module <span class="token operator">:</span> manifestModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      module<span class="token punctuation">.</span><span class="token function">applyOptions</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">,</span> builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//（3）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>annotationGeneratedModule <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      annotationGeneratedModule<span class="token punctuation">.</span><span class="token function">applyOptions</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">,</span> builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//（4）</span>
    Glide glide <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>com<span class="token punctuation">.</span>bumptech<span class="token punctuation">.</span>glide<span class="token punctuation">.</span>module<span class="token punctuation">.</span>GlideModule module <span class="token operator">:</span> manifestModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// (5)</span>
        module<span class="token punctuation">.</span><span class="token function">registerComponents</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">,</span> glide<span class="token punctuation">,</span> glide<span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AbstractMethodError</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
            <span class="token string">"Attempting to register a Glide v3 module. If you see this, you or one of your"</span>
                <span class="token operator">+</span> <span class="token string">" dependencies may be including Glide v3 even though you're using Glide v4."</span>
                <span class="token operator">+</span> <span class="token string">" You'll need to find and remove (or update) the offending dependency."</span>
                <span class="token operator">+</span> <span class="token string">" The v3 module name is: "</span>
                <span class="token operator">+</span> module<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>annotationGeneratedModule <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// (6)</span>
      annotationGeneratedModule<span class="token punctuation">.</span><span class="token function">registerComponents</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">,</span> glide<span class="token punctuation">,</span> glide<span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 注册组件回调</span>
    applicationContext<span class="token punctuation">.</span><span class="token function">registerComponentCallbacks</span><span class="token punctuation">(</span>glide<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//（7）</span>
    Glide<span class="token punctuation">.</span>glide <span class="token operator">=</span> glide<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  可以看到，调用 checkAndInitializeGlide() 方法后最终调用了最多参数的 initializeGlide() 方法。源码中我标记了 7 个关注点，分别如下：</p>
<ul>
<li><p>（1）：将 AndroidManifest.xml 中所有值为 GlideModule 的 meta-data 配置读取出来，并将相应的自定义模块实例化。也就是实例化前面演示的在 Glide 3 中的自定义模块。</p>
</li>
<li><p>（2）（3）：分别从两个版本的自定义模块中更改 Glide 的配置。</p>
</li>
<li><p>（4）：使用<a href="https://wildma.github.io/blog/364ea8cc.html#toc-heading-14">建造者模式</a>创建 Glide。</p>
</li>
<li><p>（5）（6）：分别从两个版本的自定义模块中替换 Glide 组件。</p>
</li>
<li><p>（7）：将创建的 Glide 赋值给 Glide 的静态变量。</p>
<p>继续看下关注点（4）内部是如何创建 Glide 的，进入 GlideBuilder#build()：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*GlideBuilder*/</span>
Glide <span class="token function">build</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceExecutor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 创建网络请求线程池</span>
    sourceExecutor <span class="token operator">=</span> GlideExecutor<span class="token punctuation">.</span><span class="token function">newSourceExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>diskCacheExecutor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 创建磁盘缓存线程池</span>
    diskCacheExecutor <span class="token operator">=</span> GlideExecutor<span class="token punctuation">.</span><span class="token function">newDiskCacheExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>animationExecutor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 创建动画线程池</span>
    animationExecutor <span class="token operator">=</span> GlideExecutor<span class="token punctuation">.</span><span class="token function">newAnimationExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>memorySizeCalculator <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 创建内存大小计算器</span>
    memorySizeCalculator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemorySizeCalculator<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>connectivityMonitorFactory <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 创建默认网络连接监视器工厂</span>
    connectivityMonitorFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConnectivityMonitorFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 创建 Bitmap 池</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmapPool <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> size <span class="token operator">=</span> memorySizeCalculator<span class="token punctuation">.</span><span class="token function">getBitmapPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      bitmapPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LruBitmapPool</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      bitmapPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BitmapPoolAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>arrayPool <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 创建固定大小的数组池（4MB），使用 LRU 策略来保持数组池在最大字节数以下</span>
    arrayPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LruArrayPool</span><span class="token punctuation">(</span>memorySizeCalculator<span class="token punctuation">.</span><span class="token function">getArrayPoolSizeInBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>memoryCache <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 创建内存缓存</span>
    memoryCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LruResourceCache</span><span class="token punctuation">(</span>memorySizeCalculator<span class="token punctuation">.</span><span class="token function">getMemoryCacheSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>diskCacheFactory <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>、
    <span class="token comment" spellcheck="true">// 创建磁盘缓存工厂</span>
    diskCacheFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InternalCacheDiskCacheFactory</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/*创建加载以及管理活动资源和缓存资源的引擎*/</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>engine <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    engine <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">Engine</span><span class="token punctuation">(</span>
            memoryCache<span class="token punctuation">,</span>
            diskCacheFactory<span class="token punctuation">,</span>
            diskCacheExecutor<span class="token punctuation">,</span>
            sourceExecutor<span class="token punctuation">,</span>
            GlideExecutor<span class="token punctuation">.</span><span class="token function">newUnlimitedSourceExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            animationExecutor<span class="token punctuation">,</span>
            isActiveResourceRetentionAllowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultRequestListeners <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    defaultRequestListeners <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    defaultRequestListeners <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>defaultRequestListeners<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 创建请求管理类，这里的 requestManagerFactory 就是前面 GlideBuilder#setRequestManagerFactory() 设置进来的</span>
  <span class="token comment" spellcheck="true">// 也就是 @GlideModule 注解中获取的</span>
  RequestManagerRetriever requestManagerRetriever <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">RequestManagerRetriever</span><span class="token punctuation">(</span>requestManagerFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">//（1）创建 Glide</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Glide</span><span class="token punctuation">(</span>
      context<span class="token punctuation">,</span>
      engine<span class="token punctuation">,</span>
      memoryCache<span class="token punctuation">,</span>
      bitmapPool<span class="token punctuation">,</span>
      arrayPool<span class="token punctuation">,</span>
      requestManagerRetriever<span class="token punctuation">,</span>
      connectivityMonitorFactory<span class="token punctuation">,</span>
      logLevel<span class="token punctuation">,</span>
      defaultRequestOptionsFactory<span class="token punctuation">,</span>
      defaultTransitionOptions<span class="token punctuation">,</span>
      defaultRequestListeners<span class="token punctuation">,</span>
      isLoggingRequestOriginsEnabled<span class="token punctuation">,</span>
      isImageDecoderEnabledForBitmaps<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>可以看到，build() 方法主要是创建一些线程池、Bitmap 池、缓存策略、Engine 等，然后利用这些来创建具体的 Glide。继续看下 Glide 的构造函数：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*Glide*/</span>
  <span class="token function">Glide</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/*将传进来的参数赋值给 Glide 类中的一些常量，方便后续使用。*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>engine <span class="token operator">=</span> engine<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bitmapPool <span class="token operator">=</span> bitmapPool<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>arrayPool <span class="token operator">=</span> arrayPool<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>memoryCache <span class="token operator">=</span> memoryCache<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>requestManagerRetriever <span class="token operator">=</span> requestManagerRetriever<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>connectivityMonitorFactory <span class="token operator">=</span> connectivityMonitorFactory<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>defaultRequestOptionsFactory <span class="token operator">=</span> defaultRequestOptionsFactory<span class="token punctuation">;</span>

    <span class="token keyword">final</span> Resources resources <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 创建 Registry，Registry 的作用是管理组件注册，用来扩展或替换 Glide 的默认加载、解码和编码逻辑。</span>
    registry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Registry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 省略的部分主要是：创建一些处理图片的解析器、解码器、转码器等，然后将他们添加到 Registry 中</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// 创建 ImageViewTargetFactory，用来给 View 获取正确类型的 ViewTarget（BitmapImageViewTarget 或 DrawableImageViewTarget）</span>
    ImageViewTargetFactory imageViewTargetFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImageViewTargetFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 构建一个 Glide 专属的上下文</span>
    glideContext <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">GlideContext</span><span class="token punctuation">(</span>
            context<span class="token punctuation">,</span>
            arrayPool<span class="token punctuation">,</span>
            registry<span class="token punctuation">,</span>
            imageViewTargetFactory<span class="token punctuation">,</span>
            defaultRequestOptionsFactory<span class="token punctuation">,</span>
            defaultTransitionOptions<span class="token punctuation">,</span>
            defaultRequestListeners<span class="token punctuation">,</span>
            engine<span class="token punctuation">,</span>
            isLoggingRequestOriginsEnabled<span class="token punctuation">,</span>
            logLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>到这一步，Glide 才算真正创建成功。也就是 Glide.get(context).getRequestManagerRetriever() 中的 get() 方法已经走完了。</p>
<p>接下来看下 getRequestManagerRetriever() 方法：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/*Glide*/</span>
    <span class="token keyword">public</span> RequestManagerRetriever <span class="token function">getRequestManagerRetriever</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> requestManagerRetriever<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>发现这里直接返回了实例，其实 RequestManagerRetriever 的实例在前面的 GlideBuilder#build() 方法中已经创建了，所以这里可以直接返回。</p>
<p>到这一步，getRetriever(activity).get(activity) 中的 getRetriever() 方法也已经走完了，并返回了 RequestManagerRetriever，接下来继续看下 get() 方法。</p>
<h4 id="2-1-2-RequestManagerRetriever-get"><a href="#2-1-2-RequestManagerRetriever-get" class="headerlink" title="2.1.2 RequestManagerRetriever#get()"></a>2.1.2 RequestManagerRetriever#get()</h4><p>RequestManagerRetriever#get() 的重载方法同样有 6 个：</p>
<ul>
<li>RequestManagerRetriever#get(Context context)</li>
<li>RequestManagerRetriever#get(Activity activity)</li>
<li>RequestManagerRetriever#get(FragmentActivity activity)</li>
<li>RequestManagerRetriever#get(Fragment fragment)</li>
<li>RequestManagerRetriever#get(android.app.Fragment fragment)</li>
<li>RequestManagerRetriever#get(View view)</li>
</ul>
<p>这些方法的参数同样可以分成两种情况，即 Application 与非 Application 类型。先看下 Application 类型的情况：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RequestManagerRetriever*/</span>
  <span class="token keyword">public</span> RequestManager <span class="token function">get</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"You cannot start a load on a null Context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Util<span class="token punctuation">.</span><span class="token function">isOnMainThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>context <span class="token keyword">instanceof</span> <span class="token class-name">Application</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">/*（1）*/</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token keyword">instanceof</span> <span class="token class-name">FragmentActivity</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">(</span>FragmentActivity<span class="token punctuation">)</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token keyword">instanceof</span> <span class="token class-name">Activity</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Activity<span class="token punctuation">)</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token keyword">instanceof</span> <span class="token class-name">ContextWrapper</span>
          <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ContextWrapper<span class="token punctuation">)</span> context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBaseContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ContextWrapper<span class="token punctuation">)</span> context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBaseContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//（2）</span>
    <span class="token keyword">return</span> <span class="token function">getApplicationManager</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里标注了 2 个关注点，分别如下：</p>
<ul>
<li><p>（1）：判断如果当前线程是在主线程，并且 context 不属于 Application 类型，那么会走对应重载方法。</p>
</li>
<li><p>（2）：属于 Application 类型，就会调用 getApplicationManager(context) 方法，点进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*RequestManagerRetriever*/</span>
<span class="token keyword">private</span> RequestManager <span class="token function">getApplicationManager</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>applicationManager <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>applicationManager <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Glide glide <span class="token operator">=</span> Glide<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        applicationManager <span class="token operator">=</span>
            factory<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>
                glide<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ApplicationLifecycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">EmptyRequestManagerTreeNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                context<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> applicationManager<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>可以看到，这里使用了单例模式来获取 RequestManager，里面重新用 Application 类型的 Context 来获取 Glide 的实例。这里并没有专门做生命周期的处理，<br>因为 Application 对象的生命周期即为应用程序的生命周期，所以在这里图片请求的生命周期是和应用程序同步的。</p>
<p>我们继续看下非 Application 类型的情况，这里只拿 FragmentActivity 来讲，其他类似。代码如下：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RequestManagerRetriever*/</span>
  <span class="token keyword">public</span> RequestManager <span class="token function">get</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> FragmentActivity activity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Util<span class="token punctuation">.</span><span class="token function">isOnBackgroundThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 检查 Activity 是否销毁</span>
      <span class="token function">assertNotDestroyed</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// 获取当前 Activity 的 FragmentManager</span>
      FragmentManager fm <span class="token operator">=</span> activity<span class="token punctuation">.</span><span class="token function">getSupportFragmentManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">supportFragmentGet</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> fm<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/*parentHint=*/</span> null<span class="token punctuation">,</span> <span class="token function">isActivityVisible</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里判断如果是后台线程那么还是走上面的 Application 类型的 get() 方法，否则调用 supportFragmentGet() 方法来获取 RequestManager。<br>看下 supportFragmentGet() 方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RequestManagerRetriever*/</span>
  <span class="token keyword">private</span> RequestManager <span class="token function">supportFragmentGet</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> FragmentManager fm<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> Fragment parentHint<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> isParentVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//（1）</span>
    SupportRequestManagerFragment current <span class="token operator">=</span>
        <span class="token function">getSupportRequestManagerFragment</span><span class="token punctuation">(</span>fm<span class="token punctuation">,</span> parentHint<span class="token punctuation">,</span> isParentVisible<span class="token punctuation">)</span><span class="token punctuation">;</span>
    RequestManager requestManager <span class="token operator">=</span> current<span class="token punctuation">.</span><span class="token function">getRequestManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>requestManager <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Glide glide <span class="token operator">=</span> Glide<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//（2）</span>
      requestManager <span class="token operator">=</span>
          factory<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>
              glide<span class="token punctuation">,</span> current<span class="token punctuation">.</span><span class="token function">getGlideLifecycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> current<span class="token punctuation">.</span><span class="token function">getRequestManagerTreeNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//（3）</span>
      current<span class="token punctuation">.</span><span class="token function">setRequestManager</span><span class="token punctuation">(</span>requestManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> requestManager<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/*RequestManagerRetriever*/</span>
  <span class="token comment" spellcheck="true">// 关注点（1）调用了 getSupportRequestManagerFragment() 方法</span>
  <span class="token keyword">private</span> SupportRequestManagerFragment <span class="token function">getSupportRequestManagerFragment</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> <span class="token keyword">final</span> FragmentManager fm<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Fragment parentHint<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isParentVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SupportRequestManagerFragment current <span class="token operator">=</span>
        <span class="token punctuation">(</span>SupportRequestManagerFragment<span class="token punctuation">)</span> fm<span class="token punctuation">.</span><span class="token function">findFragmentByTag</span><span class="token punctuation">(</span>FRAGMENT_TAG<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      current <span class="token operator">=</span> pendingSupportRequestManagerFragments<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fm<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//（4）</span>
        current <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SupportRequestManagerFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        current<span class="token punctuation">.</span><span class="token function">setParentFragmentHint</span><span class="token punctuation">(</span>parentHint<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isParentVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          current<span class="token punctuation">.</span><span class="token function">getGlideLifecycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        pendingSupportRequestManagerFragments<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>fm<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fm<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> FRAGMENT_TAG<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commitAllowingStateLoss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        handler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>ID_REMOVE_SUPPORT_FRAGMENT_MANAGER<span class="token punctuation">,</span> fm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendToTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> current<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/*SupportRequestManagerFragment*/</span>
  <span class="token comment" spellcheck="true">// 关注点（4）实例化了 SupportRequestManagerFragment</span>
  <span class="token keyword">public</span> <span class="token function">SupportRequestManagerFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//（5）</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ActivityFragmentLifecycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 supportFragmentGet() 方法中我标注了 3 个关注点，分别如下：</p>
<ul>
<li>（1）：获取了一个隐藏的 Fragment（在关注点（4）），在实例化 SupportRequestManagerFragment 的时候又实例化了<br>ActivityFragmentLifecycle（在关注点（5）），ActivityFragmentLifecycle 实现了 Lifecycle，主要用来监听 Activity 与 Fragment 的生命周期。</li>
<li>（2）：这里的 current.getGlideLifecycle() 就是关注点（1）中实例化的 ActivityFragmentLifecycle，这样 RequestManager 就与 ActivityFragmentLifecycle 进行了关联。</li>
<li>（3）：将 RequestManager 设置到 SupportRequestManagerFragment 中。</li>
</ul>
<p>所以经过（2）（3）实际是将 SupportRequestManagerFragment、RequestManager、ActivityFragmentLifecycle 都关联在一起了，又因为 Fragment 的生命周期和 Activity 是同步的，<br>所以 Activity 生命周期发生变化的时候，隐藏的 Fragment 的生命周期是同步变化的，这样 Glide 就可以根据这个 Fragment 的生命周期进行请求管理了。</p>
<p>是不是这样的呢？我们去看看 SupportRequestManagerFragment 的生命周期就知道了。</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*SupportRequestManagerFragment*/</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lifecycle<span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lifecycle<span class="token punctuation">.</span><span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lifecycle<span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unregisterFragmentWithRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，ActivityFragmentLifecycle 确实与 SupportRequestManagerFragment 的生命周期关联起来了，我们这里只拿 onDestroy 来看看，<br>这里调用了 lifecycle#onDestroy()，间接调用了如下方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*ActivityFragmentLifecycle*/</span>
  <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    isDestroyed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>LifecycleListener lifecycleListener <span class="token operator">:</span> Util<span class="token punctuation">.</span><span class="token function">getSnapshot</span><span class="token punctuation">(</span>lifecycleListeners<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      lifecycleListener<span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/*LifecycleListener*/</span>
  <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/*RequestManager*/</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    targetTracker<span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Target<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> target <span class="token operator">:</span> targetTracker<span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">clear</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    targetTracker<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestTracker<span class="token punctuation">.</span><span class="token function">clearRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lifecycle<span class="token punctuation">.</span><span class="token function">removeListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lifecycle<span class="token punctuation">.</span><span class="token function">removeListener</span><span class="token punctuation">(</span>connectivityMonitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mainHandler<span class="token punctuation">.</span><span class="token function">removeCallbacks</span><span class="token punctuation">(</span>addSelfToLifecycle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    glide<span class="token punctuation">.</span><span class="token function">unregisterRequestManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，因为 RequestManager 是实现了 LifecycleListener 接口的，所以最终是调用了 RequestManager 的 onDestroy() 方法，<br>该方法里面主要做了取消所有进行中的请求并清除和回收所有已完成请求的资源。确实如我们所料，图片请求的生命周期就是由一个隐藏的 Fragment 的生命周期决定的。</p>
<p>这里总结下，RequestManagerRetriever#get() 方法如果传入 Application 类型的参数，那么图片请求的生命周期就是 Application 对象的生命周期，即应用程序的生命周期。<br>如果传入的是非 Application 类型的参数，那么会向当前的 Activity 当中添加一个隐藏的 Fragment，然后图片请求的生命周期由这个 Fragment 的生命周期决定。</p>
<h4 id="2-1-3-小结"><a href="#2-1-3-小结" class="headerlink" title="2.1.3 小结"></a>2.1.3 小结</h4><p>with() 方法主要做了如下事情：</p>
<ul>
<li>获取 AndroidManifest.xml 文件中配置的自定义模块与 @GlideModule 注解标识的自定义模块，然后进行 Glide 配置的更改与组件的替换。</li>
<li>初始化构建 Glide 实例需要的各种配置信息，例如线程池、Bitmap 池、缓存策略、Engine 等，然后利用这些来创建具体的 Glide。</li>
<li>将 Glide 的请求与 Application 或者隐藏的 Fragment 的生命周期进行绑定。</li>
</ul>
<h3 id="2-2-load"><a href="#2-2-load" class="headerlink" title="2.2 load()"></a>2.2 load()</h3><p>load() 的重载方法有 9 个：</p>
<ul>
<li>RequestManager#load(Bitmap bitmap);</li>
<li>RequestManager#load(Drawable drawable);</li>
<li>RequestManager#load(String string);</li>
<li>RequestManager#load(Uri uri);</li>
<li>RequestManager#load(File file);</li>
<li>RequestManager#load(Integer resourceId);</li>
<li>RequestManager#load(URL url);</li>
<li>RequestManager#load(byte[] model);</li>
<li>RequestManager#load(Object model);</li>
</ul>
<p>点击进去发现这些重载方法最终都会调用 asDrawable().load()，所以这里只拿参数为字符串的来演示，也就是参数为图片链接。如下：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RequestManager*/</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> RequestBuilder<span class="token operator">&lt;</span>Drawable<span class="token operator">></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> String string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">asDrawable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="2-2-1-RequestManager-asDrawable"><a href="#2-2-1-RequestManager-asDrawable" class="headerlink" title="2.2.1 RequestManager#asDrawable()"></a>2.2.1 RequestManager#asDrawable()</h4><p>点击 asDrawable() 方法进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RequestManager*/</span>
  <span class="token keyword">public</span> RequestBuilder<span class="token operator">&lt;</span>Drawable<span class="token operator">></span> <span class="token function">asDrawable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">as</span><span class="token punctuation">(</span>Drawable<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/*RequestManager*/</span>
  <span class="token keyword">public</span> <span class="token operator">&lt;</span>ResourceType<span class="token operator">></span> RequestBuilder<span class="token operator">&lt;</span>ResourceType<span class="token operator">></span> <span class="token function">as</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Class<span class="token operator">&lt;</span>ResourceType<span class="token operator">></span> resourceClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RequestBuilder</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>glide<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> resourceClass<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/*RequestBuilder*/</span>
  <span class="token keyword">protected</span> <span class="token function">RequestBuilder</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Glide glide<span class="token punctuation">,</span>
      RequestManager requestManager<span class="token punctuation">,</span>
      Class<span class="token operator">&lt;</span>TranscodeType<span class="token operator">></span> transcodeClass<span class="token punctuation">,</span>
      Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/*给 RequestBuilder 中的一些常量进行赋值*/</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>glide <span class="token operator">=</span> glide<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>requestManager <span class="token operator">=</span> requestManager<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>transcodeClass <span class="token operator">=</span> transcodeClass<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>transitionOptions <span class="token operator">=</span> requestManager<span class="token punctuation">.</span><span class="token function">getDefaultTransitionOptions</span><span class="token punctuation">(</span>transcodeClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>glideContext <span class="token operator">=</span> glide<span class="token punctuation">.</span><span class="token function">getGlideContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 初始化请求监听</span>
    <span class="token function">initRequestListeners</span><span class="token punctuation">(</span>requestManager<span class="token punctuation">.</span><span class="token function">getDefaultRequestListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//（1）</span>
    <span class="token function">apply</span><span class="token punctuation">(</span>requestManager<span class="token punctuation">.</span><span class="token function">getDefaultRequestOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，经过一些列调用，该方法最终创建了 RequestBuilder 的实例并返回。其中关注点（1）是将默认选项应用于请求，点进去看看里面做了什么：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RequestBuilder*/</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> RequestBuilder<span class="token operator">&lt;</span>TranscodeType<span class="token operator">></span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> BaseRequestOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> requestOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>requestOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>requestOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里又调用了父类的 apply() 方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*BaseRequestOptions*/</span>
  <span class="token keyword">public</span> T <span class="token function">apply</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> BaseRequestOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isAutoCloneEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    BaseRequestOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> other <span class="token operator">=</span> o<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> SIZE_MULTIPLIER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sizeMultiplier <span class="token operator">=</span> other<span class="token punctuation">.</span>sizeMultiplier<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> USE_UNLIMITED_SOURCE_GENERATORS_POOL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      useUnlimitedSourceGeneratorsPool <span class="token operator">=</span> other<span class="token punctuation">.</span>useUnlimitedSourceGeneratorsPool<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> USE_ANIMATION_POOL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      useAnimationPool <span class="token operator">=</span> other<span class="token punctuation">.</span>useAnimationPool<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> DISK_CACHE_STRATEGY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      diskCacheStrategy <span class="token operator">=</span> other<span class="token punctuation">.</span>diskCacheStrategy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> PRIORITY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      priority <span class="token operator">=</span> other<span class="token punctuation">.</span>priority<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> ERROR_PLACEHOLDER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      errorPlaceholder <span class="token operator">=</span> other<span class="token punctuation">.</span>errorPlaceholder<span class="token punctuation">;</span>
      errorId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      fields <span class="token operator">&amp;=</span> <span class="token operator">~</span>ERROR_ID<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> ERROR_ID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      errorId <span class="token operator">=</span> other<span class="token punctuation">.</span>errorId<span class="token punctuation">;</span>
      errorPlaceholder <span class="token operator">=</span> null<span class="token punctuation">;</span>
      fields <span class="token operator">&amp;=</span> <span class="token operator">~</span>ERROR_PLACEHOLDER<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> PLACEHOLDER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      placeholderDrawable <span class="token operator">=</span> other<span class="token punctuation">.</span>placeholderDrawable<span class="token punctuation">;</span>
      placeholderId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      fields <span class="token operator">&amp;=</span> <span class="token operator">~</span>PLACEHOLDER_ID<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> PLACEHOLDER_ID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      placeholderId <span class="token operator">=</span> other<span class="token punctuation">.</span>placeholderId<span class="token punctuation">;</span>
      placeholderDrawable <span class="token operator">=</span> null<span class="token punctuation">;</span>
      fields <span class="token operator">&amp;=</span> <span class="token operator">~</span>PLACEHOLDER<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> IS_CACHEABLE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isCacheable <span class="token operator">=</span> other<span class="token punctuation">.</span>isCacheable<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> OVERRIDE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      overrideWidth <span class="token operator">=</span> other<span class="token punctuation">.</span>overrideWidth<span class="token punctuation">;</span>
      overrideHeight <span class="token operator">=</span> other<span class="token punctuation">.</span>overrideHeight<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> SIGNATURE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      signature <span class="token operator">=</span> other<span class="token punctuation">.</span>signature<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> RESOURCE_CLASS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resourceClass <span class="token operator">=</span> other<span class="token punctuation">.</span>resourceClass<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> FALLBACK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fallbackDrawable <span class="token operator">=</span> other<span class="token punctuation">.</span>fallbackDrawable<span class="token punctuation">;</span>
      fallbackId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      fields <span class="token operator">&amp;=</span> <span class="token operator">~</span>FALLBACK_ID<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> FALLBACK_ID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fallbackId <span class="token operator">=</span> other<span class="token punctuation">.</span>fallbackId<span class="token punctuation">;</span>
      fallbackDrawable <span class="token operator">=</span> null<span class="token punctuation">;</span>
      fields <span class="token operator">&amp;=</span> <span class="token operator">~</span>FALLBACK<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> THEME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      theme <span class="token operator">=</span> other<span class="token punctuation">.</span>theme<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> TRANSFORMATION_ALLOWED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isTransformationAllowed <span class="token operator">=</span> other<span class="token punctuation">.</span>isTransformationAllowed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> TRANSFORMATION_REQUIRED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isTransformationRequired <span class="token operator">=</span> other<span class="token punctuation">.</span>isTransformationRequired<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> TRANSFORMATION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      transformations<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>transformations<span class="token punctuation">)</span><span class="token punctuation">;</span>
      isScaleOnlyOrNoTransform <span class="token operator">=</span> other<span class="token punctuation">.</span>isScaleOnlyOrNoTransform<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSet</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>fields<span class="token punctuation">,</span> ONLY_RETRIEVE_FROM_CACHE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      onlyRetrieveFromCache <span class="token operator">=</span> other<span class="token punctuation">.</span>onlyRetrieveFromCache<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Applying options with dontTransform() is expected to clear our transformations.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isTransformationAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      transformations<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      fields <span class="token operator">&amp;=</span> <span class="token operator">~</span>TRANSFORMATION<span class="token punctuation">;</span>
      isTransformationRequired <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      fields <span class="token operator">&amp;=</span> <span class="token operator">~</span>TRANSFORMATION_REQUIRED<span class="token punctuation">;</span>
      isScaleOnlyOrNoTransform <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    fields <span class="token operator">|=</span> other<span class="token punctuation">.</span>fields<span class="token punctuation">;</span>
    options<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">selfOrThrowIfLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，配置选项有很多，包括磁盘缓存策略，加载中的占位图，加载失败的占位图等。<br>到这里 asDrawable() 方法就看完了，接下来继续看 asDrawable().load(string) 中的 load() 方法。</p>
<h4 id="2-2-2-RequestBuilder-load"><a href="#2-2-2-RequestBuilder-load" class="headerlink" title="2.2.2 RequestBuilder#load()"></a>2.2.2 RequestBuilder#load()</h4><p>点击 load() 方法进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RequestBuilder*/</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> RequestBuilder<span class="token operator">&lt;</span>TranscodeType<span class="token operator">></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> String string<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">loadGeneric</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/*RequestBuilder*/</span>
  <span class="token keyword">private</span> RequestBuilder<span class="token operator">&lt;</span>TranscodeType<span class="token operator">></span> <span class="token function">loadGeneric</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Object model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>model <span class="token operator">=</span> model<span class="token punctuation">;</span>
    isModelSet <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发现这个方法非常简单，首先调用了 loadGeneric() 方法，然后 loadGeneric() 方法中将传进来的图片资源赋值给了变量 model，最后用 isModelSet 标记已经调用过 load() 方法了。</p>
<h4 id="2-2-3-小结"><a href="#2-2-3-小结" class="headerlink" title="2.2.3 小结"></a>2.2.3 小结</h4><p>load() 方法就比较简单了，主要是通过前面实例化的 Glide 与 RequestManager 来创建 RequestBuilder，然后将传进来的参数赋值给 model。接下来主要看看 into() 方法。</p>
<h3 id="2-3-into"><a href="#2-3-into" class="headerlink" title="2.3 into()"></a>2.3 into()</h3><p>我们发现，前两个方法都没有涉及到图片的请求、缓存、解码等逻辑，其实都在 into() 方法中，所以这个方法也是最复杂的。</p>
<p>点击 into() 方法进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RequestBuilder*/</span>
  <span class="token keyword">public</span> ViewTarget<span class="token operator">&lt;</span>ImageView<span class="token punctuation">,</span> TranscodeType<span class="token operator">></span> <span class="token function">into</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> ImageView view<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Util<span class="token punctuation">.</span><span class="token function">assertMainThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>

    BaseRequestOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> requestOptions <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>requestOptions<span class="token punctuation">.</span><span class="token function">isTransformationSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">&amp;&amp;</span> requestOptions<span class="token punctuation">.</span><span class="token function">isTransformationAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">&amp;&amp;</span> view<span class="token punctuation">.</span><span class="token function">getScaleType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">/*将 ImageView 的 scaleType 设置给 BaseRequestOptions（ImageView 的默认 scaleType 为 fitCenter）*/</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>view<span class="token punctuation">.</span><span class="token function">getScaleType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> CENTER_CROP<span class="token operator">:</span>
          requestOptions <span class="token operator">=</span> requestOptions<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optionalCenterCrop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> CENTER_INSIDE<span class="token operator">:</span>
          requestOptions <span class="token operator">=</span> requestOptions<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optionalCenterInside</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> FIT_CENTER<span class="token operator">:</span>
        <span class="token keyword">case</span> FIT_START<span class="token operator">:</span>
        <span class="token keyword">case</span> FIT_END<span class="token operator">:</span>
          requestOptions <span class="token operator">=</span> requestOptions<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optionalFitCenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> FIT_XY<span class="token operator">:</span>
          requestOptions <span class="token operator">=</span> requestOptions<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optionalCenterInside</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> CENTER<span class="token operator">:</span>
        <span class="token keyword">case</span> MATRIX<span class="token operator">:</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
          <span class="token comment" spellcheck="true">// Do nothing.</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//（1）buildImageViewTarget()</span>
    <span class="token keyword">return</span> <span class="token function">into</span><span class="token punctuation">(</span>
        glideContext<span class="token punctuation">.</span><span class="token function">buildImageViewTarget</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> transcodeClass<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">/*targetListener=*/</span> null<span class="token punctuation">,</span>
        requestOptions<span class="token punctuation">,</span>
        Executors<span class="token punctuation">.</span><span class="token function">mainThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/*RequestBuilder*/</span>
  <span class="token keyword">private</span> <span class="token operator">&lt;</span>Y <span class="token keyword">extends</span> <span class="token class-name">Target</span><span class="token operator">&lt;</span>TranscodeType<span class="token operator">>></span> Y <span class="token function">into</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Y target<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> RequestListener<span class="token operator">&lt;</span>TranscodeType<span class="token operator">></span> targetListener<span class="token punctuation">,</span>
      BaseRequestOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> options<span class="token punctuation">,</span>
      Executor callbackExecutor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isModelSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"You must call #load() before calling #into()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//（2）</span>
    Request request <span class="token operator">=</span> <span class="token function">buildRequest</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> targetListener<span class="token punctuation">,</span> options<span class="token punctuation">,</span> callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Request previous <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">isEquivalentTo</span><span class="token punctuation">(</span>previous<span class="token punctuation">)</span>
        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isSkipMemoryCacheWithCompletePreviousRequest</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> previous<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>previous<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        previous<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    requestManager<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    target<span class="token punctuation">.</span><span class="token function">setRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//（3）</span>
    requestManager<span class="token punctuation">.</span><span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，里面又调用了 into() 的另一个重载方法。这里我标记了 3 个关注点，分别是获取 ImageViewTarget、构建请求和执行请求，后面我们就主要分析这 3 个关注点。</p>
<h4 id="2-3-1-GlideContext-buildImageViewTarget"><a href="#2-3-1-GlideContext-buildImageViewTarget" class="headerlink" title="2.3.1 GlideContext#buildImageViewTarget()"></a>2.3.1 GlideContext#buildImageViewTarget()</h4><p>点击 <strong>RequestBuilder#into() 中的关注点（1）</strong>进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*GlideContext*/</span>
  <span class="token keyword">public</span> <span class="token operator">&lt;</span>X<span class="token operator">></span> ViewTarget<span class="token operator">&lt;</span>ImageView<span class="token punctuation">,</span> X<span class="token operator">></span> <span class="token function">buildImageViewTarget</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> ImageView imageView<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Class<span class="token operator">&lt;</span>X<span class="token operator">></span> transcodeClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> imageViewTargetFactory<span class="token punctuation">.</span><span class="token function">buildTarget</span><span class="token punctuation">(</span>imageView<span class="token punctuation">,</span> transcodeClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/*ImageViewTargetFactory*/</span>
  <span class="token keyword">public</span> <span class="token operator">&lt;</span>Z<span class="token operator">></span> ViewTarget<span class="token operator">&lt;</span>ImageView<span class="token punctuation">,</span> Z<span class="token operator">></span> <span class="token function">buildTarget</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> ImageView view<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Class<span class="token operator">&lt;</span>Z<span class="token operator">></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Bitmap<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>ViewTarget<span class="token operator">&lt;</span>ImageView<span class="token punctuation">,</span> Z<span class="token operator">></span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">BitmapImageViewTarget</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Drawable<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>ViewTarget<span class="token operator">&lt;</span>ImageView<span class="token punctuation">,</span> Z<span class="token operator">></span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">DrawableImageViewTarget</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
          <span class="token string">"Unhandled class: "</span> <span class="token operator">+</span> clazz <span class="token operator">+</span> <span class="token string">", try .as*(Class).transcode(ResourceTranscoder)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，这里是通过 ImageViewTargetFactory#buildTarget(imageView, transcodeClass) 来获取的，其中 ImageViewTargetFactory 是在 Glide 的构造函数中实例化的，而 transcodeClass 是 load() 方法中 asDrawable()–as(Drawable.class) 传进来的。然后 buildTarget() 方法中就是根据这个 transcodeClass 来返回对应的 ViewTarget，所以默认情况下都是返回 DrawableImageViewTarget，只有专门指定 asBitmap()  才会返回 BitmapImageViewTarget，如下指定：</p>
<pre class="line-numbers language-java"><code class="language-java"> Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>接下来继续看关注点（2）。</p>
<h4 id="2-3-2-RequestBuilder-buildRequest"><a href="#2-3-2-RequestBuilder-buildRequest" class="headerlink" title="2.3.2 RequestBuilder#buildRequest()"></a>2.3.2 RequestBuilder#buildRequest()</h4><p>点击 <strong>RequestBuilder#into() 中的关注点（2）</strong>进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RequestBuilder*/</span>
  <span class="token keyword">private</span> Request <span class="token function">buildRequest</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">buildRequestRecursive</span><span class="token punctuation">(</span>
        <span class="token comment" spellcheck="true">/*requestLock=*/</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        target<span class="token punctuation">,</span>
        targetListener<span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">/*parentCoordinator=*/</span> null<span class="token punctuation">,</span>
        transitionOptions<span class="token punctuation">,</span>
        requestOptions<span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        requestOptions<span class="token punctuation">.</span><span class="token function">getOverrideWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        requestOptions<span class="token punctuation">.</span><span class="token function">getOverrideHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        requestOptions<span class="token punctuation">,</span>
        callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里又调用了 buildRequestRecursive() 方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RequestBuilder*/</span>
  <span class="token keyword">private</span> Request <span class="token function">buildRequestRecursive</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">// Build the ErrorRequestCoordinator first if necessary so we can update parentCoordinator.</span>
    ErrorRequestCoordinator errorRequestCoordinator <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//（1）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorBuilder <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      errorRequestCoordinator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorRequestCoordinator</span><span class="token punctuation">(</span>requestLock<span class="token punctuation">,</span> parentCoordinator<span class="token punctuation">)</span><span class="token punctuation">;</span>
      parentCoordinator <span class="token operator">=</span> errorRequestCoordinator<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//（2）递归构建缩略图请求</span>
    Request mainRequest <span class="token operator">=</span>
        <span class="token function">buildThumbnailRequestRecursive</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorRequestCoordinator <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> mainRequest<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">//（3）递归构建错误请求</span>
    Request errorRequest <span class="token operator">=</span>
        errorBuilder<span class="token punctuation">.</span><span class="token function">buildRequestRecursive</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    errorRequestCoordinator<span class="token punctuation">.</span><span class="token function">setRequests</span><span class="token punctuation">(</span>mainRequest<span class="token punctuation">,</span> errorRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> errorRequestCoordinator<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，只有关注点（1）中的 errorBuilder 不为空，即我们设置了在主请求失败时开始新的请求（如下设置） 才会走到关注点（3）去递归构建错误请求。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 设置在主请求失败时开始新的请求</span>
Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>fallbackUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>因为我什么都没有设置，所以这里看关注点（2）的递归构建缩略图请求即可。</p>
<p>点击 buildThumbnailRequestRecursive() 方法进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RequestBuilder*/</span>
  <span class="token keyword">private</span> Request <span class="token function">buildThumbnailRequestRecursive</span><span class="token punctuation">(</span>
      Object requestLock<span class="token punctuation">,</span>
      Target<span class="token operator">&lt;</span>TranscodeType<span class="token operator">></span> target<span class="token punctuation">,</span>
      RequestListener<span class="token operator">&lt;</span>TranscodeType<span class="token operator">></span> targetListener<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> RequestCoordinator parentCoordinator<span class="token punctuation">,</span>
      TransitionOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">super</span> TranscodeType<span class="token operator">></span> transitionOptions<span class="token punctuation">,</span>
      Priority priority<span class="token punctuation">,</span>
      <span class="token keyword">int</span> overrideWidth<span class="token punctuation">,</span>
      <span class="token keyword">int</span> overrideHeight<span class="token punctuation">,</span>
      BaseRequestOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> requestOptions<span class="token punctuation">,</span>
      Executor callbackExecutor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>thumbnailBuilder <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//（1）</span>

      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

      <span class="token comment" spellcheck="true">//（1.1）</span>
      ThumbnailRequestCoordinator coordinator <span class="token operator">=</span>
          <span class="token keyword">new</span> <span class="token class-name">ThumbnailRequestCoordinator</span><span class="token punctuation">(</span>requestLock<span class="token punctuation">,</span> parentCoordinator<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//（1.2）</span>
      Request fullRequest <span class="token operator">=</span>
          <span class="token function">obtainRequest</span><span class="token punctuation">(</span>
              requestLock<span class="token punctuation">,</span>
              target<span class="token punctuation">,</span>
              targetListener<span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">,</span>
              coordinator<span class="token punctuation">,</span>
              transitionOptions<span class="token punctuation">,</span>
              priority<span class="token punctuation">,</span>
              overrideWidth<span class="token punctuation">,</span>
              overrideHeight<span class="token punctuation">,</span>
              callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      isThumbnailBuilt <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// Recursively generate thumbnail requests.</span>
      <span class="token comment" spellcheck="true">//（1.3）</span>
      Request thumbRequest <span class="token operator">=</span>
          thumbnailBuilder<span class="token punctuation">.</span><span class="token function">buildRequestRecursive</span><span class="token punctuation">(</span>
              requestLock<span class="token punctuation">,</span>
              target<span class="token punctuation">,</span>
              targetListener<span class="token punctuation">,</span>
              coordinator<span class="token punctuation">,</span>
              thumbTransitionOptions<span class="token punctuation">,</span>
              thumbPriority<span class="token punctuation">,</span>
              thumbOverrideWidth<span class="token punctuation">,</span>
              thumbOverrideHeight<span class="token punctuation">,</span>
              thumbnailBuilder<span class="token punctuation">,</span>
              callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      isThumbnailBuilt <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      coordinator<span class="token punctuation">.</span><span class="token function">setRequests</span><span class="token punctuation">(</span>fullRequest<span class="token punctuation">,</span> thumbRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> coordinator<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>thumbSizeMultiplier <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//（2）</span>
      <span class="token comment" spellcheck="true">// Base case: thumbnail multiplier generates a thumbnail request, but cannot recurse.</span>
      ThumbnailRequestCoordinator coordinator <span class="token operator">=</span>
          <span class="token keyword">new</span> <span class="token class-name">ThumbnailRequestCoordinator</span><span class="token punctuation">(</span>requestLock<span class="token punctuation">,</span> parentCoordinator<span class="token punctuation">)</span><span class="token punctuation">;</span>
      Request fullRequest <span class="token operator">=</span>
          <span class="token function">obtainRequest</span><span class="token punctuation">(</span>
              requestLock<span class="token punctuation">,</span>
              target<span class="token punctuation">,</span>
              targetListener<span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">,</span>
              coordinator<span class="token punctuation">,</span>
              transitionOptions<span class="token punctuation">,</span>
              priority<span class="token punctuation">,</span>
              overrideWidth<span class="token punctuation">,</span>
              overrideHeight<span class="token punctuation">,</span>
              callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      BaseRequestOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> thumbnailOptions <span class="token operator">=</span>
          requestOptions<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sizeMultiplier</span><span class="token punctuation">(</span>thumbSizeMultiplier<span class="token punctuation">)</span><span class="token punctuation">;</span>

      Request thumbnailRequest <span class="token operator">=</span>
          <span class="token function">obtainRequest</span><span class="token punctuation">(</span>
              requestLock<span class="token punctuation">,</span>
              target<span class="token punctuation">,</span>
              targetListener<span class="token punctuation">,</span>
              thumbnailOptions<span class="token punctuation">,</span>
              coordinator<span class="token punctuation">,</span>
              transitionOptions<span class="token punctuation">,</span>
              <span class="token function">getThumbnailPriority</span><span class="token punctuation">(</span>priority<span class="token punctuation">)</span><span class="token punctuation">,</span>
              overrideWidth<span class="token punctuation">,</span>
              overrideHeight<span class="token punctuation">,</span>
              callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>

      coordinator<span class="token punctuation">.</span><span class="token function">setRequests</span><span class="token punctuation">(</span>fullRequest<span class="token punctuation">,</span> thumbnailRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> coordinator<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//（3）</span>
      <span class="token comment" spellcheck="true">// Base case: no thumbnail.</span>
      <span class="token keyword">return</span> <span class="token function">obtainRequest</span><span class="token punctuation">(</span>
          requestLock<span class="token punctuation">,</span>
          target<span class="token punctuation">,</span>
          targetListener<span class="token punctuation">,</span>
          requestOptions<span class="token punctuation">,</span>
          parentCoordinator<span class="token punctuation">,</span>
          transitionOptions<span class="token punctuation">,</span>
          priority<span class="token punctuation">,</span>
          overrideWidth<span class="token punctuation">,</span>
          overrideHeight<span class="token punctuation">,</span>
          callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，这里我标记了 3 个大的关注点，分别如下：</p>
<ul>
<li>（1）：设置了缩略图请求的时候会走这里，如下设置：<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 设置缩略图请求</span>
Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thumbnail</span><span class="token punctuation">(</span>Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>thumbnailUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
<p>其中关注点（1.2）是获取一个原图请求，关注点（1.3）是根据设置的 thumbnailBuilder 来生成缩略图请求，然后关注点（1.1）是创建一个协调器，用来协调这两个请求，这样可以同时进行原图与缩略图的请求。</p>
<ul>
<li>（2）：设置了缩略图的缩略比例的时候会走这里，如下设置：<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 设置缩略图的缩略比例</span>
Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thumbnail</span><span class="token punctuation">(</span><span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
<p>与关注点（1）一样，也是通过一个协调器来同时进行原图与缩略图的请求，不同的是这里生成缩略图用的是缩略比例。</p>
<ul>
<li>（3）：没有缩略图相关设置，直接获取原图请求。</li>
</ul>
<p>因为我什么都没有设置，所以这里看关注点（3）即可。点击 obtainRequest() 方法进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RequestBuilder*/</span>
  <span class="token keyword">private</span> Request <span class="token function">obtainRequest</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> SingleRequest<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/*SingleRequest*/</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>R<span class="token operator">></span> SingleRequest<span class="token operator">&lt;</span>R<span class="token operator">></span> <span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SingleRequest</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/*SingleRequest*/</span>
  <span class="token keyword">private</span> <span class="token function">SingleRequest</span><span class="token punctuation">(</span>
      Context context<span class="token punctuation">,</span>
      GlideContext glideContext<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> Object requestLock<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> Object model<span class="token punctuation">,</span>
      Class<span class="token operator">&lt;</span>R<span class="token operator">></span> transcodeClass<span class="token punctuation">,</span>
      BaseRequestOptions<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> requestOptions<span class="token punctuation">,</span>
      <span class="token keyword">int</span> overrideWidth<span class="token punctuation">,</span>
      <span class="token keyword">int</span> overrideHeight<span class="token punctuation">,</span>
      Priority priority<span class="token punctuation">,</span>
      Target<span class="token operator">&lt;</span>R<span class="token operator">></span> target<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> RequestListener<span class="token operator">&lt;</span>R<span class="token operator">></span> targetListener<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> List<span class="token operator">&lt;</span>RequestListener<span class="token operator">&lt;</span>R<span class="token operator">>></span> requestListeners<span class="token punctuation">,</span>
      RequestCoordinator requestCoordinator<span class="token punctuation">,</span>
      Engine engine<span class="token punctuation">,</span>
      TransitionFactory<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> R<span class="token operator">></span> animationFactory<span class="token punctuation">,</span>
      Executor callbackExecutor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>requestLock <span class="token operator">=</span> requestLock<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>glideContext <span class="token operator">=</span> glideContext<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>model <span class="token operator">=</span> model<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>transcodeClass <span class="token operator">=</span> transcodeClass<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>requestOptions <span class="token operator">=</span> requestOptions<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>overrideWidth <span class="token operator">=</span> overrideWidth<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>overrideHeight <span class="token operator">=</span> overrideHeight<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>priority <span class="token operator">=</span> priority<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>targetListener <span class="token operator">=</span> targetListener<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>requestListeners <span class="token operator">=</span> requestListeners<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>requestCoordinator <span class="token operator">=</span> requestCoordinator<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>engine <span class="token operator">=</span> engine<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>animationFactory <span class="token operator">=</span> animationFactory<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>callbackExecutor <span class="token operator">=</span> callbackExecutor<span class="token punctuation">;</span>
    status <span class="token operator">=</span> Status<span class="token punctuation">.</span>PENDING<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>requestOrigin <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> glideContext<span class="token punctuation">.</span><span class="token function">isLoggingRequestOriginsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      requestOrigin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Glide request origin trace"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，最终是实例化了一个 SingleRequest 的实例，也就是说构建请求这一步已经完成了，接下来分析执行请求这一步。</p>
<h4 id="2-3-3-RequestManager-track"><a href="#2-3-3-RequestManager-track" class="headerlink" title="2.3.3 RequestManager#track()"></a>2.3.3 RequestManager#track()</h4><p>点击 <strong>RequestBuilder#into() 中的关注点（3）</strong>进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RequestManager*/</span>
  <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Target<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> target<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Request request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    targetTracker<span class="token punctuation">.</span><span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestTracker<span class="token punctuation">.</span><span class="token function">runRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>点击 track() 进去：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">TargetTracker</span> <span class="token keyword">implements</span> <span class="token class-name">LifecycleListener</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Set<span class="token operator">&lt;</span>Target<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> targets <span class="token operator">=</span>
      Collections<span class="token punctuation">.</span><span class="token function">newSetFromMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WeakHashMap</span><span class="token operator">&lt;</span>Target<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">,</span> Boolean<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Target<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    targets<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，targetTracker.track(target) 是将一个 target 加入 Set 集合中，继续看下 runRequest() 方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RequestTracker*/</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Set<span class="token operator">&lt;</span>Request<span class="token operator">></span> requests <span class="token operator">=</span>
      Collections<span class="token punctuation">.</span><span class="token function">newSetFromMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WeakHashMap</span><span class="token operator">&lt;</span>Request<span class="token punctuation">,</span> Boolean<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> List<span class="token operator">&lt;</span>Request<span class="token operator">></span> pendingRequests <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">runRequest</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Request request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    requests<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isPaused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      request<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      request<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Log<span class="token punctuation">.</span><span class="token function">isLoggable</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> Log<span class="token punctuation">.</span>VERBOSE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Paused, delaying request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      pendingRequests<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，首先将请求加入一个 Set 集合，然后判断是否暂停状态，是则清空请求，并将该请求加入待处理的请求集合中；不是暂停状态则开始请求。</p>
<p>点击 begin() 方法进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*SingleRequest*/</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>requestLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">assertNotCallingCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      stateVerifier<span class="token punctuation">.</span><span class="token function">throwIfRecycled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      startTime <span class="token operator">=</span> LogTime<span class="token punctuation">.</span><span class="token function">getLogTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">/*如果加载的资源为空，则调用加载失败的回调*/</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>model <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Util<span class="token punctuation">.</span><span class="token function">isValidDimensions</span><span class="token punctuation">(</span>overrideWidth<span class="token punctuation">,</span> overrideHeight<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          width <span class="token operator">=</span> overrideWidth<span class="token punctuation">;</span>
          height <span class="token operator">=</span> overrideHeight<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> logLevel <span class="token operator">=</span> <span class="token function">getFallbackDrawable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">?</span> Log<span class="token punctuation">.</span>WARN <span class="token operator">:</span> Log<span class="token punctuation">.</span>DEBUG<span class="token punctuation">;</span>
        <span class="token function">onLoadFailed</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GlideException</span><span class="token punctuation">(</span><span class="token string">"Received null model"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> logLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> Status<span class="token punctuation">.</span>RUNNING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Cannot restart a running request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> Status<span class="token punctuation">.</span>COMPLETE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 资源加载完成</span>
        <span class="token function">onResourceReady</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> DataSource<span class="token punctuation">.</span>MEMORY_CACHE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      status <span class="token operator">=</span> Status<span class="token punctuation">.</span>WAITING_FOR_SIZE<span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//（1）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Util<span class="token punctuation">.</span><span class="token function">isValidDimensions</span><span class="token punctuation">(</span>overrideWidth<span class="token punctuation">,</span> overrideHeight<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">onSizeReady</span><span class="token punctuation">(</span>overrideWidth<span class="token punctuation">,</span> overrideHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        target<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>status <span class="token operator">==</span> Status<span class="token punctuation">.</span>RUNNING <span class="token operator">||</span> status <span class="token operator">==</span> Status<span class="token punctuation">.</span>WAITING_FOR_SIZE<span class="token punctuation">)</span>
          <span class="token operator">&amp;&amp;</span> <span class="token function">canNotifyStatusChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 刚开始加载的回调</span>
        target<span class="token punctuation">.</span><span class="token function">onLoadStarted</span><span class="token punctuation">(</span><span class="token function">getPlaceholderDrawable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>IS_VERBOSE_LOGGABLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">logV</span><span class="token punctuation">(</span><span class="token string">"finished run method in "</span> <span class="token operator">+</span> LogTime<span class="token punctuation">.</span><span class="token function">getElapsedMillis</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如上，关键代码在关注点（1），这里做了一个判断，如果我们设置了 overrideWidth 和 overrideHeight（如下设置），则直接调用 onSizeReady() 方法，否则调用 getSize() 方法（第一次加载才会调用）。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 设置加载图片的宽高为 100x100 px</span>
Glide<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">override</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span>imageView<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>getSize() 方法的作用是通过 ViewTreeObserver 来监听 ImageView 的宽高，拿到宽高后最终也是调用 onSizeReady() 方法。</p>
<p>接下来看下 onSizeReady() 方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*SingleRequest*/</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSizeReady</span><span class="token punctuation">(</span><span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    stateVerifier<span class="token punctuation">.</span><span class="token function">throwIfRecycled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>requestLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

      <span class="token comment" spellcheck="true">/*根据缩略比例获取图片宽高*/</span>
      <span class="token keyword">float</span> sizeMultiplier <span class="token operator">=</span> requestOptions<span class="token punctuation">.</span><span class="token function">getSizeMultiplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token function">maybeApplySizeMultiplier</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> sizeMultiplier<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token function">maybeApplySizeMultiplier</span><span class="token punctuation">(</span>height<span class="token punctuation">,</span> sizeMultiplier<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">// 开始加载</span>
      loadStatus <span class="token operator">=</span>
          engine<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>
              glideContext<span class="token punctuation">,</span>
              model<span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>width<span class="token punctuation">,</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>height<span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">getResourceClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              transcodeClass<span class="token punctuation">,</span>
              priority<span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">getDiskCacheStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">getTransformations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">isTransformationRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">isScaleOnlyOrNoTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">isMemoryCacheable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">getUseUnlimitedSourceGeneratorsPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">getUseAnimationPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              requestOptions<span class="token punctuation">.</span><span class="token function">getOnlyRetrieveFromCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token keyword">this</span><span class="token punctuation">,</span>
              callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，这里开始加载了，继续跟进：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*Engine*/</span>
  <span class="token keyword">public</span> <span class="token operator">&lt;</span>R<span class="token operator">></span> LoadStatus <span class="token function">load</span><span class="token punctuation">(</span>
      GlideContext glideContext<span class="token punctuation">,</span>
      Object model<span class="token punctuation">,</span>
      Key signature<span class="token punctuation">,</span>
      <span class="token keyword">int</span> width<span class="token punctuation">,</span>
      <span class="token keyword">int</span> height<span class="token punctuation">,</span>
      Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> resourceClass<span class="token punctuation">,</span>
      Class<span class="token operator">&lt;</span>R<span class="token operator">></span> transcodeClass<span class="token punctuation">,</span>
      Priority priority<span class="token punctuation">,</span>
      DiskCacheStrategy diskCacheStrategy<span class="token punctuation">,</span>
      Map<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">,</span> Transformation<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> transformations<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> isTransformationRequired<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> isScaleOnlyOrNoTransform<span class="token punctuation">,</span>
      Options options<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> isMemoryCacheable<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> useUnlimitedSourceExecutorPool<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> useAnimationPool<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> onlyRetrieveFromCache<span class="token punctuation">,</span>
      ResourceCallback cb<span class="token punctuation">,</span>
      Executor callbackExecutor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> startTime <span class="token operator">=</span> VERBOSE_IS_LOGGABLE <span class="token operator">?</span> LogTime<span class="token punctuation">.</span><span class="token function">getLogTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 构建缓存 key</span>
    EngineKey key <span class="token operator">=</span>
        keyFactory<span class="token punctuation">.</span><span class="token function">buildKey</span><span class="token punctuation">(</span>
            model<span class="token punctuation">,</span>
            signature<span class="token punctuation">,</span>
            width<span class="token punctuation">,</span>
            height<span class="token punctuation">,</span>
            transformations<span class="token punctuation">,</span>
            resourceClass<span class="token punctuation">,</span>
            transcodeClass<span class="token punctuation">,</span>
            options<span class="token punctuation">)</span><span class="token punctuation">;</span>

    EngineResource<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> memoryResource<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 从内存中加载资源</span>
      memoryResource <span class="token operator">=</span> <span class="token function">loadFromMemory</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> isMemoryCacheable<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">// 内存中没有，则等待当前正在执行的或开始一个新的 EngineJob</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>memoryResource <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">waitForExistingOrStartNewJob</span><span class="token punctuation">(</span>
            glideContext<span class="token punctuation">,</span>
            model<span class="token punctuation">,</span>
            signature<span class="token punctuation">,</span>
            width<span class="token punctuation">,</span>
            height<span class="token punctuation">,</span>
            resourceClass<span class="token punctuation">,</span>
            transcodeClass<span class="token punctuation">,</span>
            priority<span class="token punctuation">,</span>
            diskCacheStrategy<span class="token punctuation">,</span>
            transformations<span class="token punctuation">,</span>
            isTransformationRequired<span class="token punctuation">,</span>
            isScaleOnlyOrNoTransform<span class="token punctuation">,</span>
            options<span class="token punctuation">,</span>
            isMemoryCacheable<span class="token punctuation">,</span>
            useUnlimitedSourceExecutorPool<span class="token punctuation">,</span>
            useAnimationPool<span class="token punctuation">,</span>
            onlyRetrieveFromCache<span class="token punctuation">,</span>
            cb<span class="token punctuation">,</span>
            callbackExecutor<span class="token punctuation">,</span>
            key<span class="token punctuation">,</span>
            startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 加载完成回调</span>
    cb<span class="token punctuation">.</span><span class="token function">onResourceReady</span><span class="token punctuation">(</span>memoryResource<span class="token punctuation">,</span> DataSource<span class="token punctuation">.</span>MEMORY_CACHE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，这里首先构建缓存 key，然后利用这个 key 获取缓存中的资源，如果内存中没有，则等待当前正在执行的或开始一个新的 EngineJob，内存中有则调用加载完成的回调。这里我们先不讨论缓存相关的，下一篇文章再讲。所以默认是第一次加载，点击 waitForExistingOrStartNewJob() 方法进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*Engine*/</span>
  <span class="token keyword">private</span> <span class="token operator">&lt;</span>R<span class="token operator">></span> LoadStatus <span class="token function">waitForExistingOrStartNewJob</span><span class="token punctuation">(</span>
      GlideContext glideContext<span class="token punctuation">,</span>
      Object model<span class="token punctuation">,</span>
      Key signature<span class="token punctuation">,</span>
      <span class="token keyword">int</span> width<span class="token punctuation">,</span>
      <span class="token keyword">int</span> height<span class="token punctuation">,</span>
      Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> resourceClass<span class="token punctuation">,</span>
      Class<span class="token operator">&lt;</span>R<span class="token operator">></span> transcodeClass<span class="token punctuation">,</span>
      Priority priority<span class="token punctuation">,</span>
      DiskCacheStrategy diskCacheStrategy<span class="token punctuation">,</span>
      Map<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">,</span> Transformation<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> transformations<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> isTransformationRequired<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> isScaleOnlyOrNoTransform<span class="token punctuation">,</span>
      Options options<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> isMemoryCacheable<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> useUnlimitedSourceExecutorPool<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> useAnimationPool<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> onlyRetrieveFromCache<span class="token punctuation">,</span>
      ResourceCallback cb<span class="token punctuation">,</span>
      Executor callbackExecutor<span class="token punctuation">,</span>
      EngineKey key<span class="token punctuation">,</span>
      <span class="token keyword">long</span> startTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">//（1）</span>
    EngineJob<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> current <span class="token operator">=</span> jobs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> onlyRetrieveFromCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      current<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>VERBOSE_IS_LOGGABLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">logWithTimeAndKey</span><span class="token punctuation">(</span><span class="token string">"Added to existing load"</span><span class="token punctuation">,</span> startTime<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LoadStatus</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//（2）</span>
    EngineJob<span class="token operator">&lt;</span>R<span class="token operator">></span> engineJob <span class="token operator">=</span>
        engineJobFactory<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>
            key<span class="token punctuation">,</span>
            isMemoryCacheable<span class="token punctuation">,</span>
            useUnlimitedSourceExecutorPool<span class="token punctuation">,</span>
            useAnimationPool<span class="token punctuation">,</span>
            onlyRetrieveFromCache<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//（3）</span>
    DecodeJob<span class="token operator">&lt;</span>R<span class="token operator">></span> decodeJob <span class="token operator">=</span>
        decodeJobFactory<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>
            glideContext<span class="token punctuation">,</span>
            model<span class="token punctuation">,</span>
            key<span class="token punctuation">,</span>
            signature<span class="token punctuation">,</span>
            width<span class="token punctuation">,</span>
            height<span class="token punctuation">,</span>
            resourceClass<span class="token punctuation">,</span>
            transcodeClass<span class="token punctuation">,</span>
            priority<span class="token punctuation">,</span>
            diskCacheStrategy<span class="token punctuation">,</span>
            transformations<span class="token punctuation">,</span>
            isTransformationRequired<span class="token punctuation">,</span>
            isScaleOnlyOrNoTransform<span class="token punctuation">,</span>
            onlyRetrieveFromCache<span class="token punctuation">,</span>
            options<span class="token punctuation">,</span>
            engineJob<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 将 EngineJob 放到一个 map 集合中</span>
    jobs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> engineJob<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 添加回调</span>
    engineJob<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//（4）</span>
    engineJob<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>decodeJob<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>VERBOSE_IS_LOGGABLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">logWithTimeAndKey</span><span class="token punctuation">(</span><span class="token string">"Started new load"</span><span class="token punctuation">,</span> startTime<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 返回加载状态</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LoadStatus</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> engineJob<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里标记了 4 个关注点，分别如下：</p>
<ul>
<li>（1）：从 map 集合中获取 EngineJob，如果不为空表示当前有正在执行的 EngineJob，添加回调并返回加载状态。</li>
<li>（2）：使用 EngineJob 工厂构建了一个 EngineJob，该类主要用来管理加载以及当加载完成时通知回调。</li>
<li>（3）：使用 DecodeJob 工厂构建了一个 DecodeJob，该类主要负责图片的解码，实现了 Runnable 接口，属于一个任务。</li>
<li>（4）：这里调用了 EngineJob#start()，点击进去看看：<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*EngineJob*/</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span>DecodeJob<span class="token operator">&lt;</span>R<span class="token operator">></span> decodeJob<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>decodeJob <span class="token operator">=</span> decodeJob<span class="token punctuation">;</span>
  GlideExecutor executor <span class="token operator">=</span>
      decodeJob<span class="token punctuation">.</span><span class="token function">willDecodeFromCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> diskCacheExecutor <span class="token operator">:</span> <span class="token function">getActiveSourceExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>decodeJob<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>这里直接将 DecodeJob 任务放到了一个线程池中去执行，也就是说从这里开始<strong>切换到子线程</strong>了，那么我们看下 DecodeJob 的 run() 方法做了什么：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*DecodeJob*/</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    GlideTrace<span class="token punctuation">.</span><span class="token function">beginSectionFormat</span><span class="token punctuation">(</span><span class="token string">"DecodeJob#run(model=%s)"</span><span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    DataFetcher<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> localFetcher <span class="token operator">=</span> currentFetcher<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 被取消，则调用加载失败的回调</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isCancelled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">notifyFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment" spellcheck="true">// 执行</span>
      <span class="token function">runWrapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CallbackException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// Keeping track of the fetcher here and calling cleanup is excessively paranoid, we call</span>
      <span class="token comment" spellcheck="true">// close in all cases anyway.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>localFetcher <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        localFetcher<span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      GlideTrace<span class="token punctuation">.</span><span class="token function">endSection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>继续 runWrapped() 方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*DecodeJob*/</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">runWrapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>runReason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> INITIALIZE<span class="token operator">:</span>
        <span class="token comment" spellcheck="true">/*（4.1）*/</span>
        <span class="token comment" spellcheck="true">// 获取资源状态</span>
        stage <span class="token operator">=</span> <span class="token function">getNextStage</span><span class="token punctuation">(</span>Stage<span class="token punctuation">.</span>INITIALIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 根据资源状态获取资源执行器</span>
        currentGenerator <span class="token operator">=</span> <span class="token function">getNextGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//（4.2）执行</span>
        <span class="token function">runGenerators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> SWITCH_TO_SOURCE_SERVICE<span class="token operator">:</span>
        <span class="token function">runGenerators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> DECODE_DATA<span class="token operator">:</span>
        <span class="token function">decodeFromRetrievedData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Unrecognized run reason: "</span> <span class="token operator">+</span> runReason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/*DecodeJob*/</span>
  <span class="token keyword">private</span> Stage <span class="token function">getNextStage</span><span class="token punctuation">(</span>Stage current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> INITIALIZE<span class="token operator">:</span>
        <span class="token keyword">return</span> diskCacheStrategy<span class="token punctuation">.</span><span class="token function">decodeCachedResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> Stage<span class="token punctuation">.</span>RESOURCE_CACHE
            <span class="token operator">:</span> <span class="token function">getNextStage</span><span class="token punctuation">(</span>Stage<span class="token punctuation">.</span>RESOURCE_CACHE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> RESOURCE_CACHE<span class="token operator">:</span>
        <span class="token keyword">return</span> diskCacheStrategy<span class="token punctuation">.</span><span class="token function">decodeCachedData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> Stage<span class="token punctuation">.</span>DATA_CACHE
            <span class="token operator">:</span> <span class="token function">getNextStage</span><span class="token punctuation">(</span>Stage<span class="token punctuation">.</span>DATA_CACHE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> DATA_CACHE<span class="token operator">:</span>
        <span class="token comment" spellcheck="true">// Skip loading from source if the user opted to only retrieve the resource from cache.</span>
        <span class="token keyword">return</span> onlyRetrieveFromCache <span class="token operator">?</span> Stage<span class="token punctuation">.</span>FINISHED <span class="token operator">:</span> Stage<span class="token punctuation">.</span>SOURCE<span class="token punctuation">;</span>
      <span class="token keyword">case</span> SOURCE<span class="token operator">:</span>
      <span class="token keyword">case</span> FINISHED<span class="token operator">:</span>
        <span class="token keyword">return</span> Stage<span class="token punctuation">.</span>FINISHED<span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Unrecognized stage: "</span> <span class="token operator">+</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/*DecodeJob*/</span>
  <span class="token keyword">private</span> DataFetcherGenerator <span class="token function">getNextGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>stage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> RESOURCE_CACHE<span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResourceCacheGenerator</span><span class="token punctuation">(</span>decodeHelper<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> DATA_CACHE<span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DataCacheGenerator</span><span class="token punctuation">(</span>decodeHelper<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> SOURCE<span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SourceGenerator</span><span class="token punctuation">(</span>decodeHelper<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> FINISHED<span class="token operator">:</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Unrecognized stage: "</span> <span class="token operator">+</span> stage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>runReason 的默认值为 INITIALIZE，所以走的是第一个 case。由于我们配置了禁用内存与磁盘缓存，所以关注点（4.1）中得到的 stage 为 SOURCE，currentGenerator 为 SourceGenerator。拿到资源执行器接着就是执行了，点击关注点（4.2）的 runGenerators() 方法进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*DecodeJob*/</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">runGenerators</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentThread <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    startFetchTime <span class="token operator">=</span> LogTime<span class="token punctuation">.</span><span class="token function">getLogTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> isStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//（1）startNext()</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>isCancelled
        <span class="token operator">&amp;&amp;</span> currentGenerator <span class="token operator">!=</span> null
        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>isStarted <span class="token operator">=</span> currentGenerator<span class="token punctuation">.</span><span class="token function">startNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      stage <span class="token operator">=</span> <span class="token function">getNextStage</span><span class="token punctuation">(</span>stage<span class="token punctuation">)</span><span class="token punctuation">;</span>
      currentGenerator <span class="token operator">=</span> <span class="token function">getNextGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>stage <span class="token operator">==</span> Stage<span class="token punctuation">.</span>SOURCE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reschedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为 currentGenerator 在这里为 SourceGenerator，所以调用 startNext() 方法的时候实际调用的是 SourceGenerator#startNext()。该方法执行完返回的结果为 true，所以 while 循环是进不去的。</p>
<p>那么我们接下来看下 SourceGenerator#startNext()：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*SourceGenerator*/</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">startNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    loadData <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> started <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>started <span class="token operator">&amp;&amp;</span> <span class="token function">hasNextModelLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//（1）</span>
      loadData <span class="token operator">=</span> helper<span class="token punctuation">.</span><span class="token function">getLoadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>loadDataListIndex<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>loadData <span class="token operator">!=</span> null
          <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>helper<span class="token punctuation">.</span><span class="token function">getDiskCacheStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDataCacheable</span><span class="token punctuation">(</span>loadData<span class="token punctuation">.</span>fetcher<span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token operator">||</span> helper<span class="token punctuation">.</span><span class="token function">hasLoadPath</span><span class="token punctuation">(</span>loadData<span class="token punctuation">.</span>fetcher<span class="token punctuation">.</span><span class="token function">getDataClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//（2）</span>
        <span class="token function">startNextLoad</span><span class="token punctuation">(</span>loadData<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> started<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里我标记了 2 个关注，分别如下：</p>
<ul>
<li><strong>SourceGenerator#startNext() 中的关注点（1）</strong><br>通过 helper#getLoadData() 获取 LoadData 集合，实际集合里面也就只有一个元素，然后通过索引获取一个 LoadData，看看里面是怎么获取 LoadData 集合的：<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*DecodeHelper*/</span>
List<span class="token operator">&lt;</span>LoadData<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> <span class="token function">getLoadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLoadDataSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    isLoadDataSet <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    loadData<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    List<span class="token operator">&lt;</span>ModelLoader<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">>></span> modelLoaders <span class="token operator">=</span> glideContext<span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getModelLoaders</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//noinspection ForLoopReplaceableByForEach to improve perf</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> size <span class="token operator">=</span> modelLoaders<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ModelLoader<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">></span> modelLoader <span class="token operator">=</span> modelLoaders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// 关注点</span>
      LoadData<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> current <span class="token operator">=</span> modelLoader<span class="token punctuation">.</span><span class="token function">buildLoadData</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        loadData<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> loadData<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>可以看到，这里是通过 ModelLoader 对象的 buildLoadData() 方法获取的 LoadData。由于是从网络加载数据，所以这里实际调用的是 HttpGlideUrlLoader#buildLoadData()，点进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*HttpGlideUrlLoader*/</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> LoadData<span class="token operator">&lt;</span>InputStream<span class="token operator">></span> <span class="token function">buildLoadData</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> GlideUrl model<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Options options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// GlideUrls memoize parsed URLs so caching them saves a few object instantiations and time</span>
    <span class="token comment" spellcheck="true">// spent parsing urls.</span>
    GlideUrl url <span class="token operator">=</span> model<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>modelCache <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      url <span class="token operator">=</span> modelCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        modelCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">;</span>
        url <span class="token operator">=</span> model<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> timeout <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 关注点</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LoadData</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HttpUrlFetcher</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>缓存相关的不看，看到最后一行实例化 LoadData 的时候顺带实例化了 HttpUrlFetcher，这个后面会用到。</p>
<ul>
<li><p><strong>SourceGenerator#startNext() 中的关注点（2）</strong><br>这里表示开始加载了，点进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*SourceGenerator*/</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startNextLoad</span><span class="token punctuation">(</span><span class="token keyword">final</span> LoadData<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> toStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  loadData<span class="token punctuation">.</span>fetcher<span class="token punctuation">.</span><span class="token function">loadData</span><span class="token punctuation">(</span>
      helper<span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">DataCallback</span><span class="token operator">&lt;</span>Object<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDataReady</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Object data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCurrentRequest</span><span class="token punctuation">(</span>toStart<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">onDataReadyInternal</span><span class="token punctuation">(</span>toStart<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLoadFailed</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Exception e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCurrentRequest</span><span class="token punctuation">(</span>toStart<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">onLoadFailedInternal</span><span class="token punctuation">(</span>toStart<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>这里的 loadData.fetcher 就是刚刚实例化 LoadData 的时候传进来的 HttpUrlFetcher，所以这里调用的是 HttpUrlFetcher#loadData()：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*HttpUrlFetcher*/</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadData</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Priority priority<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> DataCallback<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> InputStream<span class="token operator">></span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> startTime <span class="token operator">=</span> LogTime<span class="token punctuation">.</span><span class="token function">getLogTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//（1）通过重定向加载数据</span>
      InputStream result <span class="token operator">=</span> <span class="token function">loadDataWithRedirects</span><span class="token punctuation">(</span>glideUrl<span class="token punctuation">.</span><span class="token function">toURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> glideUrl<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//（2）加载成功，回调数据</span>
      callback<span class="token punctuation">.</span><span class="token function">onDataReady</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Log<span class="token punctuation">.</span><span class="token function">isLoggable</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> Log<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Failed to load data for url"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      callback<span class="token punctuation">.</span><span class="token function">onLoadFailed</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Log<span class="token punctuation">.</span><span class="token function">isLoggable</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> Log<span class="token punctuation">.</span>VERBOSE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Finished http url fetcher fetch in "</span> <span class="token operator">+</span> LogTime<span class="token punctuation">.</span><span class="token function">getElapsedMillis</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里标记了 2 个关注点，分别如下：</p>
<ul>
<li><p><strong>HttpUrlFetcher#loadData() 中的关注点（1）</strong><br>这里加载完数据后返回了 InputStream，看看内部是怎么实现的：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*HttpUrlFetcher*/</span>
<span class="token keyword">private</span> InputStream <span class="token function">loadDataWithRedirects</span><span class="token punctuation">(</span>
    URL url<span class="token punctuation">,</span> <span class="token keyword">int</span> redirects<span class="token punctuation">,</span> URL lastUrl<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> headers<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment" spellcheck="true">// 获取 HttpURLConnection 实例</span>
  urlConnection <span class="token operator">=</span> connectionFactory<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> headerEntry <span class="token operator">:</span> headers<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    urlConnection<span class="token punctuation">.</span><span class="token function">addRequestProperty</span><span class="token punctuation">(</span>headerEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> headerEntry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  urlConnection<span class="token punctuation">.</span><span class="token function">setConnectTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
  urlConnection<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
  urlConnection<span class="token punctuation">.</span><span class="token function">setUseCaches</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  urlConnection<span class="token punctuation">.</span><span class="token function">setDoInput</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Stop the urlConnection instance of HttpUrlConnection from following redirects so that</span>
  <span class="token comment" spellcheck="true">// redirects will be handled by recursive calls to this method, loadDataWithRedirects.</span>
  urlConnection<span class="token punctuation">.</span><span class="token function">setInstanceFollowRedirects</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Connect explicitly to avoid errors in decoders if connection fails.</span>
  urlConnection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// Set the stream so that it's closed in cleanup to avoid resource leaks. See #2352.</span>
  stream <span class="token operator">=</span> urlConnection<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isCancelled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">final</span> <span class="token keyword">int</span> statusCode <span class="token operator">=</span> urlConnection<span class="token punctuation">.</span><span class="token function">getResponseCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isHttpOk</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 请求成功</span>
    <span class="token comment" spellcheck="true">// 获取 InputStream</span>
    <span class="token keyword">return</span> <span class="token function">getStreamForSuccessfulRequest</span><span class="token punctuation">(</span>urlConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isHttpRedirect</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 重定向请求</span>
    String redirectUrlString <span class="token operator">=</span> urlConnection<span class="token punctuation">.</span><span class="token function">getHeaderField</span><span class="token punctuation">(</span><span class="token string">"Location"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>redirectUrlString<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span><span class="token string">"Received empty or null redirect url"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    URL redirectUrl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> redirectUrlString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Closing the stream specifically is required to avoid leaking ResponseBodys in addition</span>
    <span class="token comment" spellcheck="true">// to disconnecting the url connection below. See #2352.</span>
    <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">loadDataWithRedirects</span><span class="token punctuation">(</span>redirectUrl<span class="token punctuation">,</span> redirects <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>statusCode <span class="token operator">==</span> INVALID_STATUS_CODE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpException</span><span class="token punctuation">(</span>urlConnection<span class="token punctuation">.</span><span class="token function">getResponseMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> statusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/*HttpUrlFetcher*/</span>
<span class="token keyword">private</span> InputStream <span class="token function">getStreamForSuccessfulRequest</span><span class="token punctuation">(</span>HttpURLConnection urlConnection<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>TextUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>urlConnection<span class="token punctuation">.</span><span class="token function">getContentEncoding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> contentLength <span class="token operator">=</span> urlConnection<span class="token punctuation">.</span><span class="token function">getContentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stream <span class="token operator">=</span> ContentLengthInputStream<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>urlConnection<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> contentLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Log<span class="token punctuation">.</span><span class="token function">isLoggable</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> Log<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Got non empty content encoding: "</span> <span class="token operator">+</span> urlConnection<span class="token punctuation">.</span><span class="token function">getContentEncoding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    stream <span class="token operator">=</span> urlConnection<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> stream<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>可以看到，原来 Glide 底层是采用 HttpURLConnection 来进行网络请求的，请求成功后返回了 InputStream。</p>
<ul>
<li><p><strong>HttpUrlFetcher#loadData() 中的关注点（2）</strong><br>现在 InputStream 已经拿到了，回去关注点（2）中看下是怎么将 InputStream 回调出去的。<br>关注点（2）调用 callback.onDataReady(result) 会走如下一系列调用：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*MultiModelLoader*/</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDataReady</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Data data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 执行这里</span>
      callback<span class="token punctuation">.</span><span class="token function">onDataReady</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">startNextOrFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/*SourceGenerator*/</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startNextLoad</span><span class="token punctuation">(</span><span class="token keyword">final</span> LoadData<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> toStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  loadData<span class="token punctuation">.</span>fetcher<span class="token punctuation">.</span><span class="token function">loadData</span><span class="token punctuation">(</span>
      helper<span class="token punctuation">.</span><span class="token function">getPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">DataCallback</span><span class="token operator">&lt;</span>Object<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDataReady</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Object data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCurrentRequest</span><span class="token punctuation">(</span>toStart<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 执行这里</span>
            <span class="token function">onDataReadyInternal</span><span class="token punctuation">(</span>toStart<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLoadFailed</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Exception e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCurrentRequest</span><span class="token punctuation">(</span>toStart<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">onLoadFailedInternal</span><span class="token punctuation">(</span>toStart<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/*SourceGenerator*/</span>
<span class="token keyword">void</span> <span class="token function">onDataReadyInternal</span><span class="token punctuation">(</span>LoadData<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> loadData<span class="token punctuation">,</span> Object data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  DiskCacheStrategy diskCacheStrategy <span class="token operator">=</span> helper<span class="token punctuation">.</span><span class="token function">getDiskCacheStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> diskCacheStrategy<span class="token punctuation">.</span><span class="token function">isDataCacheable</span><span class="token punctuation">(</span>loadData<span class="token punctuation">.</span>fetcher<span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dataToCache <span class="token operator">=</span> data<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// We might be being called back on someone else's thread. Before doing anything, we should</span>
    <span class="token comment" spellcheck="true">// reschedule to get back onto Glide's thread.</span>
    cb<span class="token punctuation">.</span><span class="token function">reschedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 执行这里</span>
    cb<span class="token punctuation">.</span><span class="token function">onDataFetcherReady</span><span class="token punctuation">(</span>
        loadData<span class="token punctuation">.</span>sourceKey<span class="token punctuation">,</span>
        data<span class="token punctuation">,</span>
        loadData<span class="token punctuation">.</span>fetcher<span class="token punctuation">,</span>
        loadData<span class="token punctuation">.</span>fetcher<span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        originalKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/*DecodeJob*/</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDataFetcherReady</span><span class="token punctuation">(</span>
    Key sourceKey<span class="token punctuation">,</span> Object data<span class="token punctuation">,</span> DataFetcher<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> fetcher<span class="token punctuation">,</span> DataSource dataSource<span class="token punctuation">,</span> Key attemptedKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>currentSourceKey <span class="token operator">=</span> sourceKey<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>currentData <span class="token operator">=</span> data<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>currentFetcher <span class="token operator">=</span> fetcher<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>currentDataSource <span class="token operator">=</span> dataSource<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>currentAttemptingKey <span class="token operator">=</span> attemptedKey<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> currentThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    runReason <span class="token operator">=</span> RunReason<span class="token punctuation">.</span>DECODE_DATA<span class="token punctuation">;</span>
    callback<span class="token punctuation">.</span><span class="token function">reschedule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    GlideTrace<span class="token punctuation">.</span><span class="token function">beginSection</span><span class="token punctuation">(</span><span class="token string">"DecodeJob.decodeFromRetrievedData"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// （1）解码</span>
      <span class="token function">decodeFromRetrievedData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      GlideTrace<span class="token punctuation">.</span><span class="token function">endSection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>可以看到，经过一系列调用，最终走到关注点（1），这里就开始解码数据了，点进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*DecodeJob*/</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">decodeFromRetrievedData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Resource<span class="token operator">&lt;</span>R<span class="token operator">></span> resource <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//（1）解码</span>
      resource <span class="token operator">=</span> <span class="token function">decodeFromData</span><span class="token punctuation">(</span>currentFetcher<span class="token punctuation">,</span> currentData<span class="token punctuation">,</span> currentDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">GlideException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token function">setLoggingDetails</span><span class="token punctuation">(</span>currentAttemptingKey<span class="token punctuation">,</span> currentDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
      throwables<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//（2）解码完成，通知下去</span>
      <span class="token function">notifyEncodeAndRelease</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> currentDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">runGenerators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里标记了 2 个关注点，分别如下：</p>
<ul>
<li><p><strong>DecodeJob#decodeFromRetrievedData() 中的关注点（1）</strong><br>点击关注点（1）进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*DecodeJob*/</span>
<span class="token keyword">private</span> <span class="token operator">&lt;</span>Data<span class="token operator">></span> Resource<span class="token operator">&lt;</span>R<span class="token operator">></span> <span class="token function">decodeFromData</span><span class="token punctuation">(</span>
    DataFetcher<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> fetcher<span class="token punctuation">,</span> Data data<span class="token punctuation">,</span> DataSource dataSource<span class="token punctuation">)</span> <span class="token keyword">throws</span> GlideException <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">long</span> startTime <span class="token operator">=</span> LogTime<span class="token punctuation">.</span><span class="token function">getLogTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Resource<span class="token operator">&lt;</span>R<span class="token operator">></span> result <span class="token operator">=</span> <span class="token function">decodeFromFetcher</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Log<span class="token punctuation">.</span><span class="token function">isLoggable</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> Log<span class="token punctuation">.</span>VERBOSE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">logWithTimeAndKey</span><span class="token punctuation">(</span><span class="token string">"Decoded result "</span> <span class="token operator">+</span> result<span class="token punctuation">,</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    fetcher<span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/*DecodeJob*/</span>
<span class="token keyword">private</span> <span class="token operator">&lt;</span>Data<span class="token operator">></span> Resource<span class="token operator">&lt;</span>R<span class="token operator">></span> <span class="token function">decodeFromFetcher</span><span class="token punctuation">(</span>Data data<span class="token punctuation">,</span> DataSource dataSource<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> GlideException <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 获取解码器，解码器里面封装了 DecodePath，它就是用来解码转码的</span>
  LoadPath<span class="token operator">&lt;</span>Data<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> R<span class="token operator">></span> path <span class="token operator">=</span> decodeHelper<span class="token punctuation">.</span><span class="token function">getLoadPath</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>Data<span class="token operator">></span><span class="token punctuation">)</span> data<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 通过解码器解析数据</span>
  <span class="token keyword">return</span> <span class="token function">runLoadPath</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> dataSource<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/*DecodeJob*/</span>
<span class="token keyword">private</span> <span class="token operator">&lt;</span>Data<span class="token punctuation">,</span> ResourceType<span class="token operator">></span> Resource<span class="token operator">&lt;</span>R<span class="token operator">></span> <span class="token function">runLoadPath</span><span class="token punctuation">(</span>
    Data data<span class="token punctuation">,</span> DataSource dataSource<span class="token punctuation">,</span> LoadPath<span class="token operator">&lt;</span>Data<span class="token punctuation">,</span> ResourceType<span class="token punctuation">,</span> R<span class="token operator">></span> path<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> GlideException <span class="token punctuation">{</span>
  Options options <span class="token operator">=</span> <span class="token function">getOptionsWithHardwareConfig</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  DataRewinder<span class="token operator">&lt;</span>Data<span class="token operator">></span> rewinder <span class="token operator">=</span> glideContext<span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRewinder</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ResourceType in DecodeCallback below is required for compilation to work with gradle.</span>
    <span class="token comment" spellcheck="true">// 将解码任务传递给 LoadPath 完成</span>
    <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>
        rewinder<span class="token punctuation">,</span> options<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DecodeCallback</span><span class="token operator">&lt;</span>ResourceType<span class="token operator">></span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    rewinder<span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/*LoadPath*/</span>
<span class="token keyword">public</span> Resource<span class="token operator">&lt;</span>Transcode<span class="token operator">></span> <span class="token function">load</span><span class="token punctuation">(</span>
    DataRewinder<span class="token operator">&lt;</span>Data<span class="token operator">></span> rewinder<span class="token punctuation">,</span>
    <span class="token annotation punctuation">@NonNull</span> Options options<span class="token punctuation">,</span>
    <span class="token keyword">int</span> width<span class="token punctuation">,</span>
    <span class="token keyword">int</span> height<span class="token punctuation">,</span>
    DecodePath<span class="token punctuation">.</span>DecodeCallback<span class="token operator">&lt;</span>ResourceType<span class="token operator">></span> decodeCallback<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> GlideException <span class="token punctuation">{</span>
  List<span class="token operator">&lt;</span>Throwable<span class="token operator">></span> throwables <span class="token operator">=</span> Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>listPool<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">loadWithExceptionList</span><span class="token punctuation">(</span>rewinder<span class="token punctuation">,</span> options<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> decodeCallback<span class="token punctuation">,</span> throwables<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    listPool<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>throwables<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/*LoadPath*/</span>
<span class="token keyword">private</span> Resource<span class="token operator">&lt;</span>Transcode<span class="token operator">></span> <span class="token function">loadWithExceptionList</span><span class="token punctuation">(</span>
    DataRewinder<span class="token operator">&lt;</span>Data<span class="token operator">></span> rewinder<span class="token punctuation">,</span>
    <span class="token annotation punctuation">@NonNull</span> Options options<span class="token punctuation">,</span>
    <span class="token keyword">int</span> width<span class="token punctuation">,</span>
    <span class="token keyword">int</span> height<span class="token punctuation">,</span>
    DecodePath<span class="token punctuation">.</span>DecodeCallback<span class="token operator">&lt;</span>ResourceType<span class="token operator">></span> decodeCallback<span class="token punctuation">,</span>
    List<span class="token operator">&lt;</span>Throwable<span class="token operator">></span> exceptions<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> GlideException <span class="token punctuation">{</span>
  Resource<span class="token operator">&lt;</span>Transcode<span class="token operator">></span> result <span class="token operator">=</span> null<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">//noinspection ForLoopReplaceableByForEach to improve perf</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> size <span class="token operator">=</span> decodePaths<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    DecodePath<span class="token operator">&lt;</span>Data<span class="token punctuation">,</span> ResourceType<span class="token punctuation">,</span> Transcode<span class="token operator">></span> path <span class="token operator">=</span> decodePaths<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 开始解析数据</span>
      result <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>rewinder<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> options<span class="token punctuation">,</span> decodeCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">GlideException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      exceptions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">GlideException</span><span class="token punctuation">(</span>failureMessage<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>exceptions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>可以看到，上面主要是获取解码器（LoadPath），然后解码器里面是封装了 DecodePath，经过一系列调用，最后其实是交给 DecodePath 的 decode() 方法来真正开始解析数据的。</p>
<p>点击 decode() 方法进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*DecodePath*/</span>
  <span class="token keyword">public</span> Resource<span class="token operator">&lt;</span>Transcode<span class="token operator">></span> <span class="token function">decode</span><span class="token punctuation">(</span>
      DataRewinder<span class="token operator">&lt;</span>DataType<span class="token operator">></span> rewinder<span class="token punctuation">,</span>
      <span class="token keyword">int</span> width<span class="token punctuation">,</span>
      <span class="token keyword">int</span> height<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> Options options<span class="token punctuation">,</span>
      DecodeCallback<span class="token operator">&lt;</span>ResourceType<span class="token operator">></span> callback<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> GlideException <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//（1）</span>
    Resource<span class="token operator">&lt;</span>ResourceType<span class="token operator">></span> decoded <span class="token operator">=</span> <span class="token function">decodeResource</span><span class="token punctuation">(</span>rewinder<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//（2）</span>
    Resource<span class="token operator">&lt;</span>ResourceType<span class="token operator">></span> transformed <span class="token operator">=</span> callback<span class="token punctuation">.</span><span class="token function">onResourceDecoded</span><span class="token punctuation">(</span>decoded<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//（3）</span>
    <span class="token keyword">return</span> transcoder<span class="token punctuation">.</span><span class="token function">transcode</span><span class="token punctuation">(</span>transformed<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里我标记了 3 个关注点，分别如下：</p>
<ul>
<li><p><strong>DecodePath#decode() 中的关注点（1）</strong><br>这里是一个解码过程，主要是将原始数据解码成原始图片。点进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*DecodePath*/</span>
<span class="token keyword">private</span> Resource<span class="token operator">&lt;</span>ResourceType<span class="token operator">></span> <span class="token function">decodeResource</span><span class="token punctuation">(</span>
    DataRewinder<span class="token operator">&lt;</span>DataType<span class="token operator">></span> rewinder<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Options options<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> GlideException <span class="token punctuation">{</span>
  List<span class="token operator">&lt;</span>Throwable<span class="token operator">></span> exceptions <span class="token operator">=</span> Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>listPool<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">decodeResourceWithList</span><span class="token punctuation">(</span>rewinder<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> options<span class="token punctuation">,</span> exceptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    listPool<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>exceptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/*DecodePath*/</span>
<span class="token keyword">private</span> Resource<span class="token operator">&lt;</span>ResourceType<span class="token operator">></span> <span class="token function">decodeResourceWithList</span><span class="token punctuation">(</span>
    DataRewinder<span class="token operator">&lt;</span>DataType<span class="token operator">></span> rewinder<span class="token punctuation">,</span>
    <span class="token keyword">int</span> width<span class="token punctuation">,</span>
    <span class="token keyword">int</span> height<span class="token punctuation">,</span>
    <span class="token annotation punctuation">@NonNull</span> Options options<span class="token punctuation">,</span>
    List<span class="token operator">&lt;</span>Throwable<span class="token operator">></span> exceptions<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> GlideException <span class="token punctuation">{</span>
  Resource<span class="token operator">&lt;</span>ResourceType<span class="token operator">></span> result <span class="token operator">=</span> null<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">//noinspection ForLoopReplaceableByForEach to improve perf</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> size <span class="token operator">=</span> decoders<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ResourceDecoder<span class="token operator">&lt;</span>DataType<span class="token punctuation">,</span> ResourceType<span class="token operator">></span> decoder <span class="token operator">=</span> decoders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      DataType data <span class="token operator">=</span> rewinder<span class="token punctuation">.</span><span class="token function">rewindAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>decoder<span class="token punctuation">.</span><span class="token function">handles</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data <span class="token operator">=</span> rewinder<span class="token punctuation">.</span><span class="token function">rewindAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 关注点</span>
        result <span class="token operator">=</span> decoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment" spellcheck="true">// Some decoders throw unexpectedly. If they do, we shouldn't fail the entire load path, but</span>
      <span class="token comment" spellcheck="true">// instead log and continue. See #2406 for an example.</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> RuntimeException <span class="token operator">|</span> OutOfMemoryError e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token punctuation">}</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>可以看到，这里遍历拿到可以解码当前数据的资源解码器，然后调用 decode() 方法进行解码。因为当前数据是 InputStream，所以这里遍历拿到的 ResourceDecoder 其实是 StreamBitmapDecoder，所以调用的是 StreamBitmapDecoder#decode()。</p>
<p>继续看 StreamBitmapDecoder#decode()：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*StreamBitmapDecoder*/</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> Resource<span class="token operator">&lt;</span>Bitmap<span class="token operator">></span> <span class="token function">decode</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> InputStream source<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Options options<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">// Use to fix the mark limit to avoid allocating buffers that fit entire images.</span>
    <span class="token keyword">final</span> RecyclableBufferedInputStream bufferedStream<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> ownsBufferedStream<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token keyword">instanceof</span> <span class="token class-name">RecyclableBufferedInputStream</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      bufferedStream <span class="token operator">=</span> <span class="token punctuation">(</span>RecyclableBufferedInputStream<span class="token punctuation">)</span> source<span class="token punctuation">;</span>
      ownsBufferedStream <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      bufferedStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RecyclableBufferedInputStream</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> byteArrayPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ownsBufferedStream <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Use to retrieve exceptions thrown while reading.</span>
    <span class="token comment" spellcheck="true">// TODO(#126): when the framework no longer returns partially decoded Bitmaps or provides a</span>
    <span class="token comment" spellcheck="true">// way to determine if a Bitmap is partially decoded, consider removing.</span>
    ExceptionCatchingInputStream exceptionStream <span class="token operator">=</span>
        ExceptionCatchingInputStream<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>bufferedStream<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Use to read data.</span>
    <span class="token comment" spellcheck="true">// Ensures that we can always reset after reading an image header so that we can still</span>
    <span class="token comment" spellcheck="true">// attempt to decode the full image even when the header decode fails and/or overflows our read</span>
    <span class="token comment" spellcheck="true">// buffer. See #283.</span>
    MarkEnforcingInputStream invalidatingStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MarkEnforcingInputStream</span><span class="token punctuation">(</span>exceptionStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    UntrustedCallbacks callbacks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UntrustedCallbacks</span><span class="token punctuation">(</span>bufferedStream<span class="token punctuation">,</span> exceptionStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// （1）</span>
      <span class="token keyword">return</span> downsampler<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>invalidatingStream<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> options<span class="token punctuation">,</span> callbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      exceptionStream<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ownsBufferedStream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bufferedStream<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/*Downsampler*/</span>
  <span class="token keyword">public</span> Resource<span class="token operator">&lt;</span>Bitmap<span class="token operator">></span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
      <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/*Downsampler*/</span>
  <span class="token keyword">private</span> Resource<span class="token operator">&lt;</span>Bitmap<span class="token operator">></span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
      <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// （2）根据输入流解码得到 Bitmap</span>
      Bitmap result <span class="token operator">=</span>
          <span class="token function">decodeFromWrappedStreams</span><span class="token punctuation">(</span>
              imageReader<span class="token punctuation">,</span>
              bitmapFactoryOptions<span class="token punctuation">,</span>
              downsampleStrategy<span class="token punctuation">,</span>
              decodeFormat<span class="token punctuation">,</span>
              preferredColorSpace<span class="token punctuation">,</span>
              isHardwareConfigAllowed<span class="token punctuation">,</span>
              requestedWidth<span class="token punctuation">,</span>
              requestedHeight<span class="token punctuation">,</span>
              fixBitmapToRequestedDimensions<span class="token punctuation">,</span>
              callbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// （3）将 Bitmap 包装成 Resource&lt;Bitmap> 返回</span>
      <span class="token keyword">return</span> BitmapResource<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> bitmapPool<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token function">releaseOptions</span><span class="token punctuation">(</span>bitmapFactoryOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
      byteArrayPool<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>bytesForOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，关注点（1）中调用了 Downsampler#decode()，然后走到关注点（2）将输入流解码得到 Bitmap，最后将 Bitmap 包装成 Resource<bitmap> 返回。关注点（2）中其实就是使用 BitmapFactory 根据 exif 方向对图像进行下采样，解码和旋转，最后调用原生的 BitmapFactory#decodeStream() 得到的 Bitmap，里面的细节就不展开了。</bitmap></p>
<ul>
<li><strong>DecodePath#decode() 中的关注点（2）</strong><br>这里会调用 callback#onResourceDecoded() 进行回调，这里是回调到 DecodeJob#onResourceDecoded()：<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*DecodeJob*/</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> Resource<span class="token operator">&lt;</span>Z<span class="token operator">></span> <span class="token function">onResourceDecoded</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Resource<span class="token operator">&lt;</span>Z<span class="token operator">></span> decoded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> DecodeJob<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onResourceDecoded</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">,</span> decoded<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>继续跟进：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*DecodeJob*/</span>
  <span class="token operator">&lt;</span>Z<span class="token operator">></span> Resource<span class="token operator">&lt;</span>Z<span class="token operator">></span> <span class="token function">onResourceDecoded</span><span class="token punctuation">(</span>DataSource dataSource<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Resource<span class="token operator">&lt;</span>Z<span class="token operator">></span> decoded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
    Class<span class="token operator">&lt;</span>Z<span class="token operator">></span> resourceSubClass <span class="token operator">=</span> <span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>Z<span class="token operator">></span><span class="token punctuation">)</span> decoded<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Transformation<span class="token operator">&lt;</span>Z<span class="token operator">></span> appliedTransformation <span class="token operator">=</span> null<span class="token punctuation">;</span>
    Resource<span class="token operator">&lt;</span>Z<span class="token operator">></span> transformed <span class="token operator">=</span> decoded<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 如果不是从磁盘缓存中获取的，则需要对资源进行转换</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dataSource <span class="token operator">!=</span> DataSource<span class="token punctuation">.</span>RESOURCE_DISK_CACHE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      appliedTransformation <span class="token operator">=</span> decodeHelper<span class="token punctuation">.</span><span class="token function">getTransformation</span><span class="token punctuation">(</span>resourceSubClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
      transformed <span class="token operator">=</span> appliedTransformation<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>glideContext<span class="token punctuation">,</span> decoded<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// TODO: Make this the responsibility of the Transformation.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>decoded<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>transformed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      decoded<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> EncodeStrategy encodeStrategy<span class="token punctuation">;</span>
    <span class="token keyword">final</span> ResourceEncoder<span class="token operator">&lt;</span>Z<span class="token operator">></span> encoder<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>decodeHelper<span class="token punctuation">.</span><span class="token function">isResourceEncoderAvailable</span><span class="token punctuation">(</span>transformed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      encoder <span class="token operator">=</span> decodeHelper<span class="token punctuation">.</span><span class="token function">getResultEncoder</span><span class="token punctuation">(</span>transformed<span class="token punctuation">)</span><span class="token punctuation">;</span>
      encodeStrategy <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">getEncodeStrategy</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      encoder <span class="token operator">=</span> null<span class="token punctuation">;</span>
      encodeStrategy <span class="token operator">=</span> EncodeStrategy<span class="token punctuation">.</span>NONE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Resource<span class="token operator">&lt;</span>Z<span class="token operator">></span> result <span class="token operator">=</span> transformed<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 缓存相关</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，这里的任务是对资源进行转换，也就是我们请求的时候如果配置了 centerCrop、fitCenter 等，这里就需要转换成对应的资源。</p>
<ul>
<li><strong>DecodePath#decode() 中的关注点（3）</strong><br>关注点（3） transcoder.transcode(transformed, options) 中的 transcoder 为 BitmapDrawableTranscoder，所以这里调用的是 BitmapDrawableTranscoder#transcode()：<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*BitmapDrawableTranscoder*/</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> Resource<span class="token operator">&lt;</span>BitmapDrawable<span class="token operator">></span> <span class="token function">transcode</span><span class="token punctuation">(</span>
    <span class="token annotation punctuation">@NonNull</span> Resource<span class="token operator">&lt;</span>Bitmap<span class="token operator">></span> toTranscode<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Options options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> LazyBitmapDrawableResource<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>resources<span class="token punctuation">,</span> toTranscode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>继续往下跟：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*LazyBitmapDrawableResource*/</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Resource<span class="token operator">&lt;</span>BitmapDrawable<span class="token operator">></span> <span class="token function">obtain</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Resources resources<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Resource<span class="token operator">&lt;</span>Bitmap<span class="token operator">></span> bitmapResource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bitmapResource <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LazyBitmapDrawableResource</span><span class="token punctuation">(</span>resources<span class="token punctuation">,</span> bitmapResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/*LazyBitmapDrawableResource*/</span>
  <span class="token keyword">private</span> <span class="token function">LazyBitmapDrawableResource</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Resources resources<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Resource<span class="token operator">&lt;</span>Bitmap<span class="token operator">></span> bitmapResource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resources <span class="token operator">=</span> Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>resources<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bitmapResource <span class="token operator">=</span> Preconditions<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>bitmapResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为 LazyBitmapDrawableResource 实现了 Resource<bitmapdrawable>，所以最后是返回了一个 Resource<bitmapdrawable>，也就是说转码这一步是将 Resource<bitmap> 转成了 Resource<bitmapdrawable>。</bitmapdrawable></bitmap></bitmapdrawable></bitmapdrawable></p>
<p>到这里，DecodeJob#decodeFromRetrievedData() 中的关注点（1）解码的流程就走完了，我们回去继续看关注点（2）。</p>
<ul>
<li><strong>DecodeJob#decodeFromRetrievedData() 中的关注点（2）</strong><br>这里我再贴一下之前的代码：<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*DecodeJob*/</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">decodeFromRetrievedData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Resource<span class="token operator">&lt;</span>R<span class="token operator">></span> resource <span class="token operator">=</span> null<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//（1）解码</span>
    resource <span class="token operator">=</span> <span class="token function">decodeFromData</span><span class="token punctuation">(</span>currentFetcher<span class="token punctuation">,</span> currentData<span class="token punctuation">,</span> currentDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">GlideException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">setLoggingDetails</span><span class="token punctuation">(</span>currentAttemptingKey<span class="token punctuation">,</span> currentDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    throwables<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//（2）解码完成，通知下去</span>
    <span class="token function">notifyEncodeAndRelease</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> currentDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">runGenerators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>刚刚关注点（1）的解码过程已经完成，现在需要通知下去了，点击 notifyEncodeAndRelease() 方法进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*DecodeJob*/</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">notifyEncodeAndRelease</span><span class="token punctuation">(</span>Resource<span class="token operator">&lt;</span>R<span class="token operator">></span> resource<span class="token punctuation">,</span> DataSource dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token keyword">instanceof</span> <span class="token class-name">Initializable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>Initializable<span class="token punctuation">)</span> resource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Resource<span class="token operator">&lt;</span>R<span class="token operator">></span> result <span class="token operator">=</span> resource<span class="token punctuation">;</span>
    LockedResource<span class="token operator">&lt;</span>R<span class="token operator">></span> lockedResource <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>deferredEncodeManager<span class="token punctuation">.</span><span class="token function">hasResourceToEncode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      lockedResource <span class="token operator">=</span> LockedResource<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span> lockedResource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// （1）通知外面已经完成了</span>
    <span class="token function">notifyComplete</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

    stage <span class="token operator">=</span> Stage<span class="token punctuation">.</span>ENCODE<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>deferredEncodeManager<span class="token punctuation">.</span><span class="token function">hasResourceToEncode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 将资源缓存到磁盘</span>
        deferredEncodeManager<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>diskCacheProvider<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>lockedResource <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lockedResource<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// Call onEncodeComplete outside the finally block so that it's not called if the encode process</span>
    <span class="token comment" spellcheck="true">// throws.</span>
    <span class="token comment" spellcheck="true">// 完成，释放各种资源</span>
    <span class="token function">onEncodeComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>点击关注点（1）进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*DecodeJob*/</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">notifyComplete</span><span class="token punctuation">(</span>Resource<span class="token operator">&lt;</span>R<span class="token operator">></span> resource<span class="token punctuation">,</span> DataSource dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setNotifiedOrThrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    callback<span class="token punctuation">.</span><span class="token function">onResourceReady</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的 callback 只有一个实现类就是 EngineJob，所以直接看 EngineJob#onResourceReady()：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*EngineJob*/</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResourceReady</span><span class="token punctuation">(</span>Resource<span class="token operator">&lt;</span>R<span class="token operator">></span> resource<span class="token punctuation">,</span> DataSource dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>resource <span class="token operator">=</span> resource<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>dataSource <span class="token operator">=</span> dataSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 通知结果回调</span>
    <span class="token function">notifyCallbacksOfResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>继续跟进：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*EngineJob*/</span>
  <span class="token keyword">void</span> <span class="token function">notifyCallbacksOfResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ResourceCallbacksAndExecutors copy<span class="token punctuation">;</span>
    Key localKey<span class="token punctuation">;</span>
    EngineResource<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> localResource<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      stateVerifier<span class="token punctuation">.</span><span class="token function">throwIfRecycled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// 如果取消，则回收和释放资源</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isCancelled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resource<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cbs<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Received a resource without any callbacks to notify"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>hasResource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Already have resource"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      engineResource <span class="token operator">=</span> engineResourceFactory<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> isCacheable<span class="token punctuation">,</span> key<span class="token punctuation">,</span> resourceListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
      hasResource <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      copy <span class="token operator">=</span> cbs<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">incrementPendingCallbacks</span><span class="token punctuation">(</span>copy<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      localKey <span class="token operator">=</span> key<span class="token punctuation">;</span>
      localResource <span class="token operator">=</span> engineResource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//（1）</span>
    engineJobListener<span class="token punctuation">.</span><span class="token function">onEngineJobComplete</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> localKey<span class="token punctuation">,</span> localResource<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//（2）</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> ResourceCallbackAndExecutor entry <span class="token operator">:</span> copy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      entry<span class="token punctuation">.</span>executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CallResourceReady</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">decrementPendingCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里标记了 2 个关注点，分别如下：</p>
<ul>
<li><p><strong>EngineJob#notifyCallbacksOfResult() 中的关注点（1）</strong><br>这里表示 EngineJob 完成了，回调给 Engine，进入 onEngineJobComplete() 看看：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*Engine*/</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">onEngineJobComplete</span><span class="token punctuation">(</span>
    EngineJob<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> engineJob<span class="token punctuation">,</span> Key key<span class="token punctuation">,</span> EngineResource<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> resource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// A null resource indicates that the load failed, usually due to an exception.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> resource<span class="token punctuation">.</span><span class="token function">isMemoryCacheable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    activeResources<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  jobs<span class="token punctuation">.</span><span class="token function">removeIfCurrent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> engineJob<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/*ActiveResources*/</span>
<span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">activate</span><span class="token punctuation">(</span>Key key<span class="token punctuation">,</span> EngineResource<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> resource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ResourceWeakReference toPut <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">ResourceWeakReference</span><span class="token punctuation">(</span>
          key<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> resourceReferenceQueue<span class="token punctuation">,</span> isActiveResourceRetentionAllowed<span class="token punctuation">)</span><span class="token punctuation">;</span>

  ResourceWeakReference removed <span class="token operator">=</span> activeEngineResources<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> toPut<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>removed <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    removed<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>这里主要判断是否配置了内存缓存，有的话就存到活动缓存中。</p>
<ul>
<li><strong>EngineJob#notifyCallbacksOfResult() 中的关注点（2）</strong><br>我这里再贴一下 notifyCallbacksOfResult() 方法中与关注点（2）有关的代码：<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*EngineJob*/</span>
<span class="token keyword">void</span> <span class="token function">notifyCallbacksOfResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ResourceCallbacksAndExecutors copy<span class="token punctuation">;</span>
  <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    copy <span class="token operator">=</span> cbs<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">//（2）</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> ResourceCallbackAndExecutor entry <span class="token operator">:</span> copy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    entry<span class="token punctuation">.</span>executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CallResourceReady</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>可以看到，这里遍历 copy 后拿到了线程池的执行器（entry.executor），copy 是上面一行 copy = cbs.copy(); 得到的，我们利用<strong>反推</strong>看下这个线程池的执行器是怎么来的：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// 1. cbs.copy()</span>
    <span class="token comment" spellcheck="true">/*ResourceCallbacksAndExecutors*/</span>
    ResourceCallbacksAndExecutors <span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResourceCallbacksAndExecutors</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>callbacksAndExecutors<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 2. callbacksAndExecutors 集合是哪里添加元素的</span>
    <span class="token comment" spellcheck="true">/*ResourceCallbacksAndExecutors*/</span>
    <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span>ResourceCallback cb<span class="token punctuation">,</span> Executor executor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      callbacksAndExecutors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResourceCallbackAndExecutor</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 3. 上面的 add() 方法是哪里调用的</span>
  <span class="token comment" spellcheck="true">/*EngineJob*/</span>
  <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token keyword">final</span> ResourceCallback cb<span class="token punctuation">,</span> Executor callbackExecutor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cbs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 4. 上面的 addCallback() 方法是哪里调用的</span>
  <span class="token comment" spellcheck="true">/*Engine*/</span>
  <span class="token keyword">private</span> <span class="token operator">&lt;</span>R<span class="token operator">></span> LoadStatus <span class="token function">waitForExistingOrStartNewJob</span><span class="token punctuation">(</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      Executor callbackExecutor<span class="token punctuation">,</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>

    engineJob<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> callbackExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LoadStatus</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> engineJob<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里我们反推了 4 步，发现是从 waitForExistingOrStartNewJob() 方法那里传进来的，继续往后推的代码就不列出来了，最后发现是从 into() 方法哪里传过来的（可以自己正序再跟踪一遍源码）：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RequestBuilder*/</span>
  <span class="token keyword">public</span> ViewTarget<span class="token operator">&lt;</span>ImageView<span class="token punctuation">,</span> TranscodeType<span class="token operator">></span> <span class="token function">into</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> ImageView view<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> <span class="token function">into</span><span class="token punctuation">(</span>
        glideContext<span class="token punctuation">.</span><span class="token function">buildImageViewTarget</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> transcodeClass<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">/*targetListener=*/</span> null<span class="token punctuation">,</span>
        requestOptions<span class="token punctuation">,</span>
        Executors<span class="token punctuation">.</span><span class="token function">mainThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>也就是这里的 Executors.mainThreadExecutor()，点进去看看是什么：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Executors</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Executor MAIN_THREAD_EXECUTOR <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">Executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> Handler handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>Looper<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Runnable command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          handler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/** Posts executions to the main thread. */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> Executor <span class="token function">mainThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> MAIN_THREAD_EXECUTOR<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>原来这里是创建了一个 Executor 的实例，然后重写了 execute() 方法，但是里面却用的是主线程中的 Handler 来 post() 一个任务，也就是<strong>切换到了主线程</strong>去执行了。</p>
<p>再回到关注点（2），发现执行这一句 entry.executor.execute(new CallResourceReady(entry.cb)) 实际执行的是 handler.post(command)，所以 CallResourceReady 中的 run() 方法是在主线程中执行的。真是想不到呀，原来<strong>子线程切换到主线程</strong>在一开始的 into() 方法中就做了铺垫！</p>
<p>那么我们继续往下看，进入 CallResourceReady#run()：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*EngineJob*/</span>
  <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">CallResourceReady</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>cb<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>EngineJob<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>cbs<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            engineResource<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 关注点</span>
            <span class="token function">callCallbackOnResourceReady</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">removeCallback</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token function">decrementPendingCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>继续跟进：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*EngineJob*/</span>
  <span class="token keyword">void</span> <span class="token function">callCallbackOnResourceReady</span><span class="token punctuation">(</span>ResourceCallback cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 资源准备好了，回调给上一层</span>
      cb<span class="token punctuation">.</span><span class="token function">onResourceReady</span><span class="token punctuation">(</span>engineResource<span class="token punctuation">,</span> dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CallbackException</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面会回调到 SingleRequest#onResourceReady()，进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*SingleRequest*/</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResourceReady</span><span class="token punctuation">(</span>Resource<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> resource<span class="token punctuation">,</span> DataSource dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    stateVerifier<span class="token punctuation">.</span><span class="token function">throwIfRecycled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Resource<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> toRelease <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>requestLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        loadStatus <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resource <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          GlideException exception <span class="token operator">=</span>
              <span class="token keyword">new</span> <span class="token class-name">GlideException</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">onLoadFailed</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Object received <span class="token operator">=</span> resource<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>received <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>transcodeClass<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>received<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          toRelease <span class="token operator">=</span> resource<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>resource <span class="token operator">=</span> null<span class="token punctuation">;</span>
          GlideException exception <span class="token operator">=</span>
              <span class="token keyword">new</span> <span class="token class-name">GlideException</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">onLoadFailed</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canSetResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          toRelease <span class="token operator">=</span> resource<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>resource <span class="token operator">=</span> null<span class="token punctuation">;</span>
          status <span class="token operator">=</span> Status<span class="token punctuation">.</span>COMPLETE<span class="token punctuation">;</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 关注点</span>
        <span class="token function">onResourceReady</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Resource<span class="token operator">&lt;</span>R<span class="token operator">></span><span class="token punctuation">)</span> resource<span class="token punctuation">,</span> <span class="token punctuation">(</span>R<span class="token punctuation">)</span> received<span class="token punctuation">,</span> dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>toRelease <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        engine<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span>toRelease<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，前面是一些加载失败的判断，看下最后的 onResourceReady()：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*SingleRequest*/</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">onResourceReady</span><span class="token punctuation">(</span>Resource<span class="token operator">&lt;</span>R<span class="token operator">></span> resource<span class="token punctuation">,</span> R result<span class="token punctuation">,</span> DataSource dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">boolean</span> anyListenerHandledUpdatingTarget <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>requestListeners <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>RequestListener<span class="token operator">&lt;</span>R<span class="token operator">></span> listener <span class="token operator">:</span> requestListeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          anyListenerHandledUpdatingTarget <span class="token operator">|=</span>
              listener<span class="token punctuation">.</span><span class="token function">onResourceReady</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> model<span class="token punctuation">,</span> target<span class="token punctuation">,</span> dataSource<span class="token punctuation">,</span> isFirstResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      anyListenerHandledUpdatingTarget <span class="token operator">|=</span>
          targetListener <span class="token operator">!=</span> null
              <span class="token operator">&amp;&amp;</span> targetListener<span class="token punctuation">.</span><span class="token function">onResourceReady</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> model<span class="token punctuation">,</span> target<span class="token punctuation">,</span> dataSource<span class="token punctuation">,</span> isFirstResource<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>anyListenerHandledUpdatingTarget<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Transition<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> R<span class="token operator">></span> animation <span class="token operator">=</span> animationFactory<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">,</span> isFirstResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 回调给 ImageViewTarget</span>
        target<span class="token punctuation">.</span><span class="token function">onResourceReady</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> animation<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      isCallingCallbacks <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 通知加载成功</span>
    <span class="token function">notifyLoadSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的 target 为 ImageViewTarget，进入 ImageViewTarget#onResourceReady() 看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*ImageViewTarget*/</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResourceReady</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Z resource<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Transition<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> Z<span class="token operator">></span> transition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>transition <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>transition<span class="token punctuation">.</span><span class="token function">transition</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setResourceInternal</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">maybeUpdateAnimatable</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">/*ImageViewTarget*/</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setResourceInternal</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Z resource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">maybeUpdateAnimatable</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为在前面 “2.3.1 GlideContext#buildImageViewTarget()” 中创建的 ImageViewTarget 的实现类是 DrawableImageViewTarget，所以这里调用的是 DrawableImageViewTarget#setResource()，点进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*DrawableImageViewTarget*/</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setResource</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Drawable resource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    view<span class="token punctuation">.</span><span class="token function">setImageDrawable</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>到这里终于将图片显示到我们的 ImageView 中了！into() 方法也结束了。</p>
<h4 id="2-3-4-小结"><a href="#2-3-4-小结" class="headerlink" title="2.3.4 小结"></a>2.3.4 小结</h4><p>要我总结的话，只能说 into() 方法实在是太复杂了，with() 与 load() 方法在它面前就是小喽喽。<br>into() 方法主要做了发起网络请求、缓存数据、解码并显示图片。</p>
<p>大概流程为：<br>发起网络请求前先判断是否有内存缓存，有则直接从内存缓存那里获取数据进行显示，没有则判断是否有磁盘缓存；有磁盘缓存则直接从磁盘缓存那里获取数据进行显示，没有才发起网络请求；网络请求成功后将返回的数据存储到内存与磁盘缓存（如果有配置），最后将返回的输入流解码成 Drawable 显示在 ImageView 上。</p>
<h2 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h2><p>Glide 源码相对于我之前写的其他源码文章来说确实难啃，但是耐心看完发现收获也很多。例如利用一个隐藏的 Fragment 来管理 Glide 请求的生命周期，利用四级缓存来提升加载图片的效率，还有网络请求成功后是在哪里切换到主线程的等等。</p>
<p>参考资料：</p>
<ul>
<li><a href="https://muyangmin.github.io/glide-docs-cn/" target="_blank" rel="noopener">glide-docs-cn</a></li>
<li><a href="https://blog.csdn.net/sinyu890807/category_9268670.html" target="_blank" rel="noopener">Glide最全解析</a></li>
</ul>

            </div>
            <hr />

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《Android 主流开源框架（六）Glide 的执行流程源码解析》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/blog/71588abf.html" property="cc:attributionName"
               rel="cc:attributionURL">
                wildma
            </a> 采用
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    
    <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '9e627d72c12c6434d27d',
        clientSecret: '334ca6c96cf471a12c6f343b50c23eccb5e94c05',
        repo: 'wildma.github.io',
        owner: 'wildma',
        admin: "wildma",
        id: 'blog/71588abf.html',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    
    <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script> -->

<script>
    new Valine({
        el: '#vcomments',
        appId: '',
        appKey: '',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'false' === 'true',
        avatar: 'wavatar',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '如果你没有GitHub账号，还可以在这里评论啦！'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/blog/376183ad.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="Android 主流开源框架（七）Glide 的缓存机制">
                        
                        <span class="card-title">Android 主流开源框架（七）Glide 的缓存机制</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言最近有个想法——就是把 Android 主流开源框架进行深入分析，然后写成一系列文章，包括该框架的详细使用与源码解析。目的是通过鉴赏大神的源码来了解框架底层的原理，也就是做到不仅要知其然，还要知其所以然。
这里我说下自己阅读源码的经验，
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-05-17
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android主流开源框架/" class="post-category" target="_blank">
                                    Android主流开源框架
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Glide/" target="_blank">
                        <span class="chip bg-color">Glide</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/blog/f1e2edad.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="全部文章">
                        
                        <span class="card-title">全部文章</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            2020
17 May 2020 » Android 主流开源框架（七）Glide 的缓存机制
10 May 2020 » Android 主流开源框架（六）Glide 的执行流程源码解析

2019
03 Nov 2019 » Andro
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-11-03
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/全部文章/" class="post-category" target="_blank">
                                    全部文章
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: wildma的博客<br />'
            + '作者: wildma<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; 2019 wildma. All Rights Reserved.

            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">112k</span>
            
            
            
            <br>
            
            <span id="busuanzi_container_site_pv" style='display:none'>
                <i class="fa fa-heart-o"></i>
                本站访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
            <span id="busuanzi_container_site_uv" style='display:none'>
                次
            </span>
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/wildma" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:wildma.me@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>









    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 16666;
        var uvcountOffset = 20000;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2019, 09, 29, 00, 00, 00); //北京时间2019-9-29 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>



    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', '');
</script>



    
    <script src="/libs/others/clicklove.js"></script>
    

    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 雪花特效 -->
    

</body>

</html>