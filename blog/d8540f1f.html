<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 主流开源框架（三）OkHttp 源码解析, Android 知识分享">
    <meta name="baidu-site-verification" content="FLsnLJ6eF1">
    <meta name="google-site-verification" content="16Gna8-Ho0L5gq5QusQ01kiKooeZUaUSmH--RyCrrro">
    <meta name="360-site-verification" content>
    <meta name="description" content="前言最近有个想法——就是把 Android 主流开源框架进行深入分析，然后写成一系列文章，包括该框架的详细使用与源码解析。目的是通过鉴赏大神的源码来了解框架底层的原理，也就是做到不仅要知其然，还要知其所以然。
这里我说下自己阅读源码的经验，">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 主流开源框架（三）OkHttp 源码解析 | wildma的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?46e79e71af0709a5b9106bf20cecc493";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <span class="logo-span">wildma的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <div class="logo-name">wildma的博客</div>
        <div class="logo-desc">
            
            Android 知识分享
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                友情链接
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                留言板
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/wildma" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/wildma" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/0.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 主流开源框架（三）OkHttp 源码解析
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                        <a href="/tags/OkHttp/" target="_blank">
                            <span class="chip bg-color">OkHttp</span>
                        </a>
                        
                        <a href="/tags/网络编程/" target="_blank">
                            <span class="chip bg-color">网络编程</span>
                        </a>
                        
                        <a href="/tags/源码解析/" target="_blank">
                            <span class="chip bg-color">源码解析</span>
                        </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                        <a href="/categories/Android/" class="post-category" target="_blank">
                            Android
                        </a>
                        
                        <a href="/categories/Android/网络编程/" class="post-category" target="_blank">
                            网络编程
                        </a>
                        
                        <a href="/categories/Android/网络编程/源码解析/" class="post-category" target="_blank">
                            源码解析
                        </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-10-21
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    wildma
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    10.8k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    48 分
                </div>
                
                

                
                <div id="busuanzi_container_page_pv" class="info-break-policy">
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>
                </div>
                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近有个想法——就是把 Android 主流开源框架进行深入分析，然后写成一系列文章，包括该框架的详细使用与源码解析。目的是通过鉴赏大神的源码来了解框架底层的原理，也就是做到不仅要知其然，还要知其所以然。</p>
<p>这里我说下自己阅读源码的经验，我一般都是按照平时使用某个框架或者某个系统源码的使用流程入手的，首先要知道怎么使用，然后再去深究每一步底层做了什么，用了哪些好的设计模式，为什么要这么设计。</p>
<p>系列文章：</p>
<ul>
<li><a href="https://wildma.github.io/blog/ec018646.html">Android 主流开源框架（一）OkHttp 铺垫-HttpClient 与 HttpURLConnection 使用详解</a></li>
<li><a href="https://wildma.github.io/blog/6d0008b.html">Android 主流开源框架（二）OkHttp 使用详解</a></li>
<li><a href="https://wildma.github.io/blog/d8540f1f.html">Android 主流开源框架（三）OkHttp 源码解析</a></li>
<li>Android 主流开源框架（四）Retrofit 使用详解（更新中…）</li>
<li>Android 主流开源框架（五）Retrofit 源码解析（更新中…）</li>
<li>更多框架持续更新中…</li>
</ul>
<p>更多干货请关注 <a href="https://github.com/wildma/AndroidNotes" target="_blank" rel="noopener">AndroidNotes</a></p>
<h1 id="一、OkHttp-的基本使用示例"><a href="#一、OkHttp-的基本使用示例" class="headerlink" title="一、OkHttp 的基本使用示例"></a>一、OkHttp 的基本使用示例</h1><h2 id="1-1-同步-GET-请求"><a href="#1-1-同步-GET-请求" class="headerlink" title="1.1 同步 GET 请求"></a>1.1 同步 GET 请求</h2><pre class="line-numbers language-java"><code class="language-java"> <span class="token comment" spellcheck="true">// （1）创建 OkHttpClient 对象</span>
OkHttpClient client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment" spellcheck="true">// （2）创建 Request 对象</span>
Request request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// （3）创建 Call 对象。</span>
Call call <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// （4）发送请求并获取服务器返回的数据</span>
Response response <span class="token operator">=</span> call<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment" spellcheck="true">// （5）取出相应的数据</span>
String data <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="1-2-异步-GET-请求"><a href="#1-2-异步-GET-请求" class="headerlink" title="1.2 异步 GET 请求"></a>1.2 异步 GET 请求</h2><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// （1）创建 OkHttpClient 对象</span>
OkHttpClient client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// （2）创建 Request 对象</span>
Request request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// （3）创建 Call 对象。</span>
Call call <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// （4）发送请求并获取服务器返回的数据</span>
call<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailure</span><span class="token punctuation">(</span>Call call<span class="token punctuation">,</span> IOException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResponse</span><span class="token punctuation">(</span>Call call<span class="token punctuation">,</span> Response response<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// （5）取出相应的数据</span>
        String data <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到不管是同步请求还是异步请求，OkHttp 的基本使用就只有 5 步。同步请求与异步请求唯一不同的就是第 （4） 步，前者使用同步方法 execute()，后者使用异步方法 enqueue()。接下来我们就根据这 5 步进行源码阅读。</p>
<p>更多 OkHttp 的使用方法可以看我之前写的文章 <a href="https://wildma.github.io/blog/6d0008b.html">Android 主流开源框架（二）OkHttp 使用详解</a></p>
<h1 id="二、OkHttp-源码分析"><a href="#二、OkHttp-源码分析" class="headerlink" title="二、OkHttp 源码分析"></a>二、OkHttp 源码分析</h1><p>源码版本：3.11.0</p>
<h2 id="2-1-（1）创建-OkHttpClient-对象"><a href="#2-1-（1）创建-OkHttpClient-对象" class="headerlink" title="2.1 （1）创建 OkHttpClient 对象"></a>2.1 （1）创建 OkHttpClient 对象</h2><pre class="line-numbers language-java"><code class="language-java">OkHttpClient client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>首先我们点击创建的 OkHttpClient 对象进去源码是这样的：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*OkHttpClient*/</span>
  <span class="token keyword">public</span> <span class="token function">OkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后是走了有参构造：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*OkHttpClient*/</span>
  <span class="token function">OkHttpClient</span><span class="token punctuation">(</span>Builder builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dispatcher <span class="token operator">=</span> builder<span class="token punctuation">.</span>dispatcher<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>proxy <span class="token operator">=</span> builder<span class="token punctuation">.</span>proxy<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>protocols <span class="token operator">=</span> builder<span class="token punctuation">.</span>protocols<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>connectionSpecs <span class="token operator">=</span> builder<span class="token punctuation">.</span>connectionSpecs<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors <span class="token operator">=</span> Util<span class="token punctuation">.</span><span class="token function">immutableList</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>interceptors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>networkInterceptors <span class="token operator">=</span> Util<span class="token punctuation">.</span><span class="token function">immutableList</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>networkInterceptors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>eventListenerFactory <span class="token operator">=</span> builder<span class="token punctuation">.</span>eventListenerFactory<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>proxySelector <span class="token operator">=</span> builder<span class="token punctuation">.</span>proxySelector<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cookieJar <span class="token operator">=</span> builder<span class="token punctuation">.</span>cookieJar<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cache <span class="token operator">=</span> builder<span class="token punctuation">.</span>cache<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>internalCache <span class="token operator">=</span> builder<span class="token punctuation">.</span>internalCache<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>socketFactory <span class="token operator">=</span> builder<span class="token punctuation">.</span>socketFactory<span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> isTLS <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>ConnectionSpec spec <span class="token operator">:</span> connectionSpecs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isTLS <span class="token operator">=</span> isTLS <span class="token operator">||</span> spec<span class="token punctuation">.</span><span class="token function">isTls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>builder<span class="token punctuation">.</span>sslSocketFactory <span class="token operator">!=</span> null <span class="token operator">||</span> <span class="token operator">!</span>isTLS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>sslSocketFactory <span class="token operator">=</span> builder<span class="token punctuation">.</span>sslSocketFactory<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>certificateChainCleaner <span class="token operator">=</span> builder<span class="token punctuation">.</span>certificateChainCleaner<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      X509TrustManager trustManager <span class="token operator">=</span> Util<span class="token punctuation">.</span><span class="token function">platformTrustManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>sslSocketFactory <span class="token operator">=</span> <span class="token function">newSslSocketFactory</span><span class="token punctuation">(</span>trustManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>certificateChainCleaner <span class="token operator">=</span> CertificateChainCleaner<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>trustManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sslSocketFactory <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Platform<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">configureSslSocketFactory</span><span class="token punctuation">(</span>sslSocketFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>hostnameVerifier <span class="token operator">=</span> builder<span class="token punctuation">.</span>hostnameVerifier<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>certificatePinner <span class="token operator">=</span> builder<span class="token punctuation">.</span>certificatePinner<span class="token punctuation">.</span><span class="token function">withCertificateChainCleaner</span><span class="token punctuation">(</span>
        certificateChainCleaner<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>proxyAuthenticator <span class="token operator">=</span> builder<span class="token punctuation">.</span>proxyAuthenticator<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>authenticator <span class="token operator">=</span> builder<span class="token punctuation">.</span>authenticator<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>connectionPool <span class="token operator">=</span> builder<span class="token punctuation">.</span>connectionPool<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dns <span class="token operator">=</span> builder<span class="token punctuation">.</span>dns<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>followSslRedirects <span class="token operator">=</span> builder<span class="token punctuation">.</span>followSslRedirects<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>followRedirects <span class="token operator">=</span> builder<span class="token punctuation">.</span>followRedirects<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>retryOnConnectionFailure <span class="token operator">=</span> builder<span class="token punctuation">.</span>retryOnConnectionFailure<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>connectTimeout <span class="token operator">=</span> builder<span class="token punctuation">.</span>connectTimeout<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>readTimeout <span class="token operator">=</span> builder<span class="token punctuation">.</span>readTimeout<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>writeTimeout <span class="token operator">=</span> builder<span class="token punctuation">.</span>writeTimeout<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pingInterval <span class="token operator">=</span> builder<span class="token punctuation">.</span>pingInterval<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>interceptors<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Null interceptor: "</span> <span class="token operator">+</span> interceptors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>networkInterceptors<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Null network interceptor: "</span> <span class="token operator">+</span> networkInterceptors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到有很多常量，这里使用了建造者模式，所以这些常量可以通过 build() 进行配置。如果不进行配置则使用无参构造中传进来的默认配置，每个常量的意思具体如下：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/*OkHttpClient*/</span>
    <span class="token keyword">public</span> <span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dispatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 分发器</span>
      protocols <span class="token operator">=</span> DEFAULT_PROTOCOLS<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// HTTP 协议</span>
      connectionSpecs <span class="token operator">=</span> DEFAULT_CONNECTION_SPECS<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 传输层版本和连接协议</span>
      eventListenerFactory <span class="token operator">=</span> EventListener<span class="token punctuation">.</span><span class="token function">factory</span><span class="token punctuation">(</span>EventListener<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 事件监听工厂</span>
      proxySelector <span class="token operator">=</span> ProxySelector<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 代理选择器</span>
      cookieJar <span class="token operator">=</span> CookieJar<span class="token punctuation">.</span>NO_COOKIES<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// cookie</span>
      socketFactory <span class="token operator">=</span> SocketFactory<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// socket 工厂</span>
      hostnameVerifier <span class="token operator">=</span> OkHostnameVerifier<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 主机名字确认</span>
      certificatePinner <span class="token operator">=</span> CertificatePinner<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 证书链</span>
      proxyAuthenticator <span class="token operator">=</span> Authenticator<span class="token punctuation">.</span>NONE<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 代理服务器身份验证</span>
      authenticator <span class="token operator">=</span> Authenticator<span class="token punctuation">.</span>NONE<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 源服务器身份验证</span>
      connectionPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 连接池</span>
      dns <span class="token operator">=</span> Dns<span class="token punctuation">.</span>SYSTEM<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 域名</span>
      followSslRedirects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 是否遵循 ssl 重定向</span>
      followRedirects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 是否遵循重定向</span>
      retryOnConnectionFailure <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 连接失败的时候是否重试</span>
      connectTimeout <span class="token operator">=</span> 10_000<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 连接超时</span>
      readTimeout <span class="token operator">=</span> 10_000<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 读超时</span>
      writeTimeout <span class="token operator">=</span> 10_000<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 写超时</span>
      pingInterval <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// HTTP / 2 和 Web 套接字 ping 之间的时间间隔</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-2-（2）创建-Request-对象"><a href="#2-2-（2）创建-Request-对象" class="headerlink" title="2.2 （2）创建 Request 对象"></a>2.2 （2）创建 Request 对象</h2><pre class="line-numbers language-java"><code class="language-java">Request request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>可以看到，这里同样使用了建造者模式，我们点击 Request 进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*Request*/</span>
  <span class="token comment" spellcheck="true">//...</span>
  <span class="token keyword">final</span> HttpUrl url<span class="token punctuation">;</span>
  <span class="token keyword">final</span> String method<span class="token punctuation">;</span>
  <span class="token keyword">final</span> Headers headers<span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token annotation punctuation">@Nullable</span> RequestBody body<span class="token punctuation">;</span>
  <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">,</span> Object<span class="token operator">></span> tags<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">//...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发现 Request 还是比较简单的，只是用来设置一些请求链接（url）、请求方法（method）、请求头（headers）、请求体（body）、标签（tag，可作为取消请求的标记）。</p>
<h2 id="2-3-（3）创建-Call-对象"><a href="#2-3-（3）创建-Call-对象" class="headerlink" title="2.3 （3）创建 Call 对象"></a>2.3 （3）创建 Call 对象</h2><pre class="line-numbers language-java"><code class="language-java">Call call <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们点击 newCall() 方法进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*OkHttpClient*/</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> Call <span class="token function">newCall</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> RealCall<span class="token punctuation">.</span><span class="token function">newRealCall</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* for web socket */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>发现是调用了 RealCall 的 newRealCall() 方法，并传入了 OkHttpClient 与 Request 对象。</p>
<p>再跟进到 newRealCall() 方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RealCall*/</span>
  <span class="token keyword">static</span> RealCall <span class="token function">newRealCall</span><span class="token punctuation">(</span>OkHttpClient client<span class="token punctuation">,</span> Request originalRequest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> forWebSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Safely publish the Call instance to the EventListener.</span>
    RealCall call <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RealCall</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> originalRequest<span class="token punctuation">,</span> forWebSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    call<span class="token punctuation">.</span>eventListener <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">eventListenerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> call<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发现是创建了一个 RealCall 对象，并返回给上一层。RealCall 是 Call 的实现类，Call 定义了请求相关的操作，例如同步异步、取消请求等方法。所以后续的请求相关操作基本都是在调用 Call 定义的方法，而这些方法真正的执行是它的实现类 RealCall。</p>
<p>最后看看 RealCall 的构造函数，该函数是比较简单的，只是赋值一些常量，然后创建了重试与重定向拦截器（RetryAndFollowUpInterceptor）（这个后面会讲）：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RealCall*/</span>
  <span class="token keyword">private</span> <span class="token function">RealCall</span><span class="token punctuation">(</span>OkHttpClient client<span class="token punctuation">,</span> Request originalRequest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> forWebSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> client<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>originalRequest <span class="token operator">=</span> originalRequest<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>forWebSocket <span class="token operator">=</span> forWebSocket<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>retryAndFollowUpInterceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RetryAndFollowUpInterceptor</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> forWebSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-4-（4）发送请求并获取服务器返回的数据"><a href="#2-4-（4）发送请求并获取服务器返回的数据" class="headerlink" title="2.4 （4）发送请求并获取服务器返回的数据"></a>2.4 （4）发送请求并获取服务器返回的数据</h2><p>前面我们已经说了，同步请求与异步请求唯一不同的就是第 （4） 步，前者使用同步方法 execute()，后者使用异步方法 enqueue()。所以我们分 2 种情况来讲。</p>
<h3 id="2-4-1-同步请求"><a href="#2-4-1-同步请求" class="headerlink" title="2.4.1 同步请求"></a>2.4.1 同步请求</h3><pre class="line-numbers language-java"><code class="language-java">Response response <span class="token operator">=</span> call<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们点击 execute() 方法进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RealCall*/</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> Response <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>executed<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Already Executed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      executed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">captureCallStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    eventListener<span class="token punctuation">.</span><span class="token function">callStart</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      client<span class="token punctuation">.</span><span class="token function">dispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">executed</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// (1)</span>
      Response result <span class="token operator">=</span> <span class="token function">getResponseWithInterceptorChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// (2)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Canceled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      eventListener<span class="token punctuation">.</span><span class="token function">callFailed</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      client<span class="token punctuation">.</span><span class="token function">dispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finished</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// (3)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>源码中我标注了 3 个关注点，点击关注点（1）的 executed() 方法进去，可以看到是将传进来的 RealCall 加入了一个双端队列：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*Dispatcher*/</span>
  <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">executed</span><span class="token punctuation">(</span>RealCall call<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    runningSyncCalls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中 runningSyncCalls 是一个双端队列，用来记录正在运行的同步请求队列：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*Dispatcher*/</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> Deque<span class="token operator">&lt;</span>RealCall<span class="token operator">></span> runningSyncCalls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>关注点（2）返回了一个 Response，也就是服务器返回的数据，说明请求就是在这里执行了，这个是我们要研究的重点，放到后面再说。</p>
<p>点击关注点（3）的 finished() 方法进去，是这样的：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*Dispatcher*/</span>
  <span class="token keyword">void</span> <span class="token function">finished</span><span class="token punctuation">(</span>RealCall call<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">finished</span><span class="token punctuation">(</span>runningSyncCalls<span class="token punctuation">,</span> call<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">void</span> <span class="token function">finished</span><span class="token punctuation">(</span>Deque<span class="token operator">&lt;</span>T<span class="token operator">></span> calls<span class="token punctuation">,</span> T call<span class="token punctuation">,</span> <span class="token keyword">boolean</span> promoteCalls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> runningCallsCount<span class="token punctuation">;</span>
    Runnable idleCallback<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>calls<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span><span class="token string">"Call wasn't in-flight!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// (1)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>promoteCalls<span class="token punctuation">)</span> <span class="token function">promoteCalls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      runningCallsCount <span class="token operator">=</span> <span class="token function">runningCallsCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      idleCallback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>idleCallback<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>runningCallsCount <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> idleCallback <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      idleCallback<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到关注点（1）calls.remove(call) 只是把当前 RealCall 又从正在运行的同步请求队列中移除了，说明请求已经完成了。</p>
<p>你应该注意到了，上面还有个 dispatcher 没讲到，其实这是一个分发器，是用来对请求进行分发的。我们刚刚也分析了在同步请求中涉及到的 dispatcher 只是用来记录正在运行的同步请求队列，然后请求完成就移除掉。所以这个分发器主要用在异步请求中，我们放到异步请求中再去讲。</p>
<h3 id="2-4-2-异步请求"><a href="#2-4-2-异步请求" class="headerlink" title="2.4.2 异步请求"></a>2.4.2 异步请求</h3><pre class="line-numbers language-java"><code class="language-java">        call<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailure</span><span class="token punctuation">(</span>Call call<span class="token punctuation">,</span> IOException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResponse</span><span class="token punctuation">(</span>Call call<span class="token punctuation">,</span> Response response<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们点击 enqueue() 方法进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RealCall*/</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enqueue</span><span class="token punctuation">(</span>Callback responseCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>executed<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Already Executed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      executed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">captureCallStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    eventListener<span class="token punctuation">.</span><span class="token function">callStart</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">dispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AsyncCall</span><span class="token punctuation">(</span>responseCallback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// (1)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>前面几行与同步请求源码一样，我们点击关注点（1）的 enqueue() 方法进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*Dispatcher*/</span>
  <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">enqueue</span><span class="token punctuation">(</span>AsyncCall call<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>runningAsyncCalls<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> maxRequests <span class="token operator">&amp;&amp;</span> <span class="token function">runningCallsForHost</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span> <span class="token operator">&lt;</span> maxRequestsPerHost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      runningAsyncCalls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">executorService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      readyAsyncCalls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到这里面涉及到很多 Dispatcher 对象里面的常量与变量，所以也能看出 Dispatcher 主要用在异步请求中。先看下 Dispatcher 对象里面的常量与变量：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*Dispatcher*/</span>
  <span class="token comment" spellcheck="true">// 最大并发请求数</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> maxRequests <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 每个主机最大请求数</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> maxRequestsPerHost <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 每次调度程序变为空闲时调用的回调</span>
  <span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> Runnable idleCallback<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 用来执行异步任务的线程池</span>
  <span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> ExecutorService executorService<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 准备中的异步请求队列</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Deque<span class="token operator">&lt;</span>AsyncCall<span class="token operator">></span> readyAsyncCalls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 正在运行的异步请求队列</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Deque<span class="token operator">&lt;</span>AsyncCall<span class="token operator">></span> runningAsyncCalls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 正在运行的同步请求队列</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Deque<span class="token operator">&lt;</span>RealCall<span class="token operator">></span> runningSyncCalls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>弄懂了这些常量与变量的意思，就很好理解上面关注点（1）的 enqueue() 方法了，即如果 ”正在运行的异步请求队列数“ 小于 ”最大并发请求数“，并且 ”每个主机正在运行的请求数“ 小于 ”每个主机最大请求数“，则将当前请求继续加入 ”正在运行的异步请求队列“ 并在线程池中执行，否则将当前请求加入 ”准备中的异步请求队列“。</p>
<p>我们看到线程池中还传了一个 AsyncCall 进去，点击进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RealCall*/</span>
  <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">AsyncCall</span> <span class="token keyword">extends</span> <span class="token class-name">NamedRunnable</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> Callback responseCallback<span class="token punctuation">;</span>

    <span class="token function">AsyncCall</span><span class="token punctuation">(</span>Callback responseCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token string">"OkHttp %s"</span><span class="token punctuation">,</span> <span class="token function">redactedUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>responseCallback <span class="token operator">=</span> responseCallback<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    String <span class="token function">host</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> originalRequest<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">host</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Request <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> originalRequest<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    RealCall <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> RealCall<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span> <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">boolean</span> signalledCallback <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        Response response <span class="token operator">=</span> <span class="token function">getResponseWithInterceptorChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// (1)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>retryAndFollowUpInterceptor<span class="token punctuation">.</span><span class="token function">isCanceled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          signalledCallback <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          responseCallback<span class="token punctuation">.</span><span class="token function">onFailure</span><span class="token punctuation">(</span>RealCall<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Canceled"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// (2)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          signalledCallback <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          responseCallback<span class="token punctuation">.</span><span class="token function">onResponse</span><span class="token punctuation">(</span>RealCall<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// (3)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>signalledCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">// Do not signal the callback twice!</span>
          Platform<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>INFO<span class="token punctuation">,</span> <span class="token string">"Callback failure for "</span> <span class="token operator">+</span> <span class="token function">toLoggableString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          eventListener<span class="token punctuation">.</span><span class="token function">callFailed</span><span class="token punctuation">(</span>RealCall<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
          responseCallback<span class="token punctuation">.</span><span class="token function">onFailure</span><span class="token punctuation">(</span>RealCall<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// (4)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        client<span class="token punctuation">.</span><span class="token function">dispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finished</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// (5)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发现他是 RealCall 的内部类，继承 NamedRunnable，实现了 Runnable。里面同样执行了 execute() 方法，仔细看这个方法与之前我们阅读同步请求中的 execute() 类似，关注点（1）（5）都是一样的，不同的是多了 2 个回调，因为是异步请求，所以需要把最终返回的结果通过 responseCallback 回调到最外层我们使用的地方去，其中（2）（4）是失败的回调，（3）是成功的回调。</p>
<p>到这里，OkHttp 基本使用的第（4）步除了 getResponseWithInterceptorChain() 方法，其他都看完了，下面就重点阅读这个方法。</p>
<h3 id="2-4-3-拦截器"><a href="#2-4-3-拦截器" class="headerlink" title="2.4.3 拦截器"></a>2.4.3 拦截器</h3><p>点击 getResponseWithInterceptorChain() 方法进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RealCall*/</span>
  Response <span class="token function">getResponseWithInterceptorChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 创建一个拦截器集合</span>
    List<span class="token operator">&lt;</span>Interceptor<span class="token operator">></span> interceptors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 添加用户自定义的拦截器</span>
    interceptors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">interceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 添加重试与重定向拦截器</span>
    interceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>retryAndFollowUpInterceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 添加桥拦截器</span>
    interceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BridgeInterceptor</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">cookieJar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 添加缓存拦截器</span>
    interceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CacheInterceptor</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">internalCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 添加连接拦截器</span>
    interceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConnectInterceptor</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>forWebSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 添加用户自定义的网络拦截器</span>
      interceptors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">networkInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 添加服务器请求拦截器</span>
    interceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CallServerInterceptor</span><span class="token punctuation">(</span>forWebSocket<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// (1) 构建责任链</span>
    Interceptor<span class="token punctuation">.</span>Chain chain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RealInterceptorChain</span><span class="token punctuation">(</span>interceptors<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
        originalRequest<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> eventListener<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">connectTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        client<span class="token punctuation">.</span><span class="token function">readTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">writeTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// (2) 处理责任链中的拦截器</span>
    <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>originalRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，这里用到了很多拦截器，将这些拦截器构建成一条责任链，然后再一个个处理。这里用到了责任链模式，每个拦截器负责相应的功能，上一个拦截器完成会传给下一个拦截器，直到最后一个拦截器执行完再一层层向上返回 Response。</p>
<p>我们先验证下这个责任链的执行过程是否跟我说的一样，然后再看看每个拦截器的具体作用。这里我标记了 2 个关注点：<br>关注点（1）是构建一条责任链，并把责任链需要用到的参数传过去，其中参数 5 为责任链的索引，这里传 “0” 表示当前正在处理第一个拦截器。</p>
<p>关注点（2）是处理责任链中的拦截器，点击 proceed() 方法进去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RealInterceptorChain*/</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> Response <span class="token function">proceed</span><span class="token punctuation">(</span>Request request<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">proceed</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> streamAllocation<span class="token punctuation">,</span> httpCodec<span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> Response <span class="token function">proceed</span><span class="token punctuation">(</span>Request request<span class="token punctuation">,</span> StreamAllocation streamAllocation<span class="token punctuation">,</span> HttpCodec httpCodec<span class="token punctuation">,</span>
      RealConnection connection<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">>=</span> interceptors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    calls<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// If we already have a stream, confirm that the incoming request will use it.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>httpCodec <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">supportsUrl</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"network interceptor "</span> <span class="token operator">+</span> interceptors<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
          <span class="token operator">+</span> <span class="token string">" must retain the same host and port"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// If we already have a stream, confirm that this is the only call to chain.proceed().</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>httpCodec <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> calls <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"network interceptor "</span> <span class="token operator">+</span> interceptors<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
          <span class="token operator">+</span> <span class="token string">" must call proceed() exactly once"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//（1）start</span>
    RealInterceptorChain next <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RealInterceptorChain</span><span class="token punctuation">(</span>interceptors<span class="token punctuation">,</span> streamAllocation<span class="token punctuation">,</span> httpCodec<span class="token punctuation">,</span>
        connection<span class="token punctuation">,</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> call<span class="token punctuation">,</span> eventListener<span class="token punctuation">,</span> connectTimeout<span class="token punctuation">,</span> readTimeout<span class="token punctuation">,</span>
        writeTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Interceptor interceptor <span class="token operator">=</span> interceptors<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Response response <span class="token operator">=</span> interceptor<span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// （1）end</span>

    <span class="token comment" spellcheck="true">// Confirm that the next interceptor made its required call to chain.proceed().</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>httpCodec <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> index <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> interceptors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> next<span class="token punctuation">.</span>calls <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"network interceptor "</span> <span class="token operator">+</span> interceptor
          <span class="token operator">+</span> <span class="token string">" must call proceed() exactly once"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Confirm that the intercepted response isn't null.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>response <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">"interceptor "</span> <span class="token operator">+</span> interceptor <span class="token operator">+</span> <span class="token string">" returned null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
          <span class="token string">"interceptor "</span> <span class="token operator">+</span> interceptor <span class="token operator">+</span> <span class="token string">" returned a response with no body"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，除了一些判断只需要看关注点（1）即可。这里会构建一个新的责任链，然后把责任链的索引加 1（为了下次从拦截器集合中取出下一个拦截器），接着从拦截器集合中取出当前拦截器并调用 intercept() 方法，这样如果这个拦截器可以完成任务会马上返回 Response，否则会在 intercept() 方法中继续处理责任链，因为该 intercept() 方法中会继续调用责任链的 proceed() 方法。看完源码确实跟我们之前设想的一样的，接下来我们看看每个拦截器的具体作用。</p>
<h4 id="2-4-3-1-重试与重定向拦截器（RetryAndFollowUpInterceptor）"><a href="#2-4-3-1-重试与重定向拦截器（RetryAndFollowUpInterceptor）" class="headerlink" title="2.4.3.1 重试与重定向拦截器（RetryAndFollowUpInterceptor）"></a>2.4.3.1 重试与重定向拦截器（RetryAndFollowUpInterceptor）</h4><p>该拦截器主要负责失败后重连以及重定向，从前面的 proceed() 方法可知，每个拦截器被调用的方法都是 intercept() 方法，所以阅读拦截器的入口就是该方法。</p>
<p>重试与重定向拦截器中的 intercept() 方法如下：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RetryAndFollowUpInterceptor*/</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> Response <span class="token function">intercept</span><span class="token punctuation">(</span>Chain chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    Request request <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    RealInterceptorChain realChain <span class="token operator">=</span> <span class="token punctuation">(</span>RealInterceptorChain<span class="token punctuation">)</span> chain<span class="token punctuation">;</span>
    Call call <span class="token operator">=</span> realChain<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    EventListener eventListener <span class="token operator">=</span> realChain<span class="token punctuation">.</span><span class="token function">eventListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// (1) 创建 StreamAllocation 对象，用来协调三个实体（Connections、Streams、Calls）之间的关系</span>
    StreamAllocation streamAllocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamAllocation</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">connectionPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">createAddress</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> call<span class="token punctuation">,</span> eventListener<span class="token punctuation">,</span> callStackTrace<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>streamAllocation <span class="token operator">=</span> streamAllocation<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 重定向次数</span>
    <span class="token keyword">int</span> followUpCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    Response priorResponse <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>canceled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        streamAllocation<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Canceled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      Response response<span class="token punctuation">;</span>
      <span class="token keyword">boolean</span> releaseConnection <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true">//（2）执行下一个拦截器</span>
        response <span class="token operator">=</span> realChain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> streamAllocation<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        releaseConnection <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RouteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//（3）发生 Route 异常，则尝试进行恢复</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">recover</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getLastConnectException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> streamAllocation<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> e<span class="token punctuation">.</span><span class="token function">getFirstConnectException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        releaseConnection <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//（4）发生 IO 异常，则尝试进行恢复</span>
        <span class="token keyword">boolean</span> requestSendStarted <span class="token operator">=</span> <span class="token operator">!</span><span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">ConnectionShutdownException</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">recover</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> streamAllocation<span class="token punctuation">,</span> requestSendStarted<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        releaseConnection <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果中途出现异常，则释放所有资源</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>releaseConnection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          streamAllocation<span class="token punctuation">.</span><span class="token function">streamFailed</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
          streamAllocation<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">// 构建 body 为空的响应体</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>priorResponse <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        response <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">priorResponse</span><span class="token punctuation">(</span>priorResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      Request followUp<span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
     <span class="token comment" spellcheck="true">// （5）检查是否需要重定向，不需要则 followUp 返回 null</span>
        followUp <span class="token operator">=</span> <span class="token function">followUpRequest</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> streamAllocation<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        streamAllocation<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">// （6）不需要重定向，则返回之前的 response</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>followUp <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>forWebSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          streamAllocation<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment" spellcheck="true">// 关闭资源</span>
      <span class="token function">closeQuietly</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">// 重定向次数大于最大值，则释放 StreamAllocation 并抛出异常</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>followUpCount <span class="token operator">></span> MAX_FOLLOW_UPS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        streamAllocation<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ProtocolException</span><span class="token punctuation">(</span><span class="token string">"Too many follow-up requests: "</span> <span class="token operator">+</span> followUpCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>followUp<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">UnrepeatableRequestBody</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        streamAllocation<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">HttpRetryException</span><span class="token punctuation">(</span><span class="token string">"Cannot retry streamed HTTP body"</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">// 如果该请求无法复用之前的连接，则释放后重新创建</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">sameConnection</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> followUp<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        streamAllocation<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        streamAllocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamAllocation</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">connectionPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">createAddress</span><span class="token punctuation">(</span>followUp<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> call<span class="token punctuation">,</span> eventListener<span class="token punctuation">,</span> callStackTrace<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>streamAllocation <span class="token operator">=</span> streamAllocation<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>streamAllocation<span class="token punctuation">.</span><span class="token function">codec</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Closing the body of "</span> <span class="token operator">+</span> response
            <span class="token operator">+</span> <span class="token string">" didn't close its backing stream. Bad interceptor?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      request <span class="token operator">=</span> followUp<span class="token punctuation">;</span>
      priorResponse <span class="token operator">=</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该方法的注释都写的比较详细了，我们重点看下我标记的关注点。  </p>
<ul>
<li><p>（1）：创建 StreamAllocation 对象，StreamAllocation 相当于一个管理类，用来协调三个实体（Connections、Streams、Calls）之间的关系。这里还传了一个 client.connectionPool()，它是第一步创建 OkHttpClient 对象的时候创建的，是一个连接池。它们会在后面的连接拦截器（ConnectInterceptor）中才被真正的使用到，后面会讲。<br>其中：<br>Connections：连接到远程服务器的物理套接字。<br>Streams：在连接上分层的逻辑 http 请求/响应对。<br>Calls：流的逻辑序列，通常是初始请求以及它的重定向请求。</p>
</li>
<li><p>（2）：是执行下一个拦截器，按顺序调用那就是 BridgeInterceptor。</p>
</li>
<li><p>（3）（4）：发生 Route 或 IO 异常，则进行重试，我们看看重试的相关方法：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*RetryAndFollowUpInterceptor*/</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">recover</span><span class="token punctuation">(</span>IOException e<span class="token punctuation">,</span> StreamAllocation streamAllocation<span class="token punctuation">,</span>
    <span class="token keyword">boolean</span> requestSendStarted<span class="token punctuation">,</span> Request userRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  streamAllocation<span class="token punctuation">.</span><span class="token function">streamFailed</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 客户端配置了出错不再重试</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">.</span><span class="token function">retryOnConnectionFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 无法再次发送 request body</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>requestSendStarted <span class="token operator">&amp;&amp;</span> userRequest<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">UnrepeatableRequestBody</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 发生 isRecoverable() 方法中出现的异常</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isRecoverable</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> requestSendStarted<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 没有更多的路线可供尝试</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>streamAllocation<span class="token punctuation">.</span><span class="token function">hasMoreRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// For failure recovery, use the same route selector with a new connection.</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isRecoverable</span><span class="token punctuation">(</span>IOException e<span class="token punctuation">,</span> <span class="token keyword">boolean</span> requestSendStarted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 协议异常</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">ProtocolException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 中断异常</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">InterruptedIOException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> e <span class="token keyword">instanceof</span> <span class="token class-name">SocketTimeoutException</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>requestSendStarted<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// SSL握手异常</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">SSLHandshakeException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// If the problem was a CertificateException from the X509TrustManager,</span>
    <span class="token comment" spellcheck="true">// do not retry.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">CertificateException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// SSL握手未授权异常</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">SSLPeerUnverifiedException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// e.g. a certificate pinning error.</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// An example of one we might want to retry with a different route is a problem connecting to a</span>
  <span class="token comment" spellcheck="true">// proxy and would manifest as a standard IOException. Unless it is one we know we should not</span>
  <span class="token comment" spellcheck="true">// retry, we return true and try a new route.</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>可以看到尝试进行重试的时候，如果出现以下情况则不会重试：</p>
<ul>
<li><p>客户端配置了出错不再重试</p>
</li>
<li><p>无法再次发送 request body</p>
</li>
<li><p>发生 ProtocolException（协议异常）、InterruptedIOException（中断异常）、SSLHandshakeException（SSL握手异常）、SSLPeerUnverifiedException（SSL握手未授权异常）中的任意一个异常</p>
</li>
<li><p>没有更多的路线可供尝试</p>
</li>
<li><p>（5）（6）：检查是否需要重定向，如果不需要则返回之前的 response，需要则进行重定向，也就是继续循环请求重试。是否需要重定向主要根据响应码来决定，具体可以去看看 followUpRequest() 方法，这里就不贴代码了。</p>
</li>
</ul>
<p>ps：如果你想拿重定向的域名来跟一遍源码中重定向的流程，那么你可以试试郭霖的域名（<code>http://guolin.tech</code>）， 该域名会重定向到他的 csdn 博客（<code>https://blog.csdn.net/guolin_blog</code>）， 走一遍流程会让你对源码中重定向的原理有更深的理解。</p>
<h4 id="2-4-3-2-桥拦截器（BridgeInterceptor）"><a href="#2-4-3-2-桥拦截器（BridgeInterceptor）" class="headerlink" title="2.4.3.2 桥拦截器（BridgeInterceptor）"></a>2.4.3.2 桥拦截器（BridgeInterceptor）</h4><p>该拦截器相当于一个桥梁，首先将用户的请求转换为发给服务器的请求，然后使用该请求访问网络，最后将服务器返回的响应转换为用户可用的响应。</p>
<p>我们看看该拦截器中的 intercept() 方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*BridgeInterceptor*/</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> Response <span class="token function">intercept</span><span class="token punctuation">(</span>Chain chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    Request userRequest <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Request<span class="token punctuation">.</span>Builder requestBuilder <span class="token operator">=</span> userRequest<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//（1）将用户的请求转换为发给服务器的请求-start</span>
    RequestBody body <span class="token operator">=</span> userRequest<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>body <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      MediaType contentType <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>contentType <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        requestBuilder<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> contentType<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">long</span> contentLength <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">contentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>contentLength <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        requestBuilder<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Content-Length"</span><span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>contentLength<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        requestBuilder<span class="token punctuation">.</span><span class="token function">removeHeader</span><span class="token punctuation">(</span><span class="token string">"Transfer-Encoding"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        requestBuilder<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Transfer-Encoding"</span><span class="token punctuation">,</span> <span class="token string">"chunked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        requestBuilder<span class="token punctuation">.</span><span class="token function">removeHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Length"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>userRequest<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Host"</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      requestBuilder<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Host"</span><span class="token punctuation">,</span> <span class="token function">hostHeader</span><span class="token punctuation">(</span>userRequest<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>userRequest<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Connection"</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      requestBuilder<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Connection"</span><span class="token punctuation">,</span> <span class="token string">"Keep-Alive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

   <span class="token comment" spellcheck="true">// 如果我们在创建 Request 的时候添加了 "Accept-Encoding: gzip" 请求头，那么要自己负责解压缩传输流。</span>
    <span class="token keyword">boolean</span> transparentGzip <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userRequest<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Accept-Encoding"</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> userRequest<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Range"</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment" spellcheck="true">// 默认是 gzip 压缩</span>
      transparentGzip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      requestBuilder<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Accept-Encoding"</span><span class="token punctuation">,</span> <span class="token string">"gzip"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    List<span class="token operator">&lt;</span>Cookie<span class="token operator">></span> cookies <span class="token operator">=</span> cookieJar<span class="token punctuation">.</span><span class="token function">loadForRequest</span><span class="token punctuation">(</span>userRequest<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cookies<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      requestBuilder<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Cookie"</span><span class="token punctuation">,</span> <span class="token function">cookieHeader</span><span class="token punctuation">(</span>cookies<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>userRequest<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"User-Agent"</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      requestBuilder<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"User-Agent"</span><span class="token punctuation">,</span> Version<span class="token punctuation">.</span><span class="token function">userAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//（1）将用户的请求转换为发给服务器的请求-end</span>

    <span class="token comment" spellcheck="true">//（2）执行下一个拦截器进行网络请求</span>
    Response networkResponse <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>requestBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//（3）将服务器返回的响应转换为用户可用的响应-start</span>
    <span class="token comment" spellcheck="true">// 解析服务器返回的 header</span>
    HttpHeaders<span class="token punctuation">.</span><span class="token function">receiveHeaders</span><span class="token punctuation">(</span>cookieJar<span class="token punctuation">,</span> userRequest<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> networkResponse<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Response<span class="token punctuation">.</span>Builder responseBuilder <span class="token operator">=</span> networkResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>userRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// gzip 解压</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>transparentGzip
        <span class="token operator">&amp;&amp;</span> <span class="token string">"gzip"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>networkResponse<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Content-Encoding"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">&amp;&amp;</span> HttpHeaders<span class="token punctuation">.</span><span class="token function">hasBody</span><span class="token punctuation">(</span>networkResponse<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      GzipSource responseBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GzipSource</span><span class="token punctuation">(</span>networkResponse<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Headers strippedHeaders <span class="token operator">=</span> networkResponse<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span><span class="token string">"Content-Encoding"</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span><span class="token string">"Content-Length"</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      responseBuilder<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span>strippedHeaders<span class="token punctuation">)</span><span class="token punctuation">;</span>
      String contentType <span class="token operator">=</span> networkResponse<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      responseBuilder<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RealResponseBody</span><span class="token punctuation">(</span>contentType<span class="token punctuation">,</span> <span class="token operator">-</span>1L<span class="token punctuation">,</span> Okio<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span>responseBody<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//（3）将服务器返回的响应转换为用户可用的响应-end</span>

    <span class="token keyword">return</span> responseBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据我标记的关注点大概就是：</p>
<ul>
<li>（1）：将用户的请求转换为发给服务器的请求。主要是添加一些默认的请求头，例如 Content-Type、Content-Length、Transfer-Encoding、Host、Connection。因为我们在创建 Request 的时候可以不添加任何请求头，如果这里不加上一些默认的请求头是无法完成请求的。</li>
<li>（2）：执行下一个拦截器进行网络请求。</li>
<li>（3）：将服务器返回的响应转换为用户可用的响应。主要是解析服务器返回的 header，进行 gzip 解压。</li>
</ul>
<h4 id="2-4-3-3-缓存拦截器（CacheInterceptor）"><a href="#2-4-3-3-缓存拦截器（CacheInterceptor）" class="headerlink" title="2.4.3.3 缓存拦截器（CacheInterceptor）"></a>2.4.3.3 缓存拦截器（CacheInterceptor）</h4><p>该拦截器主要用来实现缓存的读取和存储，即进行网络请求的时候执行到缓存拦截器会先判断是否有缓存，如果有会直接返回缓存，没有则会执行后面的拦截器继续请求网络，请求成功会将请求到的数据缓存起来。</p>
<p>我们看看该拦截器中的 intercept() 方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*CacheInterceptor*/</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> Response <span class="token function">intercept</span><span class="token punctuation">(</span>Chain chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//（1）通过 Request 得到缓存</span>
    Response cacheCandidate <span class="token operator">=</span> cache <span class="token operator">!=</span> null
        <span class="token operator">?</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> null<span class="token punctuation">;</span>

    <span class="token keyword">long</span> now <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//（2）通过缓存策略获取是使用缓存还是使用网络请求，或者 2 者同时使用或都不使用</span>
    CacheStrategy strategy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheStrategy<span class="token punctuation">.</span>Factory</span><span class="token punctuation">(</span>now<span class="token punctuation">,</span> chain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cacheCandidate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Request networkRequest <span class="token operator">=</span> strategy<span class="token punctuation">.</span>networkRequest<span class="token punctuation">;</span>
    Response cacheResponse <span class="token operator">=</span> strategy<span class="token punctuation">.</span>cacheResponse<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cache<span class="token punctuation">.</span><span class="token function">trackResponse</span><span class="token punctuation">(</span>strategy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 有缓存，但是策略中不使用缓存，需要释放资源</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheCandidate <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> cacheResponse <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">closeQuietly</span><span class="token punctuation">(</span>cacheCandidate<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// （3）如果策略中不使用网络请求，也不使用缓存，那么直接返回失败</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>networkRequest <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> cacheResponse <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Response<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">protocol</span><span class="token punctuation">(</span>Protocol<span class="token punctuation">.</span>HTTP_1_1<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token number">504</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">"Unsatisfiable Request (only-if-cached)"</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>Util<span class="token punctuation">.</span>EMPTY_RESPONSE<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">sentRequestAtMillis</span><span class="token punctuation">(</span><span class="token operator">-</span>1L<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">receivedResponseAtMillis</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//（4）如果策略中不使用网络请求，执行到这里说明是使用缓存的，则直接返回缓存</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>networkRequest <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> cacheResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">cacheResponse</span><span class="token punctuation">(</span><span class="token function">stripBody</span><span class="token punctuation">(</span>cacheResponse<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Response networkResponse <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//（5）执行下一个拦截器进行网络请求</span>
      networkResponse <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>networkRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 如果发生 IO 或者其他崩溃，为了不泄漏缓存体，需要释放资源</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>networkResponse <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> cacheCandidate <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">closeQuietly</span><span class="token punctuation">(</span>cacheCandidate<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//（6）如果策略中使用缓存，并且响应码为 304，则返回缓存</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheResponse <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>networkResponse<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> HTTP_NOT_MODIFIED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Response response <span class="token operator">=</span> cacheResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token function">combine</span><span class="token punctuation">(</span>cacheResponse<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> networkResponse<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">sentRequestAtMillis</span><span class="token punctuation">(</span>networkResponse<span class="token punctuation">.</span><span class="token function">sentRequestAtMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">receivedResponseAtMillis</span><span class="token punctuation">(</span>networkResponse<span class="token punctuation">.</span><span class="token function">receivedResponseAtMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">cacheResponse</span><span class="token punctuation">(</span><span class="token function">stripBody</span><span class="token punctuation">(</span>cacheResponse<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">networkResponse</span><span class="token punctuation">(</span><span class="token function">stripBody</span><span class="token punctuation">(</span>networkResponse<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        networkResponse<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        cache<span class="token punctuation">.</span><span class="token function">trackConditionalCacheHit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 更新缓存</span>
        cache<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>cacheResponse<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">closeQuietly</span><span class="token punctuation">(</span>cacheResponse<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    Response response <span class="token operator">=</span> networkResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">cacheResponse</span><span class="token punctuation">(</span><span class="token function">stripBody</span><span class="token punctuation">(</span>cacheResponse<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">networkResponse</span><span class="token punctuation">(</span><span class="token function">stripBody</span><span class="token punctuation">(</span>networkResponse<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>HttpHeaders<span class="token punctuation">.</span><span class="token function">hasBody</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> CacheStrategy<span class="token punctuation">.</span><span class="token function">isCacheable</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> networkRequest<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//（7）将请求返回的结果存进缓存</span>
        CacheRequest cacheRequest <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">cacheWritingResponse</span><span class="token punctuation">(</span>cacheRequest<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>HttpMethod<span class="token punctuation">.</span><span class="token function">invalidatesCache</span><span class="token punctuation">(</span>networkRequest<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          cache<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>networkRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">// The cache cannot be written.</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据我标记的关注点大概流程就是：</p>
<ul>
<li>（1）：通过 Request 得到缓存。这里的 cache 是 InternalCache，但是因为 InternalCache 是一个接口，而且只有一个实现类 Cache，所以 cache 其实就是 Cache。进入 Cache 可以发现它底层使用的是 DiskLruCache 缓存机制，也就是使用 “最近最少使用” 算法将数据缓存到磁盘内。</li>
<li>（2）：通过缓存策略获取是使用缓存还是使用网络请求，或者 2 者同时使用或都不使用。networkRequest 为 null 表示不使用网络请求，cacheResponse 为 null 表示不使用缓存。</li>
<li>（3）：如果策略中不使用网络请求，也不使用缓存，那么直接返回失败。这样就直接停止了后面拦截器的执行，结束了整个请求。</li>
<li>（4）：如果策略中不使用网络请求，执行到这里说明是使用缓存的，则直接返回缓存。这样就直接停止了后面拦截器的执行，结束了整个请求。</li>
<li>（5）：执行到这里，说明需要从网络获取数据，则会继续执行下一个拦截器进行网络请求。</li>
<li>（6）：如果策略中使用缓存，并且响应码为 304，则返回缓存，并且更新缓存。</li>
<li>（7）：最后将请求返回的结果进行缓存。</li>
</ul>
<h4 id="2-4-3-4-连接拦截器（ConnectInterceptor）"><a href="#2-4-3-4-连接拦截器（ConnectInterceptor）" class="headerlink" title="2.4.3.4 连接拦截器（ConnectInterceptor）"></a>2.4.3.4 连接拦截器（ConnectInterceptor）</h4><p>该拦截器主要用来打开与目标服务器的连接，然后继续执行下一个拦截器。</p>
<p>我们看看该拦截器中的 intercept() 方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*ConnectInterceptor*/</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> Response <span class="token function">intercept</span><span class="token punctuation">(</span>Chain chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    RealInterceptorChain realChain <span class="token operator">=</span> <span class="token punctuation">(</span>RealInterceptorChain<span class="token punctuation">)</span> chain<span class="token punctuation">;</span>
    Request request <span class="token operator">=</span> realChain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">//（1）获取 StreamAllocation</span>
    StreamAllocation streamAllocation <span class="token operator">=</span> realChain<span class="token punctuation">.</span><span class="token function">streamAllocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// We need the network to satisfy this request. Possibly for validating a conditional GET.</span>
    <span class="token keyword">boolean</span> doExtensiveHealthChecks <span class="token operator">=</span> <span class="token operator">!</span>request<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">//（2）创建 HttpCodec</span>
    HttpCodec httpCodec <span class="token operator">=</span> streamAllocation<span class="token punctuation">.</span><span class="token function">newStream</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> doExtensiveHealthChecks<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">//（3）获取 RealConnection</span>
    RealConnection connection <span class="token operator">=</span> streamAllocation<span class="token punctuation">.</span><span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">//（4）执行下一个拦截器</span>
    <span class="token keyword">return</span> realChain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> streamAllocation<span class="token punctuation">,</span> httpCodec<span class="token punctuation">,</span> connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据我标记的关注点大概流程就是：</p>
<ul>
<li><p>（1）：获取 StreamAllocation，这里获取的其实就是第一个拦截器 RetryAndFollowUpInterceptor 中创建的。</p>
</li>
<li><p>（2）：创建 HttpCodec，是通过 StreamAllocation 的 newStream() 方法获取的，我们看下 newStream() 方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*StreamAllocation*/</span>
  <span class="token keyword">public</span> HttpCodec <span class="token function">newStream</span><span class="token punctuation">(</span>
    OkHttpClient client<span class="token punctuation">,</span> Interceptor<span class="token punctuation">.</span>Chain chain<span class="token punctuation">,</span> <span class="token keyword">boolean</span> doExtensiveHealthChecks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> connectTimeout <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">connectTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> readTimeout <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">readTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> writeTimeout <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">writeTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> pingIntervalMillis <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">pingIntervalMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">boolean</span> connectionRetryEnabled <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">retryOnConnectionFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true">//（5）寻找可用的连接</span>
    RealConnection resultConnection <span class="token operator">=</span> <span class="token function">findHealthyConnection</span><span class="token punctuation">(</span>connectTimeout<span class="token punctuation">,</span> readTimeout<span class="token punctuation">,</span>
        writeTimeout<span class="token punctuation">,</span> pingIntervalMillis<span class="token punctuation">,</span> connectionRetryEnabled<span class="token punctuation">,</span> doExtensiveHealthChecks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//（6）通过这个可用的连接创建 HttpCodec</span>
    HttpCodec resultCodec <span class="token operator">=</span> resultConnection<span class="token punctuation">.</span><span class="token function">newCodec</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>connectionPool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      codec <span class="token operator">=</span> resultCodec<span class="token punctuation">;</span>
      <span class="token keyword">return</span> resultCodec<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RouteException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>我们看下关注点（5）中的 findHealthyConnection() 方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*StreamAllocation*/</span>
  <span class="token keyword">private</span> RealConnection <span class="token function">findHealthyConnection</span><span class="token punctuation">(</span><span class="token keyword">int</span> connectTimeout<span class="token punctuation">,</span> <span class="token keyword">int</span> readTimeout<span class="token punctuation">,</span>
      <span class="token keyword">int</span> writeTimeout<span class="token punctuation">,</span> <span class="token keyword">int</span> pingIntervalMillis<span class="token punctuation">,</span> <span class="token keyword">boolean</span> connectionRetryEnabled<span class="token punctuation">,</span>
      <span class="token keyword">boolean</span> doExtensiveHealthChecks<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment" spellcheck="true">//（7）寻找一个连接</span>
      RealConnection candidate <span class="token operator">=</span> <span class="token function">findConnection</span><span class="token punctuation">(</span>connectTimeout<span class="token punctuation">,</span> readTimeout<span class="token punctuation">,</span> writeTimeout<span class="token punctuation">,</span>
          pingIntervalMillis<span class="token punctuation">,</span> connectionRetryEnabled<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">// 如果这是一个全新的连接，则不需要后面的健康检查，而是在这里直接返回连接</span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>connectionPool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate<span class="token punctuation">.</span>successCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> candidate<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">// 如果不健康，则禁止创建新流，并且继续循环查找可用的链接</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>candidate<span class="token punctuation">.</span><span class="token function">isHealthy</span><span class="token punctuation">(</span>doExtensiveHealthChecks<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">noNewStreams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> candidate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，findHealthyConnection() 方法中又通过 findConnection() 方法去寻找，看下这个方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*StreamAllocation*/</span>
  <span class="token keyword">private</span> RealConnection <span class="token function">findConnection</span><span class="token punctuation">(</span><span class="token keyword">int</span> connectTimeout<span class="token punctuation">,</span> <span class="token keyword">int</span> readTimeout<span class="token punctuation">,</span> <span class="token keyword">int</span> writeTimeout<span class="token punctuation">,</span>
      <span class="token keyword">int</span> pingIntervalMillis<span class="token punctuation">,</span> <span class="token keyword">boolean</span> connectionRetryEnabled<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> foundPooledConnection <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    RealConnection result <span class="token operator">=</span> null<span class="token punctuation">;</span>
    Route selectedRoute <span class="token operator">=</span> null<span class="token punctuation">;</span>
    Connection releasedConnection<span class="token punctuation">;</span>
    Socket toClose<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>connectionPool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>released<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"released"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>codec <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"codec != null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>canceled<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Canceled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">//（8）start</span>
      <span class="token comment" spellcheck="true">// 尝试使用已分配的连接</span>
      releasedConnection <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connection<span class="token punctuation">;</span>
      toClose <span class="token operator">=</span> <span class="token function">releaseIfNoNewStreams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>connection <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">// 已经分配的连接，并且是可用的，则将该已分配的连接赋值为可用的连接</span>
        result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connection<span class="token punctuation">;</span>
        releasedConnection <span class="token operator">=</span> null<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
         <span class="token comment" spellcheck="true">//（8）end</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>reportedAcquired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果这个连接从未标记过已获取，那么请不要标记为为已发布</span>
        releasedConnection <span class="token operator">=</span> null<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">//（9）start 尝试从连接池中获取连接</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Internal<span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>connectionPool<span class="token punctuation">,</span> address<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          foundPooledConnection <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          result <span class="token operator">=</span> connection<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          selectedRoute <span class="token operator">=</span> route<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">closeQuietly</span><span class="token punctuation">(</span>toClose<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>releasedConnection <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      eventListener<span class="token punctuation">.</span><span class="token function">connectionReleased</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> releasedConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>foundPooledConnection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      eventListener<span class="token punctuation">.</span><span class="token function">connectionAcquired</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 如果找到一个可用的连接，那么直接返回</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">boolean</span> newRouteSelection <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedRoute <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>routeSelection <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>routeSelection<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      newRouteSelection <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      routeSelection <span class="token operator">=</span> routeSelector<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>connectionPool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>canceled<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Canceled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">//（10）根据不同的路由再次从连接池中获取可用的连接</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newRouteSelection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        List<span class="token operator">&lt;</span>Route<span class="token operator">></span> routes <span class="token operator">=</span> routeSelection<span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> size <span class="token operator">=</span> routes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Route route <span class="token operator">=</span> routes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
          Internal<span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>connectionPool<span class="token punctuation">,</span> address<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            foundPooledConnection <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> connection<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>route <span class="token operator">=</span> route<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">//（11）还是没有找到可用的连接，那么重新创建一个新的连接</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>foundPooledConnection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedRoute <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          selectedRoute <span class="token operator">=</span> routeSelection<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        route <span class="token operator">=</span> selectedRoute<span class="token punctuation">;</span>
        refusedStreamCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RealConnection</span><span class="token punctuation">(</span>connectionPool<span class="token punctuation">,</span> selectedRoute<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">acquire</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 如果在第二次找到了可用的连接，则直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>foundPooledConnection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      eventListener<span class="token punctuation">.</span><span class="token function">connectionAcquired</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//（12）进行 TCP 和 TLS 握手</span>
    result<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>connectTimeout<span class="token punctuation">,</span> readTimeout<span class="token punctuation">,</span> writeTimeout<span class="token punctuation">,</span> pingIntervalMillis<span class="token punctuation">,</span>
        connectionRetryEnabled<span class="token punctuation">,</span> call<span class="token punctuation">,</span> eventListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">routeDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Socket socket <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>connectionPool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      reportedAcquired <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">//（13）将新创建的连接放进连接池中</span>
      Internal<span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>connectionPool<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">// 如果同时创建了到同一地址的另一个多路复用连接，则释放这个连接并获取那个多路复用连接。</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isMultiplexed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        socket <span class="token operator">=</span> Internal<span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">deduplicate</span><span class="token punctuation">(</span>connectionPool<span class="token punctuation">,</span> address<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> connection<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">closeQuietly</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>

    eventListener<span class="token punctuation">.</span><span class="token function">connectionAcquired</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过上面的代码分析，findConnection() 方法大概流程就是：</p>
<ul>
<li>（8）：判断当前连接是否可用，可用则进行赋值，在后面直接返回</li>
<li>（9）：如果当前连接不可用，那么尝试从连接池中获取可用连接</li>
<li>（10）：如果连接池中找不到可用的连接，那么切换不同的路由再次从连接池中获取可用的连接</li>
<li>（11）：还是没有找到可用的连接，那么只能重新创建一个新的连接</li>
<li>（12）：进行 TCP 和 TLS 握手</li>
<li>（13）：最后将新创建的连接放进连接池中</li>
</ul>
<p>可以看到，关注点（9）（13）分别是从连接池中取出连接和存入连接到连接池，分别调用的是 Internal.instance.get() 与 Internal.instance.put（）。<br>我们看下 get() 方法是怎样的，点击 get() 方法进去，发现 Internal 是一个抽象类，它有一个静态的实例，在 OkHttpClient 的静态代码快中被初始化：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*OkHttpClient*/</span>
  <span class="token keyword">static</span> <span class="token punctuation">{</span>
    Internal<span class="token punctuation">.</span>instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 省略部分代码...</span>

      <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> RealConnection <span class="token function">get</span><span class="token punctuation">(</span>ConnectionPool pool<span class="token punctuation">,</span> Address address<span class="token punctuation">,</span>
          StreamAllocation streamAllocation<span class="token punctuation">,</span> Route route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> streamAllocation<span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

   <span class="token comment" spellcheck="true">// 省略部分代码...</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到 Internal 的 get() 方法中调用的是 ConnectionPool（连接池）的 get() 方法，所以可以肯定这个连接池就是用来操作这些连接的，内部具体怎么操作我们放到后面去讲，这里只需要知道它可以用来存取连接就可以了。</p>
<p>关注点（12）其实就是与服务器建立连接的核心代码，我们看下这个方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RealConnection*/</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> connectTimeout<span class="token punctuation">,</span> <span class="token keyword">int</span> readTimeout<span class="token punctuation">,</span> <span class="token keyword">int</span> writeTimeout<span class="token punctuation">,</span>
      <span class="token keyword">int</span> pingIntervalMillis<span class="token punctuation">,</span> <span class="token keyword">boolean</span> connectionRetryEnabled<span class="token punctuation">,</span> Call call<span class="token punctuation">,</span>
      EventListener eventListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>protocol <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"already connected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/*线路选择*/</span>
    RouteException routeException <span class="token operator">=</span> null<span class="token punctuation">;</span>
    List<span class="token operator">&lt;</span>ConnectionSpec<span class="token operator">></span> connectionSpecs <span class="token operator">=</span> route<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connectionSpecs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ConnectionSpecSelector connectionSpecSelector <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionSpecSelector</span><span class="token punctuation">(</span>connectionSpecs<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sslSocketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connectionSpecs<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>ConnectionSpec<span class="token punctuation">.</span>CLEARTEXT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RouteException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UnknownServiceException</span><span class="token punctuation">(</span>
            <span class="token string">"CLEARTEXT communication not enabled for client"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      String host <span class="token operator">=</span> route<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">host</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Platform<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isCleartextTrafficPermitted</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RouteException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UnknownServiceException</span><span class="token punctuation">(</span>
            <span class="token string">"CLEARTEXT communication to "</span> <span class="token operator">+</span> host <span class="token operator">+</span> <span class="token string">" not permitted by network security policy"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">protocols</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>Protocol<span class="token punctuation">.</span>H2_PRIOR_KNOWLEDGE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RouteException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UnknownServiceException</span><span class="token punctuation">(</span>
            <span class="token string">"H2_PRIOR_KNOWLEDGE cannot be used with HTTPS"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//（14）如果需要隧道连接，则进行隧道连接</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">requiresTunnel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">connectTunnel</span><span class="token punctuation">(</span>connectTimeout<span class="token punctuation">,</span> readTimeout<span class="token punctuation">,</span> writeTimeout<span class="token punctuation">,</span> call<span class="token punctuation">,</span> eventListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>rawSocket <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// We were unable to connect the tunnel but properly closed down our resources.</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">//（15）不需要隧道连接，则直接进行 socket 连接</span>
          <span class="token function">connectSocket</span><span class="token punctuation">(</span>connectTimeout<span class="token punctuation">,</span> readTimeout<span class="token punctuation">,</span> call<span class="token punctuation">,</span> eventListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 建立协议</span>
        <span class="token function">establishProtocol</span><span class="token punctuation">(</span>connectionSpecSelector<span class="token punctuation">,</span> pingIntervalMillis<span class="token punctuation">,</span> call<span class="token punctuation">,</span> eventListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 连接结束</span>
        eventListener<span class="token punctuation">.</span><span class="token function">connectEnd</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> route<span class="token punctuation">.</span><span class="token function">socketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> route<span class="token punctuation">.</span><span class="token function">proxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">closeQuietly</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">closeQuietly</span><span class="token punctuation">(</span>rawSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        socket <span class="token operator">=</span> null<span class="token punctuation">;</span>
        rawSocket <span class="token operator">=</span> null<span class="token punctuation">;</span>
        source <span class="token operator">=</span> null<span class="token punctuation">;</span>
        sink <span class="token operator">=</span> null<span class="token punctuation">;</span>
        handshake <span class="token operator">=</span> null<span class="token punctuation">;</span>
        protocol <span class="token operator">=</span> null<span class="token punctuation">;</span>
        http2Connection <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 连接失败</span>
        eventListener<span class="token punctuation">.</span><span class="token function">connectFailed</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> route<span class="token punctuation">.</span><span class="token function">socketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> route<span class="token punctuation">.</span><span class="token function">proxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>routeException <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          routeException <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RouteException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          routeException<span class="token punctuation">.</span><span class="token function">addConnectException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connectionRetryEnabled <span class="token operator">||</span> <span class="token operator">!</span>connectionSpecSelector<span class="token punctuation">.</span><span class="token function">connectionFailed</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> routeException<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">requiresTunnel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> rawSocket <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ProtocolException exception <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProtocolException</span><span class="token punctuation">(</span><span class="token string">"Too many tunnel connections attempted: "</span>
          <span class="token operator">+</span> MAX_TUNNEL_ATTEMPTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RouteException</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>http2Connection <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>connectionPool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        allocationLimit <span class="token operator">=</span> http2Connection<span class="token punctuation">.</span><span class="token function">maxConcurrentStreams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>关注点（14）（15）最终都会调用 connectSocket() 方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RealConnection*/</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">connectSocket</span><span class="token punctuation">(</span><span class="token keyword">int</span> connectTimeout<span class="token punctuation">,</span> <span class="token keyword">int</span> readTimeout<span class="token punctuation">,</span> Call call<span class="token punctuation">,</span>
      EventListener eventListener<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    Proxy proxy <span class="token operator">=</span> route<span class="token punctuation">.</span><span class="token function">proxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Address address <span class="token operator">=</span> route<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 创建 socket</span>
    rawSocket <span class="token operator">=</span> proxy<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Proxy<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>DIRECT <span class="token operator">||</span> proxy<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Proxy<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>HTTP
        <span class="token operator">?</span> address<span class="token punctuation">.</span><span class="token function">socketFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>

    eventListener<span class="token punctuation">.</span><span class="token function">connectStart</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> route<span class="token punctuation">.</span><span class="token function">socketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 设置 socket 超时时间</span>
    rawSocket<span class="token punctuation">.</span><span class="token function">setSoTimeout</span><span class="token punctuation">(</span>readTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//（16）进行 socket 连接</span>
      Platform<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connectSocket</span><span class="token punctuation">(</span>rawSocket<span class="token punctuation">,</span> route<span class="token punctuation">.</span><span class="token function">socketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> connectTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ConnectException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ConnectException ce <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectException</span><span class="token punctuation">(</span><span class="token string">"Failed to connect to "</span> <span class="token operator">+</span> route<span class="token punctuation">.</span><span class="token function">socketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ce<span class="token punctuation">.</span><span class="token function">initCause</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> ce<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      source <span class="token operator">=</span> Okio<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span>Okio<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>rawSocket<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      sink <span class="token operator">=</span> Okio<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span>Okio<span class="token punctuation">.</span><span class="token function">sink</span><span class="token punctuation">(</span>rawSocket<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NullPointerException</span> npe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>NPE_THROW_WITH_NULL<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>npe<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span>npe<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到 okhttp 底层是通过 socket 进行连接的。</p>
<p>看完关注点（5）中的 findHealthyConnection() 方法，我们继续回去看关注点（6）的方法：</p>
<pre class="line-numbers language-java"><code class="language-java">   <span class="token comment" spellcheck="true">/*StreamAllocation*/</span>
   <span class="token keyword">public</span> HttpCodec <span class="token function">newCodec</span><span class="token punctuation">(</span>OkHttpClient client<span class="token punctuation">,</span> Interceptor<span class="token punctuation">.</span>Chain chain<span class="token punctuation">,</span>
      StreamAllocation streamAllocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> SocketException <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>http2Connection <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Http2Codec</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> streamAllocation<span class="token punctuation">,</span> http2Connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      socket<span class="token punctuation">.</span><span class="token function">setSoTimeout</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">readTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      source<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">readTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      sink<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">writeTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Http1Codec</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> streamAllocation<span class="token punctuation">,</span> source<span class="token punctuation">,</span> sink<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该方法是创建 HttpCodec，HttpCodec 的作用主要是进行 HTTP 请求和响应的编码与解码操作。它有两个实现类，分别是 Http1Codec 与 Http2Codec，这里主要判断如果是 HTTP/2，则创建 Http2Codec，否则创建 Http1Codec。</p>
<ul>
<li><p>（3）：继续回去看关注点（3），点击 connection() 方法进去发现，这里获取的 RealConnection 其实就是关注点（7） findConnection()<br>方法中从连接池中取出连接或重新创建的连接。</p>
</li>
<li><p>（4）：关注点（4）则拿到连接后继续执行下一个拦截器。</p>
</li>
</ul>
<h4 id="2-4-3-5-服务器请求拦截器（CallServerInterceptor）"><a href="#2-4-3-5-服务器请求拦截器（CallServerInterceptor）" class="headerlink" title="2.4.3.5 服务器请求拦截器（CallServerInterceptor）"></a>2.4.3.5 服务器请求拦截器（CallServerInterceptor）</h4><p>该拦截器主要用来向服务器发起请求并获取数据，它是责任链中的最后一个拦截器，获取到服务器的数据后会直接返回给上一个拦截器。</p>
<p>我们看看该拦截器中的 intercept() 方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*CallServerInterceptor*/</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> Response <span class="token function">intercept</span><span class="token punctuation">(</span>Chain chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    RealInterceptorChain realChain <span class="token operator">=</span> <span class="token punctuation">(</span>RealInterceptorChain<span class="token punctuation">)</span> chain<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 获取 ConnectInterceptor 中创建的 HttpCodec</span>
    HttpCodec httpCodec <span class="token operator">=</span> realChain<span class="token punctuation">.</span><span class="token function">httpStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 获取 RetryAndFollowUpInterceptor 中创建的 StreamAllocation</span>
    StreamAllocation streamAllocation <span class="token operator">=</span> realChain<span class="token punctuation">.</span><span class="token function">streamAllocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 获取 ConnectInterceptor 中新创建或者从连接池中拿到的 RealConnection</span>
    RealConnection connection <span class="token operator">=</span> <span class="token punctuation">(</span>RealConnection<span class="token punctuation">)</span> realChain<span class="token punctuation">.</span><span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Request request <span class="token operator">=</span> realChain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">long</span> sentRequestMillis <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    realChain<span class="token punctuation">.</span><span class="token function">eventListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requestHeadersStart</span><span class="token punctuation">(</span>realChain<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//（1）写入请求头</span>
    httpCodec<span class="token punctuation">.</span><span class="token function">writeRequestHeaders</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    realChain<span class="token punctuation">.</span><span class="token function">eventListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requestHeadersEnd</span><span class="token punctuation">(</span>realChain<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Response<span class="token punctuation">.</span>Builder responseBuilder <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>HttpMethod<span class="token punctuation">.</span><span class="token function">permitsRequestBody</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> request<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// If there's a "Expect: 100-continue" header on the request, wait for a "HTTP/1.1 100</span>
      <span class="token comment" spellcheck="true">// Continue" response before transmitting the request body. If we don't get that, return</span>
      <span class="token comment" spellcheck="true">// what we did get (such as a 4xx response) without ever transmitting the request body.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"100-continue"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Expect"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        httpCodec<span class="token punctuation">.</span><span class="token function">flushRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        realChain<span class="token punctuation">.</span><span class="token function">eventListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">responseHeadersStart</span><span class="token punctuation">(</span>realChain<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        responseBuilder <span class="token operator">=</span> httpCodec<span class="token punctuation">.</span><span class="token function">readResponseHeaders</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">//（2）写入请求体</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>responseBuilder <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Write the request body if the "Expect: 100-continue" expectation was met.</span>
        realChain<span class="token punctuation">.</span><span class="token function">eventListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requestBodyStart</span><span class="token punctuation">(</span>realChain<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> contentLength <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        CountingSink requestBodyOut <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">CountingSink</span><span class="token punctuation">(</span>httpCodec<span class="token punctuation">.</span><span class="token function">createRequestBody</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> contentLength<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        BufferedSink bufferedRequestBody <span class="token operator">=</span> Okio<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span>requestBodyOut<span class="token punctuation">)</span><span class="token punctuation">;</span>

        request<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeTo</span><span class="token punctuation">(</span>bufferedRequestBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bufferedRequestBody<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        realChain<span class="token punctuation">.</span><span class="token function">eventListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">requestBodyEnd</span><span class="token punctuation">(</span>realChain<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestBodyOut<span class="token punctuation">.</span>successfulCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connection<span class="token punctuation">.</span><span class="token function">isMultiplexed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// If the "Expect: 100-continue" expectation wasn't met, prevent the HTTP/1 connection</span>
        <span class="token comment" spellcheck="true">// from being reused. Otherwise we're still obligated to transmit the request body to</span>
        <span class="token comment" spellcheck="true">// leave the connection in a consistent state.</span>
        streamAllocation<span class="token punctuation">.</span><span class="token function">noNewStreams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    httpCodec<span class="token punctuation">.</span><span class="token function">finishRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>responseBuilder <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      realChain<span class="token punctuation">.</span><span class="token function">eventListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">responseHeadersStart</span><span class="token punctuation">(</span>realChain<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//（3）读取响应头</span>
      responseBuilder <span class="token operator">=</span> httpCodec<span class="token punctuation">.</span><span class="token function">readResponseHeaders</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Response response <span class="token operator">=</span> responseBuilder
        <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span>streamAllocation<span class="token punctuation">.</span><span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">sentRequestAtMillis</span><span class="token punctuation">(</span>sentRequestMillis<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">receivedResponseAtMillis</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> code <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// server sent a 100-continue even though we did not request one.</span>
      <span class="token comment" spellcheck="true">// try again to read the actual response</span>
      responseBuilder <span class="token operator">=</span> httpCodec<span class="token punctuation">.</span><span class="token function">readResponseHeaders</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      response <span class="token operator">=</span> responseBuilder
              <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span>streamAllocation<span class="token punctuation">.</span><span class="token function">connection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">sentRequestAtMillis</span><span class="token punctuation">(</span>sentRequestMillis<span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">receivedResponseAtMillis</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      code <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    realChain<span class="token punctuation">.</span><span class="token function">eventListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">responseHeadersEnd</span><span class="token punctuation">(</span>realChain<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//（4）读取响应体</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>forWebSocket <span class="token operator">&amp;&amp;</span> code <span class="token operator">==</span> <span class="token number">101</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// Connection is upgrading, but we need to ensure interceptors see a non-null response body.</span>
      response <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>Util<span class="token punctuation">.</span>EMPTY_RESPONSE<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      response <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>httpCodec<span class="token punctuation">.</span><span class="token function">openResponseBody</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"close"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Connection"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">||</span> <span class="token string">"close"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Connection"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      streamAllocation<span class="token punctuation">.</span><span class="token function">noNewStreams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>code <span class="token operator">==</span> <span class="token number">204</span> <span class="token operator">||</span> code <span class="token operator">==</span> <span class="token number">205</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ProtocolException</span><span class="token punctuation">(</span>
          <span class="token string">"HTTP "</span> <span class="token operator">+</span> code <span class="token operator">+</span> <span class="token string">" had non-zero Content-Length: "</span> <span class="token operator">+</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，这个拦截器还是比较简单的，上一个拦截器 ConnectInterceptor 已经连接到服务器了并创建了 HttpCodec 对象，HttpCodec 对象封装了 okio 提供的输出流（BufferedSink）与输入流（BufferedSource），所以这里就主要通过 HttpCodec 对象与服务器进行读写操作。例如写入请求头与请求体，读取响应头与响应体。</p>
<h3 id="2-4-4-ConnectionPool（连接池）"><a href="#2-4-4-ConnectionPool（连接池）" class="headerlink" title="2.4.4 ConnectionPool（连接池）"></a>2.4.4 ConnectionPool（连接池）</h3><ul>
<li><p>简介<br>连接池是用来管理 HTTP 和 HTTP / 2 连接的复用，以减少网络延迟。从上面我们阅读 findConnection() 方法源码也可以得出，即如果从连接池中找到了可用的连接，那么就不用重新创建新的连接，也省去了 TCP 和 TLS 握手。</p>
</li>
<li><p>ConnectionPool 类中的主要常量</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*ConnectionPool*/</span>
<span class="token comment" spellcheck="true">// 线程池，用于清除过期的连接</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Executor executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token comment" spellcheck="true">/* corePoolSize */</span><span class="token punctuation">,</span>
    Integer<span class="token punctuation">.</span>MAX_VALUE <span class="token comment" spellcheck="true">/* maximumPoolSize */</span><span class="token punctuation">,</span> 60L <span class="token comment" spellcheck="true">/* keepAliveTime */</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token operator">&lt;</span>Runnable<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Util<span class="token punctuation">.</span><span class="token function">threadFactory</span><span class="token punctuation">(</span><span class="token string">"OkHttp ConnectionPool"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 最大允许空闲的连接数量</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> maxIdleConnections<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 连接的存活时间</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> keepAliveDurationNs<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 清理任务，用来清理无效的连接</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> Runnable cleanupRunnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 用来记录连接的双端队列</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> Deque<span class="token operator">&lt;</span>RealConnection<span class="token operator">></span> connections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>构造函数</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*ConnectionPool*/</span>
<span class="token keyword">public</span> <span class="token function">ConnectionPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token function">ConnectionPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxIdleConnections<span class="token punctuation">,</span> <span class="token keyword">long</span> keepAliveDuration<span class="token punctuation">,</span> TimeUnit timeUnit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>maxIdleConnections <span class="token operator">=</span> maxIdleConnections<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>keepAliveDurationNs <span class="token operator">=</span> timeUnit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>keepAliveDuration<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Put a floor on the keep alive duration, otherwise cleanup will spin loop.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>keepAliveDuration <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"keepAliveDuration &lt;= 0: "</span> <span class="token operator">+</span> keepAliveDuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>可以看到构造函数设置了默认的最大允许空闲的连接数量为 5 个，连接的存活时间为 5 分钟。</p>
<ul>
<li>主要函数<br>这里主要讲下前面连接拦截器中用到的 get()、put() 方法。</li>
</ul>
<p>get() 方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*ConnectionPool*/</span>
  <span class="token annotation punctuation">@Nullable</span> RealConnection <span class="token function">get</span><span class="token punctuation">(</span>Address address<span class="token punctuation">,</span> StreamAllocation streamAllocation<span class="token punctuation">,</span> Route route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span> <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">holdsLock</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>RealConnection connection <span class="token operator">:</span> connections<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">isEligible</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> route<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        streamAllocation<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> connection<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该方法是从连接池中获取可复用的连接，这里的逻辑是遍历记录连接的双端队列，取出可复用的连接。</p>
<p>put() 方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*ConnectionPool*/</span>
  <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span>RealConnection connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span> <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">holdsLock</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cleanupRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cleanupRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// 执行清理任务</span>
      executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>cleanupRunnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 将新创建的连接添加进记录连接的双端队列中</span>
    connections<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该方法是将新创建的连接放进连接池中，这里的逻辑是先清理无效的连接，然后再将新创建的连接添加进记录连接的双端队列中。</p>
<p>我们先看下清理任务：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*ConnectionPool*/</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Runnable cleanupRunnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 清理无效连接</span>
        <span class="token keyword">long</span> waitNanos <span class="token operator">=</span> <span class="token function">cleanup</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>waitNanos <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>waitNanos <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">long</span> waitMillis <span class="token operator">=</span> waitNanos <span class="token operator">/</span> 1000000L<span class="token punctuation">;</span>
          waitNanos <span class="token operator">-=</span> <span class="token punctuation">(</span>waitMillis <span class="token operator">*</span> 1000000L<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>ConnectionPool<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              ConnectionPool<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>waitMillis<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> waitNanos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是一个阻塞的清理任务，并且通过无限循环来清理。这里首先调用 cleanup() 方法清理无效连接，并返回下次需要清理的间隔时间，然后调用 wait() 方法进行等待以释放锁与时间片，当等待时间到了后，再次循环清理。</p>
<p>我们看下 cleanup() 方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*ConnectionPool*/</span>
  <span class="token keyword">long</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> inUseConnectionCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> idleConnectionCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    RealConnection longestIdleConnection <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">long</span> longestIdleDurationNs <span class="token operator">=</span> Long<span class="token punctuation">.</span>MIN_VALUE<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 遍历连接，找出无效连接进行清理</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>Iterator<span class="token operator">&lt;</span>RealConnection<span class="token operator">></span> i <span class="token operator">=</span> connections<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        RealConnection connection <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//（1）查询此连接的 StreamAllocation 的引用数量，大于 0 则 inUseConnectionCount 加 1，否则 idleConnectionCount 加 1。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pruneAndGetAllocationCount</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> now<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          inUseConnectionCount<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        idleConnectionCount<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 标记空闲连接</span>
        <span class="token keyword">long</span> idleDurationNs <span class="token operator">=</span> now <span class="token operator">-</span> connection<span class="token punctuation">.</span>idleAtNanos<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>idleDurationNs <span class="token operator">></span> longestIdleDurationNs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          longestIdleDurationNs <span class="token operator">=</span> idleDurationNs<span class="token punctuation">;</span>
          longestIdleConnection <span class="token operator">=</span> connection<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>longestIdleDurationNs <span class="token operator">>=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>keepAliveDurationNs
          <span class="token operator">||</span> idleConnectionCount <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxIdleConnections<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果连接存活时间大于等于 5 分钟，或者空闲的连接数量大于 5 个，则将该链接从队列中移除</span>
        connections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>longestIdleConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>idleConnectionCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果空闲的连接数量大于 0，返回此连接即将到期的时间</span>
        <span class="token keyword">return</span> keepAliveDurationNs <span class="token operator">-</span> longestIdleDurationNs<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>inUseConnectionCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果没有空闲连接，则返回 5 分钟，也就是下次需要清理的间隔时间为 5 分钟</span>
        <span class="token keyword">return</span> keepAliveDurationNs<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 没有任何连接，则跳出循环</span>
        cleanupRunning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">closeQuietly</span><span class="token punctuation">(</span>longestIdleConnection<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 马上进行下一次清理</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，这里主要通过判断连接存活时间是否大于等于 5 分钟，或者空闲的连接数量是否大于 5 个来进行连接的清理。连接是否空闲是通过关注点（1）中的 pruneAndGetAllocationCount() 方法来判断的，我们看下这个方法：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*ConnectionPool*/</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">pruneAndGetAllocationCount</span><span class="token punctuation">(</span>RealConnection connection<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 获得 allocations 的弱引用列表</span>
    List<span class="token operator">&lt;</span>Reference<span class="token operator">&lt;</span>StreamAllocation<span class="token operator">>></span> references <span class="token operator">=</span> connection<span class="token punctuation">.</span>allocations<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 遍历 allocations 的弱引用列表</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> references<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Reference<span class="token operator">&lt;</span>StreamAllocation<span class="token operator">></span> reference <span class="token operator">=</span> references<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">// 说明 StreamAllocation 被使用，则继续下一次循环</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>reference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">// We've discovered a leaked allocation. This is an application bug.</span>
      StreamAllocation<span class="token punctuation">.</span>StreamAllocationReference streamAllocRef <span class="token operator">=</span>
          <span class="token punctuation">(</span>StreamAllocation<span class="token punctuation">.</span>StreamAllocationReference<span class="token punctuation">)</span> reference<span class="token punctuation">;</span>
      String message <span class="token operator">=</span> <span class="token string">"A connection to "</span> <span class="token operator">+</span> connection<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">+</span> <span class="token string">" was leaked. Did you forget to close a response body?"</span><span class="token punctuation">;</span>
      Platform<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logCloseableLeak</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> streamAllocRef<span class="token punctuation">.</span>callStackTrace<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">// 说明 StreamAllocation 没有被使用，则从列表中移除</span>
      references<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      connection<span class="token punctuation">.</span>noNewStreams <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">// 列表为空，说明都被移除了，这个时候返回 allocationCount 为 0，表示该连接是空闲的。</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>references<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        connection<span class="token punctuation">.</span>idleAtNanos <span class="token operator">=</span> now <span class="token operator">-</span> keepAliveDurationNs<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 列表不为空，返回列表的大小，大于 0 表示该连接是在使用的。</span>
    <span class="token keyword">return</span> references<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该方法比较简单，主要是遍历 allocations 的弱引用列表，如果 StreamAllocation 没有被使用，则从列表中移除，最后返回该列表的大小，通过该大小即可判断是否是空闲连接，小于等于 0 才是空闲连接。</p>
<h2 id="2-5-（5）取出相应的数据"><a href="#2-5-（5）取出相应的数据" class="headerlink" title="2.5 （5）取出相应的数据"></a>2.5 （5）取出相应的数据</h2><pre class="line-numbers language-java"><code class="language-java">String data <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在第（4）步同步请求或者异步请求执行完都会返回 Response，这个就是最终返回的数据，可以通过它获取到 code、message、header、body 等。</p>
<p>这里讲下 body，点击 body() 进去是这样的：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*Response*/</span>
  <span class="token keyword">public</span> <span class="token annotation punctuation">@Nullable</span> ResponseBody <span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> body<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到这里的 body 就是 ResponseBody，它是一个抽象类，不能被实例化，一般用它的子类 RealResponseBody 进行实例化。它是在前面讲的 “2.4.3.5 服务器请求拦截器（CallServerInterceptor）” 小节中赋值的：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/*CallServerInterceptor*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>forWebSocket <span class="token operator">&amp;&amp;</span> code <span class="token operator">==</span> <span class="token number">101</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>Util<span class="token punctuation">.</span>EMPTY_RESPONSE<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// openResponseBody() 方法中创建了 RealResponseBody 对象返回</span>
      response <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span>httpCodec<span class="token punctuation">.</span><span class="token function">openResponseBody</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果有缓存则会在缓存拦截器（CacheInterceptor）中赋值。</p>
<p>ResponseBody 中常用的方法有如下几种：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*ResponseBody*/</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> String <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    BufferedSource source <span class="token operator">=</span> <span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      Charset charset <span class="token operator">=</span> Util<span class="token punctuation">.</span><span class="token function">bomAwareCharset</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token function">charset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> source<span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span>charset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      Util<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">final</span> InputStream <span class="token function">byteStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token keyword">long</span> contentLength <span class="token operator">=</span> <span class="token function">contentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>contentLength <span class="token operator">></span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Cannot buffer entire body for content length: "</span> <span class="token operator">+</span> contentLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    BufferedSource source <span class="token operator">=</span> <span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      bytes <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">readByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      Util<span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>contentLength <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> contentLength <span class="token operator">!=</span> bytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Content-Length ("</span>
          <span class="token operator">+</span> contentLength
          <span class="token operator">+</span> <span class="token string">") and stream length ("</span>
          <span class="token operator">+</span> bytes<span class="token punctuation">.</span>length
          <span class="token operator">+</span> <span class="token string">") disagree"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bytes<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，这三个方法内部都调用了 source() 来获取 BufferedSource，BufferedSource 就是 okio 提供的输入流，拿到输入流就可以将 body 数据转换为你需要的类型。例如：<br>希望返回 String，则调用 response.body().string()，适用于不超过 1 MB 的数据。<br>希望返回输入流，则调用 response.body().byteStream()，适用于超过 1 MB 的数据，例如下载文件。<br>希望返回二进制字节数组，则调用 response.body().bytes()。</p>
<p>需要注意的是，response.body().string() 只能调用一次，否则会抛出如下异常：</p>
<pre class="line-numbers language-java"><code class="language-java">W<span class="token operator">/</span>System<span class="token punctuation">.</span>err<span class="token operator">:</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>IllegalStateException<span class="token operator">:</span> closed
W<span class="token operator">/</span>System<span class="token punctuation">.</span>err<span class="token operator">:</span>     at okio<span class="token punctuation">.</span>RealBufferedSource<span class="token punctuation">.</span><span class="token function">rangeEquals</span><span class="token punctuation">(</span>RealBufferedSource<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">408</span><span class="token punctuation">)</span>
W<span class="token operator">/</span>System<span class="token punctuation">.</span>err<span class="token operator">:</span>     at okio<span class="token punctuation">.</span>RealBufferedSource<span class="token punctuation">.</span><span class="token function">rangeEquals</span><span class="token punctuation">(</span>RealBufferedSource<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">402</span><span class="token punctuation">)</span>
W<span class="token operator">/</span>System<span class="token punctuation">.</span>err<span class="token operator">:</span>     at okhttp3<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>Util<span class="token punctuation">.</span><span class="token function">bomAwareCharset</span><span class="token punctuation">(</span>Util<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">469</span><span class="token punctuation">)</span>
W<span class="token operator">/</span>System<span class="token punctuation">.</span>err<span class="token operator">:</span>     at okhttp3<span class="token punctuation">.</span>ResponseBody<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span>ResponseBody<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">175</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据报错日志可以看到，是在 RealBufferedSource 类的 408 行报的错，我们跳转过去看看：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RealBufferedSource*/</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">rangeEquals</span><span class="token punctuation">(</span><span class="token keyword">long</span> offset<span class="token punctuation">,</span> ByteString bytes<span class="token punctuation">,</span> <span class="token keyword">int</span> bytesOffset<span class="token punctuation">,</span> <span class="token keyword">int</span> byteCount<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"closed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//...</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，这里做了个判断，closed 为 true 就抛出该异常，继续跟踪 closed 赋值的地方：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*RealBufferedSource*/</span>
  <span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    closed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    source<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，closed 唯一赋值的地方在 close() 方法中，而该方法正是 string() 方法中的 Util.closeQuietly(source); 调用的：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token comment" spellcheck="true">/*ResponseBody*/</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">closeQuietly</span><span class="token punctuation">(</span>Closeable closeable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>closeable <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        closeable<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> rethrown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> rethrown<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>到这里我们就明白了为什么 response.body().string() 只能调用一次的原因，即 string() 方法中获取到 String后又调用了 Util.closeQuietly(source) 方法关闭了输入流，并且标记 closed 为 true，然后第二次调用 string() 方法的时候会在 RealBufferedSource.rangeEquals() 方法进行判断，为 true 就抛出异常。</p>
<p>这样设计的原因是服务器返回的 body 可能会很大，所以 OkHttp 不会将其存储在内存中，只有当你需要的时候才去获取它，如果没有新的请求则无法获取 2 次。</p>
<h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><p>看完源码，发现  OkHttp 是一个设计得非常优秀的框架。该框架运用了很多设计模式，例如建造者模式、责任链模式等等。知道了 OkHttp 的核心是拦截器，这里采用的就是责任链模式，每个拦截器负责相应的功能，发起请求的时候由上往下依次执行每个拦截器，响应的数据则层层往上传递。</p>
<p>参考资料：</p>
<ul>
<li><a href="https://blog.piasy.com/2016/07/11/Understand-OkHttp/index.html" target="_blank" rel="noopener">拆轮子系列：拆 OkHttp</a></li>
<li><a href="https://juejin.im/post/5a704ed05188255a8817f4c9" target="_blank" rel="noopener">Android开源框架源码鉴赏：Okhttp</a></li>
</ul>

            </div>
            <hr />

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《Android 主流开源框架（三）OkHttp 源码解析》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/blog/d8540f1f.html" property="cc:attributionName"
               rel="cc:attributionURL">
                wildma
            </a> 采用
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    
    <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '9e627d72c12c6434d27d',
        clientSecret: '334ca6c96cf471a12c6f343b50c23eccb5e94c05',
        repo: 'wildma.github.io',
        owner: 'wildma',
        admin: "wildma",
        id: 'blog/d8540f1f.html',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    
    <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script> -->

<script>
    new Valine({
        el: '#vcomments',
        appId: '',
        appKey: '',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'false' === 'true',
        avatar: 'wavatar',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '如果你没有GitHub账号，还可以在这里评论啦！'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/blog/df2af467.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="Android 主流开源框架（四）Retrofit 使用详解">
                        
                        <span class="card-title">Android 主流开源框架（四）Retrofit 使用详解</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言最近有个想法——就是把 Android 主流开源框架进行深入分析，然后写成一系列文章，包括该框架的详细使用与源码解析。目的是通过鉴赏大神的源码来了解框架底层的原理，也就是做到不仅要知其然，还要知其所以然。
这里我说下自己阅读源码的经验，
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-10-24
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android/" class="post-category" target="_blank">
                                    Android
                                </a>
                            
                            <a href="/categories/Android/网络编程/" class="post-category" target="_blank">
                                    网络编程
                                </a>
                            
                            <a href="/categories/Android/网络编程/Android主流开源框架/" class="post-category" target="_blank">
                                    Android主流开源框架
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/网络编程/" target="_blank">
                        <span class="chip bg-color">网络编程</span>
                    </a>
                    
                    <a href="/tags/Retrofit/" target="_blank">
                        <span class="chip bg-color">Retrofit</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/blog/6d0008b.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="Android 主流开源框架（二）OkHttp 使用详解">
                        
                        <span class="card-title">Android 主流开源框架（二）OkHttp 使用详解</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言最近有个想法——就是把 Android 主流开源框架进行深入分析，然后写成一系列文章，包括该框架的详细使用与源码解析。目的是通过鉴赏大神的源码来了解框架底层的原理，也就是做到不仅要知其然，还要知其所以然。
这里我说下自己阅读源码的经验，
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-08-17
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android/" class="post-category" target="_blank">
                                    Android
                                </a>
                            
                            <a href="/categories/Android/网络编程/" class="post-category" target="_blank">
                                    网络编程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/OkHttp/" target="_blank">
                        <span class="chip bg-color">OkHttp</span>
                    </a>
                    
                    <a href="/tags/网络编程/" target="_blank">
                        <span class="chip bg-color">网络编程</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: wildma的博客<br />'
            + '作者: wildma<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; 2019 wildma. All Rights Reserved.

            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">75.5k</span>
            
            
            
            <br>
            
            <span id="busuanzi_container_site_pv" style='display:none'>
                <i class="fa fa-heart-o"></i>
                本站访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
            <span id="busuanzi_container_site_uv" style='display:none'>
                次
            </span>
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/wildma" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:wildma.me@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>









    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 16666;
        var uvcountOffset = 20000;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2019, 09, 29, 00, 00, 00); //北京时间2019-9-29 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>



    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', '');
</script>



    
    <script src="/libs/others/clicklove.js"></script>
    

    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 雪花特效 -->
    

</body>

</html>